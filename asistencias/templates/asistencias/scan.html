{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Escanear Asistencia</title>

  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#0b1020; color:#fff; }
    .wrap { max-width: 900px; margin: 0 auto; padding: 16px; }
    .top { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .title { font-size: 22px; font-weight: 700; margin: 8px 0 16px; }
    #video { width: 100%; border-radius: 16px; background:#000; min-height: 220px; }
    .status {
      margin-top: 12px; padding: 14px; border-radius: 12px;
      background: rgba(255,255,255,0.08);
      font-size: 18px; font-weight: 700;
    }
    .ok { background: rgba(34,197,94,0.18); border: 1px solid rgba(34,197,94,0.35); }
    .bad { background: rgba(239,68,68,0.18); border: 1px solid rgba(239,68,68,0.35); }
    .hint { opacity: .8; margin-top: 10px; font-size: 14px; line-height: 1.35; }
    .btn {
      padding: 10px 14px; border-radius: 10px; border:0; cursor:pointer;
      font-weight: 800; font-size: 15px;
    }
    .btn-primary { background:#2563eb; color:#fff; }
    .btn-danger { background:#b91c1c; color:#fff; }
    .btn-primary:disabled { opacity:.6; cursor:not-allowed; }
  </style>

  <!-- ‚úÖ ZXing local (YA NO CDN) -->
  <script src="{% static 'asistencias/js/zxing-browser.min.js' %}"></script>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="title">üì∑ Escaneo de Asistencia (DNI)</div>
      <div style="display:flex; gap:10px;">
        <button id="btnStart" class="btn btn-primary">Activar c√°mara</button>
        <button id="btnStop" class="btn btn-danger" disabled>Detener</button>
      </div>
    </div>

    <video id="video" autoplay playsinline></video>

    <div id="status" class="status">Toca ‚ÄúActivar c√°mara‚Äù para comenzar‚Ä¶</div>

    <div class="hint">
      ‚úÖ Requisito: abrir esta p√°gina en <b>HTTPS</b> (Render) o en <b>localhost</b> en la misma m√°quina.<br>
      En celular entra por <b>https://TU-APP.onrender.com/asistencia/scan/</b> (no 127.0.0.1).<br>
      Si tu c√≥digo es barras (1D), usa buena luz y acerca el celular.
    </div>
  </div>

  <script>
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    const csrftoken = getCookie('csrftoken');

    const statusEl = document.getElementById("status");
    const videoEl = document.getElementById("video");
    const btnStart = document.getElementById("btnStart");
    const btnStop  = document.getElementById("btnStop");

    let lastDni = null;
    let lastTs = 0;
    let busy = false;
    let codeReader = null;
    let stream = null;

    function setStatus(msg, ok=null) {
      statusEl.textContent = msg;
      statusEl.className = "status" + (ok === true ? " ok" : ok === false ? " bad" : "");
    }

    function normalizeDni(text) {
      const digits = (text || "").replace(/\D/g, "");
      if (digits.length >= 8) return digits.slice(-8);
      return digits;
    }

    async function registrarDni(dni) {
      if (busy) return;
      busy = true;

      try {
        const res = await fetch("{% url 'api_scan_asistencia' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
          },
          body: JSON.stringify({ code: dni })
        });

        const data = await res.json().catch(() => ({ ok:false, msg:"Respuesta inv√°lida" }));

        if (res.ok && data.ok) setStatus(data.msg, true);
        else setStatus(data.msg || "No se pudo registrar.", false);

      } catch (e) {
        setStatus("Error de red.", false);
      } finally {
        setTimeout(() => {
          busy = false;
          setStatus("Listo. Escanea el siguiente c√≥digo‚Ä¶", null);
        }, 1200);
      }
    }

    async function startScanner() {
      if (!window.isSecureContext) {
        setStatus("‚ùå La c√°mara requiere HTTPS (o localhost).", false);
        return;
      }

      btnStart.disabled = true;

      try {
        // 1) pedir c√°mara y guardar stream para poder detenerla luego
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        videoEl.srcObject = stream;

        // 2) iniciar ZXing
        codeReader = new ZXingBrowser.BrowserMultiFormatReader();

        const devices = await ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
        const backCam = devices.find(d => /back|rear|environment/i.test(d.label)) || devices[0];
        const deviceId = backCam ? backCam.deviceId : undefined;

        btnStop.disabled = false;
        setStatus("‚úÖ C√°mara lista. Escanea el c√≥digo‚Ä¶");

        await codeReader.decodeFromVideoDevice(deviceId, videoEl, (result) => {
          if (!result) return;

          const raw = result.getText();
          const dni = normalizeDni(raw);
          const now = Date.now();

          if (dni && dni.length === 8 && (dni !== lastDni || (now - lastTs) > 2000)) {
            lastDni = dni;
            lastTs = now;
            registrarDni(dni);
          }
        });

      } catch (e) {
        const name = e?.name || "Error";
        const msg  = e?.message || "Sin detalle";

        if (name === "NotAllowedError") {
          setStatus("‚ùå Permiso denegado. Activa la c√°mara en permisos del navegador.", false);
        } else if (name === "NotFoundError") {
          setStatus("‚ùå No se encontr√≥ c√°mara.", false);
        } else if (name === "NotReadableError") {
          setStatus("‚ùå La c√°mara est√° ocupada por otra app/pesta√±a. Cierra Zoom/Teams/WhatsApp/OMEN y reintenta.", false);
        } else {
          setStatus(`‚ùå No se pudo abrir la c√°mara (${name}): ${msg}`, false);
        }

        btnStart.disabled = false;
      }
    }

    function stopScanner() {
      try { codeReader?.reset(); } catch(e) {}
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      videoEl.srcObject = null;

      btnStart.disabled = false;
      btnStop.disabled = true;
      setStatus("C√°mara detenida. Toca ‚ÄúActivar c√°mara‚Äù para comenzar‚Ä¶", null);
    }

    btnStart.addEventListener("click", startScanner);
    btnStop.addEventListener("click", stopScanner);
  </script>
</body>
</html>



