{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Escanear Asistencia</title>

  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#0b1020; color:#fff; }
    .wrap { max-width: 900px; margin: 0 auto; padding: 16px; }
    .top { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .title { font-size: 22px; font-weight: 800; margin: 8px 0 10px; }
    #video { width: 100%; border-radius: 16px; background:#000; min-height: 260px; object-fit: cover; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin: 8px 0; }
    select {
      padding: 10px 12px; border-radius: 10px; border:1px solid rgba(255,255,255,.15);
      background: rgba(255,255,255,.06); color:#fff; outline:none;
      min-width: 260px;
    }
    option { color:#000; }
    .status {
      margin-top: 12px; padding: 14px; border-radius: 12px;
      background: rgba(255,255,255,0.08);
      font-size: 16px; font-weight: 800;
    }
    .ok { background: rgba(34,197,94,0.18); border: 1px solid rgba(34,197,94,0.35); }
    .bad { background: rgba(239,68,68,0.18); border: 1px solid rgba(239,68,68,0.35); }
    .hint { opacity: .85; margin-top: 10px; font-size: 14px; line-height: 1.35; }
    .btn {
      padding: 10px 14px; border-radius: 10px; border:0; cursor:pointer;
      font-weight: 900; font-size: 15px;
    }
    .btn-primary { background:#2563eb; color:#fff; }
    .btn-danger { background:#b91c1c; color:#fff; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
  </style>

  <script src="https://unpkg.com/@zxing/browser@0.1.5/umd/index.min.js"></script>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="title">üì∑ Escaneo de Asistencia (DNI)</div>
      <div class="row">
        <select id="cameraSelect"></select>
        <button id="btnStart" class="btn btn-primary">Activar c√°mara</button>
        <button id="btnStop" class="btn btn-danger" disabled>Detener</button>
      </div>
    </div>

    <video id="video" autoplay playsinline muted></video>

    <div id="status" class="status">Elige c√°mara y pulsa ‚ÄúActivar c√°mara‚Äù‚Ä¶</div>

    <div class="hint">
      ‚úÖ Tip: evita c√°maras ‚ÄúIR / Windows Hello / Virtual‚Äù.<br>
      Si tu lector es de barras (1D), usa buena luz y acerca el c√≥digo.
    </div>
  </div>

  <script>
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    const csrftoken = getCookie('csrftoken');

    const statusEl = document.getElementById("status");
    const videoEl = document.getElementById("video");
    const btnStart = document.getElementById("btnStart");
    const btnStop  = document.getElementById("btnStop");
    const cameraSelect = document.getElementById("cameraSelect");

    let stream = null;
    let reader = null;
    let scanning = false;

    let lastDni = null;
    let lastTs = 0;
    let busy = false;

    function setStatus(msg, ok=null) {
      statusEl.textContent = msg;
      statusEl.className = "status" + (ok === true ? " ok" : ok === false ? " bad" : "");
    }

    function normalizeDni(text) {
      const digits = (text || "").replace(/\D/g, "");
      return digits.length >= 8 ? digits.slice(-8) : digits;
    }

    async function registrarDni(dni) {
      if (busy) return;
      busy = true;

      try {
        const res = await fetch("{% url 'api_scan_asistencia' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
          },
          body: JSON.stringify({ code: dni })
        });

        const data = await res.json().catch(() => ({ ok:false, msg:"Respuesta inv√°lida" }));

        if (res.ok && data.ok) {
          setStatus(data.msg, true);
        } else {
          setStatus(data.msg || "No se pudo registrar.", false);
        }
      } catch (e) {
        setStatus("Error de red.", false);
      } finally {
        setTimeout(() => {
          busy = false;
          setStatus("Listo. Escanea el siguiente c√≥digo‚Ä¶", null);
        }, 1200);
      }
    }

    async function loadCameras() {
      cameraSelect.innerHTML = "";

      // Pedimos permiso una vez para que salgan los labels reales
      try {
        const tmp = await navigator.mediaDevices.getUserMedia({ video: true });
        tmp.getTracks().forEach(t => t.stop());
      } catch (_) {}

      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d => d.kind === "videoinput");

      // Filtrar c√°maras malas t√≠picas
      const good = cams.filter(c => !/ir|infrared|hello|virtual|obs|snap|manycam/i.test(c.label || ""));
      const list = good.length ? good : cams;

      list.forEach((c, idx) => {
        const opt = document.createElement("option");
        opt.value = c.deviceId;
        opt.textContent = c.label || `C√°mara ${idx+1}`;
        cameraSelect.appendChild(opt);
      });

      if (!list.length) {
        const opt = document.createElement("option");
        opt.textContent = "No se detect√≥ c√°mara";
        opt.value = "";
        cameraSelect.appendChild(opt);
      }
    }

    function stopAll() {
      scanning = false;

      if (reader) {
        try { reader.reset(); } catch (_) {}
        reader = null;
      }

      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }

      videoEl.srcObject = null;
      btnStop.disabled = true;
      btnStart.disabled = false;
      setStatus("Detenido. Pulsa ‚ÄúActivar c√°mara‚Äù para comenzar‚Ä¶", null);
    }

    async function start() {
      if (scanning) return;

      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        setStatus("‚ùå Tu navegador no soporta c√°mara.", false);
        return;
      }

      const deviceId = cameraSelect.value;
      if (!deviceId) {
        setStatus("‚ùå Selecciona una c√°mara v√°lida.", false);
        return;
      }

      btnStart.disabled = true;

      try {
        // 1) Abrir stream y mostrar preview
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            deviceId: { exact: deviceId },
            facingMode: "environment",
            width: { ideal: 1280 },
            height: { ideal: 720 }
          },
          audio: false
        });

        videoEl.srcObject = stream;
        await videoEl.play();  // IMPORTANTE para que se vea el video

        // 2) Iniciar lector
        reader = new ZXingBrowser.BrowserMultiFormatReader();
        scanning = true;
        btnStop.disabled = false;

        setStatus("‚úÖ C√°mara activa. Escanea el c√≥digo‚Ä¶");

        // Usamos el stream ya abierto
        await reader.decodeFromStream(stream, videoEl, (result, err) => {
          if (!result) return;

          const raw = result.getText();
          const dni = normalizeDni(raw);
          const now = Date.now();

          if (dni && dni.length === 8 && (dni !== lastDni || (now - lastTs) > 2000)) {
            lastDni = dni;
            lastTs = now;
            registrarDni(dni);
          }
        });

      } catch (e) {
        stopAll();
        const name = e?.name || "Error";
        const msg = e?.message || "Sin detalle";

        if (name === "NotAllowedError") {
          setStatus("‚ùå Permiso denegado. Permite la c√°mara en Edge (icono de c√°mara en la barra).", false);
        } else if (name === "NotFoundError") {
          setStatus("‚ùå No se encontr√≥ c√°mara.", false);
        } else if (name === "NotReadableError") {
          setStatus("‚ùå La c√°mara abri√≥ pero no entrega imagen. Cambia de c√°mara (evita IR) o reinicia Edge.", false);
        } else {
          setStatus(`‚ùå Error abriendo c√°mara (${name}): ${msg}`, false);
        }
      } finally {
        if (!scanning) btnStart.disabled = false;
      }
    }

    btnStart.addEventListener("click", start);
    btnStop.addEventListener("click", stopAll);

    // cargar c√°maras al abrir
    (async () => {
      await loadCameras();
      setStatus("Elige una c√°mara (no IR) y pulsa ‚ÄúActivar c√°mara‚Äù‚Ä¶", null);
    })();
  </script>
</body>
</html>

