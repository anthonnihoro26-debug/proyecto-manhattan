{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Escaneo de Asistencia</title>

  <style>
    :root{
      --bg1:#070A12;
      --bg2:#2B0A6D;
      --card: rgba(255,255,255,.06);
      --line: rgba(255,255,255,.12);
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --blue:#4F7CFF;
      --green: rgba(34,197,94,.22);
      --yellow: rgba(245,158,11,.22);
      --red: rgba(239,68,68,.22);
      --shadow: 0 18px 50px rgba(0,0,0,.35);
    }

    html,body{height:100%;}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      color:var(--txt);
      background:
        radial-gradient(1200px 600px at 20% 20%, rgba(79,124,255,.25), transparent 55%),
        radial-gradient(900px 500px at 85% 15%, rgba(168,85,247,.22), transparent 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      -webkit-tap-highlight-color: transparent;
    }

    .wrap{ max-width:1100px; margin:0 auto; padding:16px 16px 26px; }

    .topbar{
      display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;
      padding:14px 16px; border-radius:18px;
      background: rgba(255,255,255,.05);
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .brand{ display:flex; align-items:center; gap:12px; min-width:260px; }
    .badgeCam{
      width:42px; height:42px; border-radius:14px;
      display:grid; place-items:center;
      background: linear-gradient(135deg, rgba(79,124,255,.95), rgba(168,85,247,.85));
      box-shadow: 0 10px 22px rgba(79,124,255,.18);
      font-size: 20px; flex:0 0 auto;
    }
    .titles .h1{ font-size:20px; font-weight:950; margin:0; letter-spacing:.2px; }
    .titles .sub{ margin:2px 0 0; color:var(--muted); font-size:13px; }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }

    .btn{
      border:0; cursor:pointer; text-decoration:none;
      padding:10px 14px; border-radius:12px;
      display:inline-flex; gap:8px; align-items:center; justify-content:center;
      font-weight:900; font-size:14px; letter-spacing:.2px;
      background: rgba(255,255,255,.08);
      color:var(--txt);
      border:1px solid rgba(255,255,255,.12);
      user-select:none;
      transition: transform .12s ease, opacity .12s ease, box-shadow .12s ease;
      box-shadow: 0 10px 22px rgba(0,0,0,.20);
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 14px 28px rgba(0,0,0,.26); }
    .btn:active{ transform: translateY(0px); opacity:.92; }
    .btn-blue{ background: rgba(79,124,255,.22); border-color: rgba(79,124,255,.35); }
    .btn-red { background: rgba(239,68,68,.20); border-color: rgba(239,68,68,.35); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius:999px;
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.12);
      color: var(--txt);
      font-weight:900;
      font-size:13px;
      letter-spacing:.2px;
      user-select:none;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.65fr .35fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      border-radius:18px;
      background: var(--card);
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }

    .videoWrap{ position:relative; padding:14px; }
    .videoShell{
      position:relative;
      border-radius:16px;
      overflow:hidden;
      background:#000;
      box-shadow: 0 12px 32px rgba(0,0,0,.35);
    }

    .videoShell::before{ content:""; display:block; padding-top:56.25%; } /* 16:9 */
    video{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit: cover;
      display:block;
      background:#000;
    }

    .overlay{
      position:absolute; inset:0;
      pointer-events:none;
      display:flex; align-items:center; justify-content:center;
    }

    .overlayGrid{
      width:100%;
      height:100%;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap:14px;
      padding: 12px;
    }

    .winQR{
      width: 58%;
      max-width: 480px;
      aspect-ratio: 1/1;
      border-radius: 22px;
      border: 2px solid rgba(79,124,255,.85);
      box-shadow: 0 0 0 9999px rgba(0,0,0,.36), 0 0 24px rgba(79,124,255,.18);
      position:relative;
      background: linear-gradient(to bottom, rgba(79,124,255,.00), rgba(79,124,255,.10), rgba(79,124,255,.00));
    }
    .winQR:before{
      content:"";
      position:absolute; inset:12px;
      border-radius: 16px;
      border:1px dashed rgba(255,255,255,.16);
    }

    .winBar{
      width: 84%;
      max-width: 820px;
      height: 20%;
      max-height: 150px;
      border-radius: 20px;
      border: 2px solid rgba(79,124,255,.90);
      box-shadow: 0 0 24px rgba(79,124,255,.18);
      position:relative;
      background: linear-gradient(to right, rgba(79,124,255,.00), rgba(79,124,255,.12), rgba(79,124,255,.00));
    }
    .winBar:before{
      content:"";
      position:absolute; inset:10px;
      border-radius: 14px;
      border:1px dashed rgba(255,255,255,.16);
    }
    .winBar:after{
      content:"";
      position:absolute;
      left: 8%;
      right: 8%;
      top: 50%;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(34,197,94,.95), transparent);
      box-shadow: 0 0 18px rgba(34,197,94,.24);
      animation: scan 1.1s ease-in-out infinite;
    }
    @keyframes scan{
      0% { transform: translateY(-26px); opacity:.45; }
      50%{ transform: translateY(26px); opacity:1; }
      100%{ transform: translateY(-26px); opacity:.45; }
    }

    .status{
      margin: 0 14px 14px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      font-weight: 950;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      min-height: 22px;
    }

    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-weight: 950;
      font-size: 12px;
      letter-spacing:.2px;
      user-select:none;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(255,255,255,.35);
      box-shadow: 0 0 12px rgba(255,255,255,.10);
    }
    .chip-run .dot{
      background: rgba(79,124,255,.95);
      box-shadow: 0 0 20px rgba(79,124,255,.24);
      animation: pulse 1.2s ease-in-out infinite;
    }
    .chip-ok .dot{ background: rgba(34,197,94,.9); box-shadow: 0 0 18px rgba(34,197,94,.22); }
    .chip-warn .dot{ background: rgba(245,158,11,.95); box-shadow: 0 0 18px rgba(245,158,11,.22); }
    .chip-bad .dot{ background: rgba(239,68,68,.95); box-shadow: 0 0 18px rgba(239,68,68,.22); }
    @keyframes pulse{
      0%{ transform: scale(0.9); opacity: .65; }
      50%{ transform: scale(1.1); opacity: 1; }
      100%{ transform: scale(0.9); opacity: .65; }
    }

    .side{ padding:14px; }
    .sideBox{
      padding: 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
    }
    .sideTitle{ margin:0 0 10px; font-size:14px; font-weight:950; letter-spacing:.2px; }
    .kv{ display:flex; flex-direction:column; gap:10px; font-size:13px; color: var(--muted); line-height:1.25; }
    .kv b{ color: rgba(255,255,255,.92); }

    .rangeRow{ display:flex; align-items:center; gap:10px; margin-top: 12px; }
    .rangeRow input[type="range"]{ width:100%; accent-color: rgba(79,124,255,.95); }
    .rangeVal{ min-width:42px; text-align:right; font-weight:950; color:rgba(255,255,255,.92); font-size:12px; }

    .hidden{ display:none !important; }

    .toastCard{
      margin-top: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      padding: 12px;
      box-shadow: 0 16px 30px rgba(0,0,0,.22);
      animation: pop .14s ease-out;
    }
    @keyframes pop{
      from{ transform: translateY(4px); opacity:.65; }
      to{ transform: translateY(0px); opacity:1; }
    }
    .toastHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 8px;
    }
    .toastTag{
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 950;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
    }
    .tag-ok{ background: rgba(34,197,94,.20); border-color: rgba(34,197,94,.35); }
    .tag-warn{ background: rgba(245,158,11,.20); border-color: rgba(245,158,11,.35); }
    .tag-bad{ background: rgba(239,68,68,.18); border-color: rgba(239,68,68,.35); }

    .toastName{
      font-weight: 950;
      font-size: 14px;
      color: rgba(255,255,255,.95);
      line-height: 1.2;
    }
    .toastMeta{
      margin-top: 6px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
      font-size:12px;
      color: rgba(255,255,255,.72);
      font-weight: 850;
    }
    .toastMeta b{ color: rgba(255,255,255,.92); }

    .miniList{
      margin-top: 12px;
      border-top: 1px solid rgba(255,255,255,.10);
      padding-top: 10px;
    }
    .miniTitle{
      font-weight: 950;
      font-size: 12px;
      color: rgba(255,255,255,.78);
      letter-spacing: .2px;
      margin: 0 0 8px;
    }
    .miniItem{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      margin-bottom: 8px;
      font-size: 12px;
      font-weight: 850;
      color: rgba(255,255,255,.82);
    }
    .miniLeft{ display:flex; flex-direction:column; gap:2px; }
    .miniName{ color: rgba(255,255,255,.92); font-weight: 950; }
    .miniSub{ color: rgba(255,255,255,.70); }
    .miniRight{ text-align:right; color: rgba(255,255,255,.72); white-space:nowrap; }
  </style>

  <script src="{% static 'asistencias/js/zxing-browser.min.js' %}"></script>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <div class="badgeCam">üì∑</div>
        <div class="titles">
          <p class="h1">Escaneo de Asistencia (DNI)</p>
          <p class="sub">QR + Barras ‚Ä¢ Auto-scan ‚Ä¢ <b>Solo entrada</b></p>
        </div>
      </div>

      <div class="actions">
        <span class="pill">üë§ <b>{{ request.user.username }}</b></span>

        <button id="btnFlip" class="btn btn-blue" type="button">üîÑ C√°mara</button>
        <button id="btnTorch" class="btn btn-blue hidden" type="button">üî¶ Linterna</button>
        <button id="btnStop" class="btn btn-red" disabled type="button">‚ñ† Detener</button>

        <form method="post" action="{% url 'logout' %}" style="margin:0">
          {% csrf_token %}
          <button class="btn" type="submit">Cerrar sesi√≥n</button>
        </form>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="videoWrap">
          <div class="videoShell">
            <video id="video" autoplay playsinline muted></video>

            <div class="overlay" id="overlay" style="display:none">
              <div class="overlayGrid">
                <div class="winQR"></div>
                <div class="winBar"></div>
              </div>
            </div>

          </div>
        </div>

        <div id="status" class="status">
          <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
            <span id="chip" class="chip chip-run"><span class="dot"></span> Iniciando‚Ä¶</span>
            <span id="msg">Abriendo c√°mara‚Ä¶</span>
          </div>
          <div style="color:rgba(255,255,255,.72); font-weight:800; font-size:12px;">
            √öltimo: <b id="lastText">‚Äî</b>
          </div>
        </div>
      </div>

      <div class="card side">
        <div class="sideBox">
          <p class="sideTitle">Pro</p>

          <div class="kv">
            <div>‚ö° Estado: <b id="stateText">Iniciando</b></div>
            <div>üì∑ C√°mara: <b id="camText">‚Äî</b></div>
            <div style="margin-top:4px;">Tip: Barras horizontal dentro del recuadro.</div>
          </div>

          <div id="zoomBox" class="rangeRow hidden">
            <span style="font-weight:950; color:rgba(255,255,255,.92); font-size:12px;">üîç</span>
            <input id="zoomRange" type="range" min="1" max="3" step="0.1" value="1" />
            <span id="zoomVal" class="rangeVal">1.0x</span>
          </div>

          <div id="toastCard" class="toastCard hidden">
            <div class="toastHead">
              <div id="toastTag" class="toastTag tag-ok">‚úÖ OK</div>
              <div style="font-size:12px; color:rgba(255,255,255,.70); font-weight:900;">
                <span id="toastTime">‚Äî</span>
              </div>
            </div>

            <div class="toastName" id="toastName">‚Äî</div>

            <div class="toastMeta">
              <div>C√≥digo: <b id="toastCod">‚Äî</b></div>
              <div>Cond.: <b id="toastCond">‚Äî</b></div>
              <div>DNI: <b id="toastDni">‚Äî</b></div>
              <div>Estado: <b id="toastState">‚Äî</b></div>
            </div>
          </div>

          <div class="miniList">
            <p class="miniTitle">√öltimos 5 escaneos</p>
            <div id="lastList"></div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    // ---- CSRF ----
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    const csrftoken = getCookie('csrftoken');

    const videoEl   = document.getElementById("video");
    const overlayEl = document.getElementById("overlay");
    const btnStop   = document.getElementById("btnStop");
    const btnFlip   = document.getElementById("btnFlip");
    const btnTorch  = document.getElementById("btnTorch");

    const chipEl    = document.getElementById("chip");
    const msgEl     = document.getElementById("msg");
    const lastText  = document.getElementById("lastText");
    const stateText = document.getElementById("stateText");
    const camText   = document.getElementById("camText");

    const zoomBox   = document.getElementById("zoomBox");
    const zoomRange = document.getElementById("zoomRange");
    const zoomVal   = document.getElementById("zoomVal");

    const toastCard = document.getElementById("toastCard");
    const toastTag  = document.getElementById("toastTag");
    const toastTime = document.getElementById("toastTime");
    const toastName = document.getElementById("toastName");
    const toastCod  = document.getElementById("toastCod");
    const toastCond = document.getElementById("toastCond");
    const toastDni  = document.getElementById("toastDni");
    const toastState= document.getElementById("toastState");
    const lastList  = document.getElementById("lastList");

    // ========= Config =========
    const COOLDOWN_MS = 2500;   // m√°s r√°pido
    const MESSAGE_MS  = 2500;
    const LOOP_MS     = 75;

    // ========= Estado =========
    let stream = null;
    let track = null;
    let running = false;

    let busy = false;
    let cooldownUntil = 0;
    let loopTimer = null;

    let lastKey = null;
    let lastTs = 0;

    let detector = null;
    let zxingReader = null;

    let cameras = [];
    let camIndex = 0;

    let torchOn = false;

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d", { willReadFrequently: true });

    // ===========================
    // AUDIO + VIB
    // ===========================
    let audioCtx = null;
    let master = null;

    function ensureAudioCtx(){
      if (!audioCtx){
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        master = audioCtx.createGain();
        master.gain.value = 1.0;
        master.connect(audioCtx.destination);
      }
      return audioCtx;
    }

    async function unlockAudioOnce(){
      try{
        const c = ensureAudioCtx();
        if (c.state === "suspended") await c.resume();
        const o = c.createOscillator();
        const g = c.createGain();
        g.gain.value = 0.0001;
        o.connect(g); g.connect(master);
        o.start();
        o.stop(c.currentTime + 0.02);
      }catch(e){}
    }
    window.addEventListener("pointerdown", unlockAudioOnce, { passive:true });
    window.addEventListener("touchstart", unlockAudioOnce, { passive:true });

    function tone(freq, durMs, vol){
      try{
        if (!audioCtx || audioCtx.state !== "running") return;
        const t0 = audioCtx.currentTime;
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = "square";
        o.frequency.setValueAtTime(freq, t0);

        const v = Math.min(Math.max(vol, 0.05), 1.0);
        g.gain.setValueAtTime(0.0001, t0);
        g.gain.exponentialRampToValueAtTime(v, t0 + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t0 + durMs/1000);

        o.connect(g); g.connect(master);
        o.start(t0);
        o.stop(t0 + durMs/1000 + 0.02);
      }catch(e){}
    }

    function beepOk(){ tone(1400,110,0.9); setTimeout(()=>tone(980,150,0.9),130); }
    function beepWarn(){ tone(740,210,0.85); setTimeout(()=>tone(620,210,0.85),240); }
    function beepBad(){ tone(280,240,1.0); setTimeout(()=>tone(220,240,1.0),260); }

    function vibOk(){ try{ navigator.vibrate?.([70]); }catch(e){} }
    function vibWarn(){ try{ navigator.vibrate?.([70,35,70]); }catch(e){} }
    function vibBad(){ try{ navigator.vibrate?.([110,55,110,55,110]); }catch(e){} }

    // ========= UI =========
    function setChip(kind, text){
      chipEl.className = "chip " + (kind ? ("chip-" + kind) : "");
      chipEl.innerHTML = '<span class="dot"></span> ' + text;
      stateText.textContent = text.replace("‚Ä¶","").trim();
    }
    function setMsg(t){ msgEl.textContent = t; }

    const recent = [];

    function maskDni(dni){
      if (!dni) return "‚Äî";
      const s = String(dni);
      if (s.length < 4) return "‚Äî";
      return "****" + s.slice(-4);
    }

    function showToast(kind, data){
      toastTag.className = "toastTag " + (kind === "ok" ? "tag-ok" : kind === "warn" ? "tag-warn" : "tag-bad");
      toastTag.textContent = kind === "ok" ? "‚úÖ OK" : kind === "warn" ? "‚ö†Ô∏è DUPLICADO" : "‚ùå ERROR";

      const now = new Date();
      toastTime.textContent = now.toLocaleTimeString();

      toastName.textContent = data.name || "‚Äî";
      toastCod.textContent = data.codigo || "‚Äî";
      toastCond.textContent = data.condicion || "‚Äî";
      toastDni.textContent = maskDni(data.dni);
      toastState.textContent = data.estado || "‚Äî";

      toastCard.classList.remove("hidden");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toastCard.classList.add("hidden"), 3600);
    }

    function renderRecent(){
      lastList.innerHTML = "";
      if (!recent.length){
        lastList.innerHTML = `<div class="miniItem"><div class="miniLeft"><div class="miniName">‚Äî</div><div class="miniSub">A√∫n no hay escaneos</div></div><div class="miniRight">‚Äî</div></div>`;
        return;
      }
      for (const it of recent){
        const el = document.createElement("div");
        el.className = "miniItem";
        el.innerHTML = `
          <div class="miniLeft">
            <div class="miniName">${it.name}</div>
            <div class="miniSub">${it.cod} ‚Ä¢ ${it.cond} ‚Ä¢ ${maskDni(it.dni)} ‚Ä¢ ${it.status}</div>
          </div>
          <div class="miniRight">${it.time}</div>
        `;
        lastList.appendChild(el);
      }
    }
    renderRecent();

    function pushRecent(item){
      recent.unshift(item);
      if (recent.length > 5) recent.pop();
      renderRecent();
    }

    function extractDni(text){
      const s = (text || "").toString();
      const m = s.match(/(\d{8})/);
      if (m) return m[1];
      const digits = s.replace(/\D/g,"");
      if (digits.length === 7) return digits.padStart(8,"0");
      if (digits.length === 8) return digits;
      if (digits.length > 8) return digits.slice(-8);
      return "";
    }

    async function ensureCameraPermissionOnce(){
      try{
        const tmp = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
        tmp.getTracks().forEach(t => t.stop());
      }catch(e){}
    }

    async function loadCameras(){
      await ensureCameraPermissionOnce();
      const devices = await navigator.mediaDevices.enumerateDevices();
      cameras = devices.filter(d => d.kind === "videoinput");
      if (!cameras.length) throw new Error("No hay c√°maras disponibles");
      const backIdx = cameras.findIndex(c => /back|rear|environment/i.test(c.label || ""));
      camIndex = backIdx >= 0 ? backIdx : 0;
    }

    function currentCameraLabel(){
      const d = cameras[camIndex];
      if (!d) return "‚Äî";
      return (d.label && d.label.trim()) ? d.label : `C√°mara ${camIndex+1}/${cameras.length}`;
    }

    function setupDetector(){
      if ("BarcodeDetector" in window){
        detector = new BarcodeDetector({
          formats: ["qr_code","code_128","code_39","ean_13","ean_8","itf","upc_a","upc_e"]
        });
      } else detector = null;

      if (!zxingReader && typeof ZXingBrowser !== "undefined"){
        zxingReader = new ZXingBrowser.BrowserMultiFormatReader();
      }
    }

    async function setupZoom(track){
      try{
        const caps = track.getCapabilities ? track.getCapabilities() : null;
        if (!caps || !caps.zoom){ zoomBox.classList.add("hidden"); return; }
        const min = caps.zoom.min ?? 1;
        const max = caps.zoom.max ?? 3;
        const step = caps.zoom.step ?? 0.1;

        zoomRange.min = min;
        zoomRange.max = max;
        zoomRange.step = step;

        const start = Math.min(Math.max(1, min), max);
        zoomRange.value = start;
        zoomVal.textContent = parseFloat(start).toFixed(1) + "x";
        zoomBox.classList.remove("hidden");

        zoomRange.oninput = async () => {
          const z = parseFloat(zoomRange.value);
          zoomVal.textContent = z.toFixed(1) + "x";
          try{ await track.applyConstraints({ advanced: [{ zoom: z }] }); }catch(e){}
        };
      }catch(e){
        zoomBox.classList.add("hidden");
      }
    }

    async function setupTorch(track){
      try{
        const caps = track.getCapabilities ? track.getCapabilities() : null;
        if (!caps || !caps.torch){
          btnTorch.classList.add("hidden");
          return;
        }
        btnTorch.classList.remove("hidden");
      }catch(e){
        btnTorch.classList.add("hidden");
      }
    }

    async function toggleTorch(){
      if (!track) return;
      try{
        torchOn = !torchOn;
        await track.applyConstraints({ advanced: [{ torch: torchOn }] });
        btnTorch.textContent = torchOn ? "üî¶ Linterna ON" : "üî¶ Linterna";
      }catch(e){
        btnTorch.classList.add("hidden");
      }
    }

    function roiQR(){
      const vw = videoEl.videoWidth || 1280;
      const vh = videoEl.videoHeight || 720;
      const size = Math.floor(Math.min(vw, vh) * 0.52);
      return { sx: Math.floor((vw - size)/2), sy: Math.floor((vh - size)/2), sw: size, sh: size };
    }
    function roiBAR(){
      const vw = videoEl.videoWidth || 1280;
      const vh = videoEl.videoHeight || 720;
      const sw = Math.floor(vw * 0.84);
      const sh = Math.floor(vh * 0.22);
      return { sx: Math.floor((vw - sw)/2), sy: Math.floor((vh - sh)/2), sw, sh };
    }

    async function registrarDni(dni){
      if (busy) return;
      busy = true;

      setChip("run","Registrando‚Ä¶");
      setMsg("Enviando‚Ä¶");

      const now = new Date();
      const timeStr = now.toLocaleTimeString();

      try{
        const res = await fetch("{% url 'api_scan_asistencia' %}", {
          method: "POST",
          credentials: "same-origin",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken,
            "X-Requested-With": "XMLHttpRequest"
          },
          body: JSON.stringify({ code: dni })
        });

        // ‚úÖ si sesi√≥n venci√≥
        if (res.status === 401 || res.status === 403){
          setChip("bad","Sesi√≥n");
          setMsg("Sesi√≥n vencida. Inicia sesi√≥n otra vez.");
          beepBad(); vibBad();
          stopCamera(true);
          return;
        }

        const ct = res.headers.get("content-type") || "";
        if (!ct.includes("application/json")){
          const text = await res.text();
          console.log("RESPUESTA NO JSON:", text);
          setChip("bad","Error");
          setMsg("Servidor no devolvi√≥ JSON (CSRF/login/500). Revisa consola.");
          beepBad(); vibBad();

          showToast("bad", { name:"Error servidor", codigo:"‚Äî", condicion:"‚Äî", dni:dni, estado:"NO JSON" });
          pushRecent({ name:"Error servidor", cod:"‚Äî", cond:"‚Äî", dni:dni, status:"ERROR", time: timeStr });
          return;
        }

        const data = await res.json();
        lastText.textContent = `${dni} ‚Ä¢ ${timeStr}`;

        const prof = data.profesor || {};
        const fullName = (prof.apellidos || "") + " " + (prof.nombres || "");
        const item = {
          name: fullName.trim() || "‚Äî",
          cod: prof.codigo || "‚Äî",
          cond: prof.condicion || "‚Äî",
          dni: prof.dni || dni,
          time: timeStr,
          status: "‚Äî"
        };

        if (res.ok && data.ok){
          if (data.duplicado){
            setChip("warn","Duplicado");
            setMsg(data.msg || "Ya registr√≥ hoy.");
            beepWarn(); vibWarn();

            item.status = "DUPLICADO";
            showToast("warn", { ...item, codigo:item.cod, condicion:item.cond, estado:"DUPLICADO", dni:item.dni });
          } else {
            setChip("ok","OK");
            setMsg(data.msg || "‚úÖ ENTRADA registrada.");
            beepOk(); vibOk();

            item.status = "ENTRADA";
            showToast("ok", { ...item, codigo:item.cod, condicion:item.cond, estado:"ENTRADA", dni:item.dni });
          }
          pushRecent(item);
        } else {
          setChip("bad","Fall√≥");
          setMsg(data.msg || "No se pudo registrar.");
          beepBad(); vibBad();

          item.status = "ERROR";
          showToast("bad", { ...item, codigo:item.cod, condicion:item.cond, estado:"ERROR", dni:item.dni });
          pushRecent(item);
        }

      }catch(e){
        setChip("bad","Sin red");
        setMsg("Error de red.");
        beepBad(); vibBad();

        showToast("bad", { name:"Sin red", codigo:"‚Äî", condicion:"‚Äî", dni:dni, estado:"RED" });
        pushRecent({ name:"Sin red", cod:"‚Äî", cond:"‚Äî", dni:dni, status:"ERROR", time: timeStr });
      }finally{
        cooldownUntil = Date.now() + COOLDOWN_MS;

        setTimeout(()=>{
          busy = false;
          if (running){
            setChip("run","Escaneando‚Ä¶");
            setMsg("Listo. Escanea el siguiente‚Ä¶");
          }
        }, MESSAGE_MS);
      }
    }

    async function detectInROI(roi){
      canvas.width = roi.sw;
      canvas.height = roi.sh;

      try{
        ctx.drawImage(videoEl, roi.sx, roi.sy, roi.sw, roi.sh, 0, 0, roi.sw, roi.sh);
      }catch(e){
        return null;
      }

      if (detector){
        try{
          const bitmap = await createImageBitmap(canvas);
          const codes = await detector.detect(bitmap);
          bitmap.close?.();
          if (codes && codes.length) return codes[0].rawValue || "";
        }catch(e){}
      }

      if (!detector && zxingReader && zxingReader.decodeOnceFromVideoElement){
        try{
          const result = await zxingReader.decodeOnceFromVideoElement(videoEl);
          return result?.getText ? result.getText() : null;
        }catch(e){}
      }

      return null;
    }

    async function scanLoop(){
      if (!running) return;

      const now = Date.now();
      if (now < cooldownUntil){
        loopTimer = setTimeout(scanLoop, LOOP_MS);
        return;
      }

      if (!busy){
        let raw = await detectInROI(roiQR());
        if (!raw) raw = await detectInROI(roiBAR());

        if (raw){
          const dni = extractDni(raw);
          const t = Date.now();
          const key = (dni || raw).slice(0, 40);

          if (dni && dni.length === 8 && (key !== lastKey || (t - lastTs) > 1400)){
            lastKey = key; lastTs = t;
            registrarDni(dni);
          }
        }
      }

      loopTimer = setTimeout(scanLoop, LOOP_MS);
    }

    async function startCamera(){
      stopCamera(true);

      ensureAudioCtx();
      try{ if (audioCtx.state === "suspended") await audioCtx.resume(); }catch(e){}

      if (!window.isSecureContext){
        setChip("bad","HTTPS");
        setMsg("C√°mara requiere HTTPS (o localhost).");
        return;
      }

      try{
        setChip("run","Iniciando‚Ä¶");
        setMsg("Abriendo c√°mara‚Ä¶");

        if (!cameras.length) await loadCameras();
        const chosenId = cameras[camIndex]?.deviceId;

        let constraints = {
          video: {
            deviceId: chosenId ? { ideal: chosenId } : undefined,
            width:  { ideal: 1920 },
            height: { ideal: 1080 },
            facingMode: { ideal: "environment" }
          },
          audio: false
        };

        try{
          stream = await navigator.mediaDevices.getUserMedia(constraints);
        }catch(e){
          try{
            stream = await navigator.mediaDevices.getUserMedia({
              video: { facingMode: { ideal: "environment" }, width:{ideal:1920}, height:{ideal:1080} },
              audio: false
            });
          }catch(e2){
            stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
          }
        }

        videoEl.srcObject = stream;
        await new Promise(r => (videoEl.onloadedmetadata = () => r()));
        overlayEl.style.display = "flex";

        track = stream.getVideoTracks()[0];
        camText.textContent = currentCameraLabel();

        setupDetector();
        await setupZoom(track);
        await setupTorch(track);

        running = true;
        btnStop.disabled = false;

        setChip("run","Escaneando‚Ä¶");
        setMsg("QR o Barras: pon el c√≥digo en su recuadro.");
        cooldownUntil = 0;
        busy = false;

        scanLoop();

      }catch(e){
        const name = e?.name || "Error";
        running = false;
        btnStop.disabled = true;

        if (name === "NotAllowedError"){ setChip("bad","Permiso"); setMsg("Permiso denegado. Habilita la c√°mara."); }
        else if (name === "NotFoundError"){ setChip("bad","Sin c√°mara"); setMsg("No se encontr√≥ c√°mara."); }
        else if (name === "NotReadableError"){ setChip("bad","Ocupada"); setMsg("C√°mara ocupada por otra app."); }
        else { setChip("bad","Error"); setMsg(`No se pudo abrir: ${name}`); }

        beepBad(); vibBad();
      }
    }

    function stopCamera(silent=false){
      running = false;
      busy = false;
      cooldownUntil = 0;

      if (loopTimer) clearTimeout(loopTimer);
      loopTimer = null;

      try{ zxingReader?.reset?.(); }catch(e){}
      zxingReader = null;
      detector = null;

      torchOn = false;
      btnTorch.textContent = "üî¶ Linterna";
      btnTorch.classList.add("hidden");

      zoomBox.classList.add("hidden");
      zoomRange.oninput = null;

      if (stream){
        stream.getTracks().forEach(t => t.stop());
      }
      stream = null;
      track = null;

      videoEl.srcObject = null;
      overlayEl.style.display = "none";

      btnStop.disabled = true;

      if (!silent){
        setChip("", "Detenido");
        setMsg("C√°mara detenida.");
      }
    }

    btnStop.addEventListener("click", () => stopCamera(false));

    btnFlip.addEventListener("click", async () => {
      try{
        setChip("run","Cambiando‚Ä¶");
        setMsg("Cambiando c√°mara‚Ä¶");

        if (!cameras.length) await loadCameras();
        camIndex = (camIndex + 1) % cameras.length;
        await startCamera();
      }catch(e){
        setChip("bad","Error");
        setMsg("No se pudo cambiar c√°mara. Revisa permisos/HTTPS.");
        beepBad(); vibBad();
      }
    });

    btnTorch.addEventListener("click", toggleTorch);

    window.addEventListener("load", () => {
      ensureAudioCtx();
      startCamera();
    });
  </script>
</body>
</html>

