{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Escaneo de Asistencia ‚Ä¢ V3 Hybrid Quantum</title>

  <style>
    :root{
      --bg0:#04060c;
      --bg1:#081126;
      --bg2:#120b2f;

      --txt: rgba(245,250,255,.95);
      --muted: rgba(220,230,245,.72);
      --line: rgba(255,255,255,.11);
      --line-blue: rgba(91,140,255,.26);

      --glass: rgba(255,255,255,.05);
      --glass2: rgba(255,255,255,.07);

      --blue:#5b8cff;
      --cyan:#22d3ee;
      --violet:#a855f7;
      --green:#22c55e;
      --amber:#f59e0b;
      --red:#ef4444;

      --shadow: 0 20px 55px rgba(0,0,0,.36);
      --radius: 20px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--txt);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      background:
        radial-gradient(1100px 700px at 12% 8%, rgba(91,140,255,.18), transparent 58%),
        radial-gradient(950px 650px at 88% 12%, rgba(168,85,247,.16), transparent 58%),
        radial-gradient(900px 500px at 50% 120%, rgba(34,211,238,.09), transparent 62%),
        linear-gradient(135deg, var(--bg0), var(--bg1) 52%, var(--bg2));
      overflow-x:hidden;
      position:relative;
      -webkit-tap-highlight-color: transparent;
    }

    /* ======================
       FX BACKGROUND
       ====================== */
    .scene{
      position:fixed; inset:0;
      z-index:0;
      pointer-events:none;
      overflow:hidden;
    }

    .orb{
      position:absolute;
      width:38vmax; height:38vmax;
      border-radius:50%;
      filter: blur(28px);
      opacity:.26;
      animation: drift 16s ease-in-out infinite alternate;
    }
    .orb.o1{
      left:-8vmax; top:-8vmax;
      background: radial-gradient(circle, rgba(91,140,255,.55), transparent 62%);
    }
    .orb.o2{
      right:-10vmax; top:8vmax;
      background: radial-gradient(circle, rgba(168,85,247,.5), transparent 62%);
      animation-duration:20s;
    }
    .orb.o3{
      left:28%; bottom:-16vmax;
      background: radial-gradient(circle, rgba(34,211,238,.35), transparent 62%);
      animation-duration:22s;
    }
    @keyframes drift{
      from{ transform: translate3d(0,0,0) scale(1); }
      to{ transform: translate3d(18px,-12px,0) scale(1.08); }
    }

    .gridFx{
      position:absolute; inset:0;
      opacity:.06;
      background-image:
        linear-gradient(rgba(255,255,255,.16) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.16) 1px, transparent 1px);
      background-size: 28px 28px;
      mask-image: radial-gradient(circle at 50% 30%, #000 35%, transparent 85%);
    }

    .diagFx{
      position:absolute; inset:0;
      opacity:.035;
      background-image:
        linear-gradient(30deg, rgba(255,255,255,.16) 1px, transparent 1px),
        linear-gradient(150deg, rgba(255,255,255,.10) 1px, transparent 1px);
      background-size: 22px 22px;
      mask-image: radial-gradient(circle at 50% 35%, #000 30%, transparent 88%);
    }

    .rings{
      position:absolute; inset:auto auto -18vmax 50%;
      width:56vmax; height:56vmax;
      transform: translateX(-50%);
      border-radius:50%;
      opacity:.12;
      background:
        radial-gradient(circle, transparent 52%, rgba(34,211,238,.35) 53%, transparent 54%),
        radial-gradient(circle, transparent 62%, rgba(91,140,255,.26) 63%, transparent 64%),
        radial-gradient(circle, transparent 72%, rgba(168,85,247,.22) 73%, transparent 74%);
      animation: ringPulse 7s ease-in-out infinite;
    }
    @keyframes ringPulse{
      0%,100%{ transform: translateX(-50%) scale(.98); opacity:.10; }
      50%{ transform: translateX(-50%) scale(1.04); opacity:.16; }
    }

    .beam{
      position:absolute;
      width:60vmax; height:10vmax;
      filter: blur(24px);
      opacity:.12;
      background: linear-gradient(90deg, transparent, rgba(34,211,238,.8), transparent);
      transform: rotate(-14deg);
      top:20%; left:-30vmax;
      animation: beamMove 15s linear infinite;
    }
    @keyframes beamMove{
      from{ transform: translateX(0) rotate(-14deg); }
      to{ transform: translateX(160vmax) rotate(-14deg); }
    }

    #fxCanvas{
      position:absolute; inset:0;
      width:100%; height:100%;
      display:block;
      opacity:.9;
    }

    .wrap{
      position:relative;
      z-index:1;
      max-width:1240px;
      margin:0 auto;
      padding:14px 12px 22px;
    }

    /* ======================
       HEADER
       ====================== */
    .topbar{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      padding:12px;
      border-radius:18px;
      border:1px solid var(--line);
      background:
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03)),
        linear-gradient(90deg, rgba(91,140,255,.025), rgba(168,85,247,.02));
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      position:relative;
      overflow:hidden;
    }
    .topbar::before{
      content:"";
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(90deg, transparent 0 24px, rgba(255,255,255,.012) 24px 25px);
      pointer-events:none;
    }
    .topbar::after{
      content:"";
      position:absolute; left:0; right:0; top:0; height:1px;
      background: linear-gradient(90deg, transparent, rgba(34,211,238,.45), rgba(168,85,247,.45), transparent);
      box-shadow: 0 0 14px rgba(34,211,238,.15);
      pointer-events:none;
    }

    .brand{
      display:flex; align-items:center; gap:12px;
      min-width:0;
    }
    .brandBadge{
      width:46px; height:46px;
      border-radius:14px;
      display:grid; place-items:center;
      font-size:21px;
      background:
        radial-gradient(circle at 35% 25%, rgba(255,255,255,.12), transparent 55%),
        linear-gradient(135deg, rgba(91,140,255,.28), rgba(168,85,247,.22));
      border:1px solid rgba(255,255,255,.14);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.04),
        0 12px 24px rgba(0,0,0,.24);
      position:relative;
      overflow:hidden;
    }
    .brandBadge::before, .brandBadge::after{
      content:"";
      position:absolute;
      border-radius:999px;
      border:1px solid rgba(34,211,238,.18);
    }
    .brandBadge::before{ inset:6px; animation: spinSlow 8s linear infinite; }
    .brandBadge::after{ inset:11px; border-color: rgba(168,85,247,.15); animation: spinSlowRev 6s linear infinite; }
    @keyframes spinSlow{ to{ transform: rotate(360deg); } }
    @keyframes spinSlowRev{ to{ transform: rotate(-360deg); } }

    .titles{ min-width:0; }
    .titles .h1{
      margin:0;
      font-size:20px;
      font-weight:950;
      letter-spacing:.2px;
      line-height:1.05;
    }
    .titles .sub{
      margin:4px 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.2;
    }

    .actions{
      display:flex; align-items:center; justify-content:flex-end; gap:8px; flex-wrap:wrap;
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
      font-size:12px;
      font-weight:900;
      white-space:nowrap;
      max-width:100%;
    }
    .pill b{
      max-width:160px;
      overflow:hidden;
      text-overflow:ellipsis;
      display:inline-block;
      vertical-align:bottom;
    }

    .btn{
      border:1px solid rgba(255,255,255,.11);
      color:var(--txt);
      background: rgba(255,255,255,.05);
      border-radius:12px;
      padding:10px 12px;
      font-size:13px;
      font-weight:900;
      display:inline-flex; align-items:center; justify-content:center; gap:7px;
      cursor:pointer;
      text-decoration:none;
      user-select:none;
      white-space:nowrap;
      position:relative;
      overflow:hidden;
      box-shadow: 0 10px 20px rgba(0,0,0,.20);
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, opacity .12s ease;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 14px 28px rgba(0,0,0,.24); }
    .btn:active{ transform: translateY(0); opacity:.94; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; box-shadow:none; transform:none; }

    .btn::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(120deg, transparent 25%, rgba(255,255,255,.06), transparent 65%);
      transform: translateX(-110%);
      transition: transform .45s ease;
      pointer-events:none;
    }
    .btn:hover::before{ transform: translateX(120%); }

    .btn-blue{
      border-color: rgba(91,140,255,.25);
      background: linear-gradient(180deg, rgba(91,140,255,.14), rgba(91,140,255,.09));
      box-shadow: 0 10px 20px rgba(0,0,0,.20), inset 0 0 0 1px rgba(91,140,255,.05);
    }
    .btn-blue:hover{
      border-color: rgba(91,140,255,.42);
      box-shadow: 0 14px 28px rgba(91,140,255,.16);
    }

    .btn-stop{
      border-color: rgba(245,158,11,.24);
      background: linear-gradient(180deg, rgba(245,158,11,.14), rgba(245,158,11,.09));
    }
    .btn-stop:hover{
      border-color: rgba(245,158,11,.42);
      box-shadow: 0 14px 28px rgba(245,158,11,.14);
    }

    .hidden{ display:none !important; }

    /* ======================
       LAYOUT
       ====================== */
    .grid{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1.7fr .95fr;
      gap:12px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.08);
      background:
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.025));
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(500px 120px at 12% -2%, rgba(91,140,255,.07), transparent 70%),
        radial-gradient(500px 120px at 88% 102%, rgba(168,85,247,.06), transparent 70%);
      pointer-events:none;
    }

    /* ======================
       VIDEO PANEL
       ====================== */
    .videoWrap{
      padding:12px;
      position:relative;
      z-index:1;
    }
    .videoShell{
      position:relative;
      border-radius:16px;
      overflow:hidden;
      background:#000;
      border:1px solid rgba(255,255,255,.08);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.02),
        0 14px 30px rgba(0,0,0,.34);
    }
    .videoShell::before{
      content:"";
      display:block;
      padding-top:56.25%;
    }
    .videoShell::after{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      background:
        linear-gradient(to bottom, rgba(255,255,255,.02), transparent 22%, transparent 78%, rgba(255,255,255,.02)),
        repeating-linear-gradient(to bottom, rgba(255,255,255,.012) 0 1px, transparent 1px 4px);
      opacity:.28;
      mix-blend-mode: screen;
    }

    video{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      display:block;
      background:#000;
    }

    .overlay{
      position:absolute; inset:0;
      display:none;
      align-items:center; justify-content:center;
      pointer-events:none;
      background:
        radial-gradient(circle at center, transparent 32%, rgba(0,0,0,.10) 70%, rgba(0,0,0,.24));
    }

    .overlayGrid{
      position:relative;
      width:100%; height:100%;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap:10px;
      padding:10px;
    }

    .hudLeft{
      position:absolute;
      top:10px; left:10px;
      display:flex; flex-direction:column; gap:6px;
      min-width:0;
    }
    .hudPill{
      display:inline-flex; align-items:center; gap:8px;
      width:max-content; max-width:100%;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(34,211,238,.20);
      background: rgba(5,12,22,.64);
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 16px rgba(0,0,0,.16);
      font-size:11px; font-weight:900;
    }
    .hudPill.small{
      font-size:10px;
      letter-spacing:.35px;
      color: rgba(220,235,255,.78);
      border-color: rgba(255,255,255,.10);
    }
    .hudPill .ldot{
      width:7px; height:7px; border-radius:999px;
      background: rgba(34,197,94,.95);
      box-shadow: 0 0 12px rgba(34,197,94,.3);
      animation: pulse 1.1s ease-in-out infinite;
      flex:0 0 auto;
    }

    .hudRight{
      position:absolute;
      top:10px; right:10px;
      padding:6px 9px;
      border-radius:999px;
      border:1px solid rgba(168,85,247,.22);
      background: rgba(8,10,22,.62);
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 16px rgba(0,0,0,.16);
      font-size:10px; font-weight:900; letter-spacing:.3px;
      color: rgba(232,224,255,.90);
    }

    .winQR{
      width:60%;
      max-width:500px;
      aspect-ratio:1/1;
      border-radius:22px;
      position:relative;
      border:2px solid rgba(34,211,238,.85);
      box-shadow:
        0 0 0 9999px rgba(0,0,0,.32),
        0 0 0 1px rgba(255,255,255,.03),
        0 0 28px rgba(34,211,238,.18),
        inset 0 0 18px rgba(34,211,238,.10);
      background:
        radial-gradient(circle at center, rgba(34,211,238,.05), transparent 60%),
        linear-gradient(180deg, rgba(34,211,238,.02), rgba(34,211,238,.08), rgba(34,211,238,.02));
      transition: border-color .15s ease, box-shadow .15s ease;
      overflow:hidden;
    }
    .winQR::before{
      content:"";
      position:absolute; inset:12px;
      border-radius:16px;
      border:1px dashed rgba(200,230,255,.15);
    }
    .winQR .mesh{
      position:absolute; inset:0;
      background-image:
        linear-gradient(rgba(255,255,255,.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.05) 1px, transparent 1px);
      background-size: 20px 20px;
      opacity:.18;
      mask-image: radial-gradient(circle at center, #000 35%, transparent 85%);
    }
    .winQR .scanGlow{
      position:absolute; left:10px; right:10px; top:50%;
      height:18px;
      background: radial-gradient(ellipse at center, rgba(34,211,238,.18), transparent 75%);
      transform: translateY(-9px);
      filter: blur(4px);
      animation: qrSweepGlow 1.2s ease-in-out infinite;
      opacity:.75;
    }
    .winQR .scanLine{
      position:absolute; left:10px; right:10px; top:50%;
      height:2px;
      background: linear-gradient(90deg, transparent, rgba(34,211,238,.95), transparent);
      box-shadow: 0 0 16px rgba(34,211,238,.35);
      animation: qrSweep 1.2s ease-in-out infinite;
    }
    .winQR .centerDot{
      position:absolute; left:50%; top:50%;
      width:10px; height:10px; border-radius:999px;
      transform: translate(-50%, -50%);
      background: rgba(34,211,238,.95);
      box-shadow: 0 0 14px rgba(34,211,238,.35);
      opacity:.85;
      animation: pulse 1.4s ease-in-out infinite;
    }

    @keyframes qrSweep{
      0%{ transform: translateY(-42px); opacity:.4; }
      50%{ transform: translateY(42px); opacity:1; }
      100%{ transform: translateY(-42px); opacity:.4; }
    }
    @keyframes qrSweepGlow{
      0%{ transform: translateY(-48px); }
      50%{ transform: translateY(36px); }
      100%{ transform: translateY(-48px); }
    }

    .winBar{
      width:86%;
      max-width:860px;
      height:20%;
      min-height:76px;
      max-height:150px;
      border-radius:20px;
      position:relative;
      border:2px solid rgba(91,140,255,.82);
      box-shadow:
        0 0 24px rgba(91,140,255,.16),
        inset 0 0 14px rgba(91,140,255,.08);
      background: linear-gradient(90deg, rgba(91,140,255,.02), rgba(91,140,255,.10), rgba(91,140,255,.02));
      transition: border-color .15s ease, box-shadow .15s ease;
      overflow:hidden;
    }
    .winBar::before{
      content:"";
      position:absolute; inset:9px;
      border-radius:13px;
      border:1px dashed rgba(200,230,255,.14);
    }
    .winBar::after{
      content:"";
      position:absolute; left:7%; right:7%; top:50%;
      height:2px;
      background: linear-gradient(90deg, transparent, rgba(34,197,94,.95), transparent);
      box-shadow: 0 0 14px rgba(34,197,94,.25);
      animation: barSweep 1.05s ease-in-out infinite;
    }
    @keyframes barSweep{
      0%{ transform: translateY(-20px); opacity:.4; }
      50%{ transform: translateY(20px); opacity:1; }
      100%{ transform: translateY(-20px); opacity:.4; }
    }

    .corner{
      position:absolute;
      width:30px; height:30px;
      border-style:solid;
      border-color: rgba(34,211,238,.95);
      opacity:.95;
      filter: drop-shadow(0 0 8px rgba(34,211,238,.24));
    }
    .c-tl{ top:8px; left:8px; border-width:3px 0 0 3px; border-radius:11px 0 0 0; }
    .c-tr{ top:8px; right:8px; border-width:3px 3px 0 0; border-radius:0 11px 0 0; }
    .c-bl{ bottom:8px; left:8px; border-width:0 0 3px 3px; border-radius:0 0 0 11px; }
    .c-br{ bottom:8px; right:8px; border-width:0 3px 3px 0; border-radius:0 0 11px 0; }

    .detected .winQR,
    .detected .winBar{
      border-color: rgba(34,197,94,.95);
      box-shadow:
        0 0 0 9999px rgba(0,0,0,.27),
        0 0 30px rgba(34,197,94,.22),
        inset 0 0 20px rgba(34,197,94,.12);
    }

    /* SOLO QR visual (sigue detectando QR+barras) */
    .overlayGrid.mode-qr .winBar{
      display:none !important;
    }
    .overlayGrid.mode-qr{
      gap:0 !important;
    }
    .overlayGrid.mode-qr .winQR{
      width:64%;
      max-width:520px;
    }

    /* ======================
       STATUS BAR
       ====================== */
    .status{
      margin: 0 12px 12px;
      padding: 11px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.09);
      background: rgba(255,255,255,.035);
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      position:relative;
      z-index:1;
      overflow:hidden;
    }
    .status::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, transparent, rgba(34,211,238,.02), transparent);
      animation: statusFlow 6s linear infinite;
      pointer-events:none;
    }
    @keyframes statusFlow{
      from{ transform: translateX(-100%); }
      to{ transform: translateX(100%); }
    }

    .statusLeft{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap; min-width:0;
      position:relative; z-index:1;
    }
    .statusRight{
      display:flex; align-items:center; gap:12px; flex-wrap:wrap;
      font-size:12px; color:rgba(220,230,245,.72); font-weight:850;
      position:relative; z-index:1;
    }

    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      font-weight:950; font-size:12px;
      white-space:nowrap;
      position:relative;
      overflow:hidden;
    }
    .chip::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(120deg, transparent 20%, rgba(255,255,255,.05), transparent 70%);
      transform: translateX(-110%);
      animation: chipGlow 4s linear infinite;
      pointer-events:none;
    }
    @keyframes chipGlow{
      0%,70%{ transform: translateX(-110%); }
      100%{ transform: translateX(120%); }
    }

    .dot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(255,255,255,.34);
      box-shadow: 0 0 10px rgba(255,255,255,.08);
      position:relative; z-index:1;
    }
    .chip-run .dot{ background: var(--blue); box-shadow:0 0 16px rgba(91,140,255,.26); animation:pulse 1.2s ease-in-out infinite; }
    .chip-ok .dot{ background: var(--green); box-shadow:0 0 16px rgba(34,197,94,.24); }
    .chip-warn .dot{ background: var(--amber); box-shadow:0 0 16px rgba(245,158,11,.24); }
    .chip-bad .dot{ background: var(--red); box-shadow:0 0 16px rgba(239,68,68,.24); }

    @keyframes pulse{
      0%{ transform: scale(.9); opacity:.65; }
      50%{ transform: scale(1.12); opacity:1; }
      100%{ transform: scale(.9); opacity:.65; }
    }

    .hintMarquee{
      display:inline-flex; align-items:center; gap:8px;
      max-width:100%;
      color: rgba(245,250,255,.95);
      font-size:13px;
      font-weight:850;
      min-width:0;
    }
    .miniSpinner{
      width:12px; height:12px; border-radius:999px;
      border:2px solid rgba(255,255,255,.14);
      border-top-color: rgba(34,211,238,.95);
      animation: spin .75s linear infinite;
      flex:0 0 auto;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    /* ======================
       SIDE PANEL
       ====================== */
    .side{
      padding:12px;
      position:relative;
      z-index:1;
    }
    .sideBox{
      border-radius:16px;
      border:1px solid rgba(255,255,255,.09);
      background:
        linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      padding:12px;
      position:relative;
      overflow:hidden;
    }
    .sideBox::before{
      content:"";
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(0deg, transparent 0 16px, rgba(255,255,255,.008) 16px 17px);
      pointer-events:none;
    }

    .sideTitle{
      margin:0 0 10px;
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      font-size:14px; font-weight:950;
      position:relative; z-index:1;
    }
    .badgeLive{
      display:inline-flex; align-items:center; gap:6px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid rgba(34,197,94,.23);
      background: rgba(34,197,94,.12);
      font-size:11px; font-weight:950;
    }
    .badgeLive i{
      width:7px; height:7px; border-radius:999px; display:inline-block;
      background: rgba(34,197,94,.95);
      box-shadow: 0 0 12px rgba(34,197,94,.28);
      animation: pulse 1.2s ease-in-out infinite;
    }

    .kv{
      display:flex; flex-direction:column; gap:8px;
      font-size:13px; color:var(--muted); line-height:1.25;
      position:relative; z-index:1;
    }
    .kv b{ color: rgba(245,250,255,.95); }

    .statsGrid{
      margin-top:10px;
      display:grid; grid-template-columns:1fr 1fr; gap:8px;
      position:relative; z-index:1;
    }
    .statMini{
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
      padding:9px 10px;
      position:relative;
      overflow:hidden;
    }
    .statMini::after{
      content:"";
      position:absolute; left:0; right:0; top:0; height:1px;
      background: linear-gradient(90deg, transparent, rgba(34,211,238,.20), transparent);
      opacity:.7;
    }
    .statMini .k{
      font-size:11px; color:rgba(210,225,245,.72); font-weight:850;
    }
    .statMini .v{
      margin-top:2px;
      font-size:13px; font-weight:950; color:rgba(240,248,255,.96);
    }

    .rangeRow{
      display:flex; align-items:center; gap:10px;
      margin-top:12px;
      position:relative; z-index:1;
    }
    .rangeRow input[type="range"]{
      width:100%;
      accent-color: rgba(34,211,238,.95);
    }
    .rangeVal{
      min-width:42px; text-align:right;
      font-size:12px; font-weight:950;
      color: rgba(240,248,255,.94);
    }

    /* RESULT TOAST CARD */
    .toastCard{
      margin-top:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      padding:12px;
      box-shadow: 0 16px 28px rgba(0,0,0,.20);
      animation: pop .14s ease-out;
      position:relative;
      z-index:1;
      overflow:hidden;
    }
    .toastCard::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(120deg, transparent 25%, rgba(255,255,255,.02), transparent 70%);
      animation: cardSweep 3.4s linear infinite;
      pointer-events:none;
    }
    @keyframes pop{
      from{ transform: translateY(4px); opacity:.65; }
      to{ transform: translateY(0); opacity:1; }
    }
    @keyframes cardSweep{
      from{ transform: translateX(-110%); }
      to{ transform: translateX(120%); }
    }

    .toastHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:8px;
      position:relative; z-index:1;
    }
    .toastTag{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      font-size:12px; font-weight:950;
      background: rgba(255,255,255,.04);
      white-space:nowrap;
    }
    .tag-ok{ background: rgba(34,197,94,.16); border-color: rgba(34,197,94,.34); }
    .tag-warn{ background: rgba(245,158,11,.16); border-color: rgba(245,158,11,.34); }
    .tag-bad{ background: rgba(239,68,68,.14); border-color: rgba(239,68,68,.34); }

    .toastName{
      font-size:14px; font-weight:950; line-height:1.2;
      color: rgba(240,248,255,.96);
      word-break: break-word;
      position:relative; z-index:1;
    }
    .toastMeta{
      margin-top:6px;
      display:grid; grid-template-columns:1fr 1fr; gap:8px;
      font-size:12px; font-weight:850;
      color: rgba(210,225,245,.72);
      position:relative; z-index:1;
    }
    .toastMeta b{ color: rgba(240,248,255,.93); word-break: break-word; }

    .miniList{
      margin-top:12px;
      padding-top:10px;
      border-top:1px solid rgba(255,255,255,.08);
      position:relative; z-index:1;
    }
    .miniTitle{
      margin:0 0 8px;
      font-size:12px; font-weight:950; letter-spacing:.2px;
      color: rgba(210,225,245,.78);
    }
    .miniItem{
      display:flex; justify-content:space-between; gap:10px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
      margin-bottom:8px;
      font-size:12px; font-weight:850;
      color: rgba(220,235,255,.82);
    }
    .miniLeft{
      min-width:0; flex:1; display:flex; flex-direction:column; gap:2px;
    }
    .miniName{
      color: rgba(240,248,255,.95);
      font-weight:950;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .miniSub{
      color: rgba(210,225,245,.68);
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .miniRight{
      flex:0 0 auto;
      white-space:nowrap;
      color: rgba(210,225,245,.72);
      text-align:right;
    }

    /* ======================
       MOBILE
       ====================== */
    @media (max-width: 980px){
      .wrap{ padding:10px 10px 18px; }

      .topbar{
        grid-template-columns: 1fr;
        padding:10px;
        border-radius:16px;
      }

      .titles .h1{ font-size:17px; }
      .titles .sub{ font-size:12px; }

      .actions{
        width:100%;
        justify-content:stretch;
      }
      .actions .pill{
        order:-1;
        width:100%;
        justify-content:center;
      }
      .actions .btn, .actions form{
        flex:1 1 calc(50% - 6px);
      }
      .actions form .btn{ width:100%; }

      .videoWrap{ padding:10px; }
      .videoShell{ border-radius:14px; }
      .videoShell::before{ padding-top:72%; }

      .overlayGrid{ padding:8px; }
      .hudLeft{ top:8px; left:8px; }
      .hudRight{ top:8px; right:8px; }

      .winQR{ width:74%; border-radius:18px; }
      .winQR::before{ inset:10px; border-radius:12px; }
      .winBar{ width:92%; min-height:66px; border-radius:16px; }
      .winBar::before{ inset:8px; border-radius:10px; }
      .winBar::after{ left:6%; right:6%; }

      .corner{ width:22px; height:22px; border-width:2px !important; }

      .status{
        margin:0 10px 10px;
        padding:10px;
      }
      .statusRight{
        width:100%;
        justify-content:space-between;
        font-size:11px;
      }
      #msg{ font-size:12px; line-height:1.25; }

      .side{ padding:10px; }
      .toastMeta{ grid-template-columns:1fr; }

      .miniItem{ flex-direction:column; gap:4px; }
      .miniRight{ text-align:left; }

      .overlayGrid.mode-qr .winQR{ width:80%; }
    }

    @media (max-width: 520px){
      .brandBadge{
        width:40px; height:40px;
        border-radius:12px;
        font-size:18px;
      }
      .titles .h1{ font-size:15px; }
      .titles .sub{ font-size:11px; }

      .btn{ padding:9px 10px; font-size:12px; border-radius:10px; }
      .pill{ padding:8px 10px; font-size:11px; }

      .videoShell::before{ padding-top:78%; }

      .winQR{ width:80%; }
      .winBar{ width:95%; min-height:60px; }
    }

    @media (prefers-reduced-motion: reduce){
      *{
        animation-duration:.01ms !important;
        animation-iteration-count:1 !important;
        transition-duration:.01ms !important;
      }
    }
  </style>

  <script src="{% static 'asistencias/js/zxing-browser.min.js' %}"></script>
</head>

<body>
  <!-- FX Fondo -->
  <div class="scene" aria-hidden="true">
    <div class="orb o1"></div>
    <div class="orb o2"></div>
    <div class="orb o3"></div>
    <div class="gridFx"></div>
    <div class="diagFx"></div>
    <div class="rings"></div>
    <div class="beam"></div>
    <canvas id="fxCanvas"></canvas>
  </div>

  <div class="wrap">
    <!-- Header -->
    <div class="topbar">
      <div class="brand">
        <div class="brandBadge">üõ∞Ô∏è</div>
        <div class="titles">
          <p class="h1">Escaneo de Asistencia ‚Ä¢ V3 Hybrid Quantum</p>
          <p class="sub">QR + Barras ‚Ä¢ Auto-scan ‚Ä¢ <b>Registro de entrada por DNI (Profesores)</b></p>
        </div>
      </div>

      <div class="actions">
        <span class="pill">üë§ <b>{{ request.user.username }}</b></span>

        <button id="btnFlip" class="btn btn-blue" type="button">üîÑ C√°mara</button>
        <button id="btnTorch" class="btn btn-blue hidden" type="button">üî¶ Linterna</button>
        <button id="btnStop" class="btn btn-stop" type="button" disabled>‚è∏ Detener</button>

        <form method="post" action="{% url 'logout' %}" style="margin:0">
          {% csrf_token %}
          <button class="btn" type="submit">üö™ Cerrar sesi√≥n</button>
        </form>
      </div>
    </div>

    <div class="grid">
      <!-- Panel principal -->
      <div class="card">
        <div class="videoWrap">
          <div class="videoShell">
            <video id="video" autoplay playsinline muted></video>

            <div class="overlay" id="overlay">
              <div class="overlayGrid mode-qr" id="overlayGrid">
                <div class="hudLeft">
                  <div class="hudPill"><span class="ldot"></span> AUTO-SCAN ACTIVO</div>
                  <div class="hudPill small">HYBRID-QUANTUM / DNI-INPUT / READY</div>
                </div>
                <div class="hudRight">V3 HYBRID</div>

                <div class="winQR">
                  <span class="corner c-tl"></span>
                  <span class="corner c-tr"></span>
                  <span class="corner c-bl"></span>
                  <span class="corner c-br"></span>
                  <span class="mesh"></span>
                  <span class="scanGlow"></span>
                  <span class="scanLine"></span>
                  <span class="centerDot"></span>
                </div>

                <div class="winBar">
                  <span class="corner c-tl"></span>
                  <span class="corner c-tr"></span>
                  <span class="corner c-bl"></span>
                  <span class="corner c-br"></span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="status" class="status">
          <div class="statusLeft">
            <span id="chip" class="chip chip-run"><span class="dot"></span> Iniciando‚Ä¶</span>
            <span class="hintMarquee">
              <span class="miniSpinner" id="spinnerMini"></span>
              <span id="msg">Abriendo c√°mara‚Ä¶</span>
            </span>
          </div>

          <div class="statusRight">
            <span>√öltimo: <b id="lastText">‚Äî</b></span>
            <span>Hoy: <b id="countToday">0</b></span>
          </div>
        </div>
      </div>

      <!-- Panel lateral -->
      <div class="card side">
        <div class="sideBox">
          <p class="sideTitle">
            <span>Panel en vivo</span>
            <span class="badgeLive"><i></i> Activo</span>
          </p>

          <div class="kv">
            <div>‚ö° Estado: <b id="stateText">Iniciando</b></div>
            <div>üì∑ C√°mara: <b id="camText">‚Äî</b></div>
            <div>üïí Hora: <b id="clockText">--:--:--</b></div>
            <div>‚è± Sesi√≥n: <b id="sessionText">00:00</b></div>
            <div>üß† Tip: centra QR o barras dentro del recuadro.</div>
          </div>

          <div class="statsGrid">
            <div class="statMini">
              <div class="k">Escaneos hoy</div>
              <div class="v" id="kpiToday">0</div>
            </div>
            <div class="statMini">
              <div class="k">Modo</div>
              <div class="v">AUTO</div>
            </div>
            <div class="statMini">
              <div class="k">Backend</div>
              <div class="v" id="kpiBackend">Local</div>
            </div>
            <div class="statMini">
              <div class="k">Red</div>
              <div class="v" id="kpiNet">Online</div>
            </div>
          </div>

          <div id="zoomBox" class="rangeRow hidden">
            <span style="font-weight:950;color:rgba(240,248,255,.92);font-size:12px;">üîç</span>
            <input id="zoomRange" type="range" min="1" max="3" step="0.1" value="1" />
            <span id="zoomVal" class="rangeVal">1.0x</span>
          </div>

          <div id="toastCard" class="toastCard hidden">
            <div class="toastHead">
              <div id="toastTag" class="toastTag tag-ok">‚úÖ OK</div>
              <div style="font-size:12px;color:rgba(210,225,245,.72);font-weight:900;">
                <span id="toastTime">‚Äî</span>
              </div>
            </div>

            <div class="toastName" id="toastName">‚Äî</div>

            <div class="toastMeta">
              <div>C√≥digo: <b id="toastCod">‚Äî</b></div>
              <div>Cond.: <b id="toastCond">‚Äî</b></div>
              <div>DNI: <b id="toastDni">‚Äî</b></div>
              <div>Estado: <b id="toastState">‚Äî</b></div>
            </div>
          </div>

          <div class="miniList">
            <p class="miniTitle">√öltimos 5 escaneos</p>
            <div id="lastList"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===========================
    // FX Canvas part√≠culas + l√≠neas
    // ===========================
    (function initFX(){
      const cvs = document.getElementById("fxCanvas");
      if (!cvs) return;
      const ctx = cvs.getContext("2d");
      let w=0,h=0,dpr=1, raf=null;
      const pts = [];
      const COUNT_D = 52;
      const COUNT_M = 30;

      function rand(a,b){ return Math.random()*(b-a)+a; }

      function make(){
        return {
          x: rand(0, w || 1),
          y: rand(0, h || 1),
          r: rand(.7, 2.0),
          vx: rand(-.12, .12),
          vy: rand(-.10, .10),
          a: rand(.12, .40),
          hue: Math.random() > .45 ? "34,211,238" : (Math.random() > .5 ? "91,140,255" : "168,85,247")
        };
      }

      function resize(){
        w = innerWidth;
        h = innerHeight;
        dpr = Math.min(devicePixelRatio || 1, 2);

        cvs.width = Math.floor(w*dpr);
        cvs.height = Math.floor(h*dpr);
        cvs.style.width = w + "px";
        cvs.style.height = h + "px";
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

        const target = innerWidth < 700 ? COUNT_M : COUNT_D;
        while (pts.length < target) pts.push(make());
        while (pts.length > target) pts.pop();
      }

      function step(){
        ctx.clearRect(0,0,w,h);

        for (const p of pts){
          p.x += p.vx;
          p.y += p.vy;

          if (p.x < -10 || p.x > w + 10) p.vx *= -1;
          if (p.y < -10 || p.y > h + 10) p.vy *= -1;

          ctx.beginPath();
          ctx.fillStyle = `rgba(${p.hue},${p.a})`;
          ctx.shadowColor = `rgba(${p.hue},0.25)`;
          ctx.shadowBlur = 8;
          ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
          ctx.fill();
        }

        ctx.shadowBlur = 0;
        for (let i=0; i<pts.length; i++){
          for (let j=i+1; j<pts.length; j++){
            const a = pts[i], b = pts[j];
            const d = Math.hypot(a.x-b.x, a.y-b.y);
            if (d < 120){
              const alpha = (1 - d/120) * .07;
              ctx.beginPath();
              ctx.strokeStyle = `rgba(170,225,255,${alpha})`;
              ctx.lineWidth = 1;
              ctx.moveTo(a.x,a.y);
              ctx.lineTo(b.x,b.y);
              ctx.stroke();
            }
          }
        }

        raf = requestAnimationFrame(step);
      }

      resize();
      step();

      addEventListener("resize", resize, { passive:true });
      document.addEventListener("visibilitychange", () => {
        if (document.hidden && raf){
          cancelAnimationFrame(raf);
          raf = null;
        } else if (!document.hidden && !raf){
          step();
        }
      });
    })();

    // ===========================
    // CSRF
    // ===========================
    function getCookie(name){
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(";").shift();
      return "";
    }
    const csrftoken = getCookie("csrftoken");

    // ===========================
    // DOM refs
    // ===========================
    const videoEl     = document.getElementById("video");
    const overlayEl   = document.getElementById("overlay");
    const overlayGrid = document.getElementById("overlayGrid");

    const btnStop  = document.getElementById("btnStop");
    const btnFlip  = document.getElementById("btnFlip");
    const btnTorch = document.getElementById("btnTorch");

    const chipEl    = document.getElementById("chip");
    const msgEl     = document.getElementById("msg");
    const lastText  = document.getElementById("lastText");
    const stateText = document.getElementById("stateText");
    const camText   = document.getElementById("camText");

    const countTodayEl = document.getElementById("countToday");
    const kpiTodayEl   = document.getElementById("kpiToday");
    const kpiBackendEl = document.getElementById("kpiBackend");
    const kpiNetEl     = document.getElementById("kpiNet");
    const clockText    = document.getElementById("clockText");
    const sessionText  = document.getElementById("sessionText");

    const zoomBox   = document.getElementById("zoomBox");
    const zoomRange = document.getElementById("zoomRange");
    const zoomVal   = document.getElementById("zoomVal");

    const toastCard  = document.getElementById("toastCard");
    const toastTag   = document.getElementById("toastTag");
    const toastTime  = document.getElementById("toastTime");
    const toastName  = document.getElementById("toastName");
    const toastCod   = document.getElementById("toastCod");
    const toastCond  = document.getElementById("toastCond");
    const toastDni   = document.getElementById("toastDni");
    const toastState = document.getElementById("toastState");
    const lastList   = document.getElementById("lastList");

    // ===========================
    // Config
    // ===========================
    const COOLDOWN_MS = 2200;
    const MESSAGE_MS  = 2200;
    const LOOP_MS     = 75;

    // ===========================
    // Estado
    // ===========================
    let stream = null;
    let track = null;
    let running = false;

    let busy = false;
    let cooldownUntil = 0;
    let loopTimer = null;

    let lastKey = null;
    let lastTs = 0;

    let detector = null;
    let zxingReader = null;

    let cameras = [];
    let camIndex = 0;
    let torchOn = false;

    let detectedFlashTimer = null;

    let sessionStartedAt = Date.now();
    let scansToday = 0;

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d", { willReadFrequently: true });

    // ===========================
    // AUDIO + VIB
    // ===========================
    let audioCtx = null;
    let master = null;

    function ensureAudioCtx(){
      if (!audioCtx){
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        master = audioCtx.createGain();
        master.gain.value = 0.9;
        master.connect(audioCtx.destination);
      }
      return audioCtx;
    }

    async function unlockAudioOnce(){
      try{
        const c = ensureAudioCtx();
        if (c.state === "suspended") await c.resume();
        const o = c.createOscillator();
        const g = c.createGain();
        g.gain.value = 0.0001;
        o.connect(g); g.connect(master);
        o.start();
        o.stop(c.currentTime + 0.02);
      }catch(e){}
    }
    window.addEventListener("pointerdown", unlockAudioOnce, { passive:true });
    window.addEventListener("touchstart", unlockAudioOnce, { passive:true });

    function tone(freq, durMs, vol){
      try{
        if (!audioCtx || audioCtx.state !== "running") return;
        const t0 = audioCtx.currentTime;
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();

        o.type = "square";
        o.frequency.setValueAtTime(freq, t0);

        const v = Math.min(Math.max(vol, 0.05), 1);
        g.gain.setValueAtTime(0.0001, t0);
        g.gain.exponentialRampToValueAtTime(v, t0 + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t0 + durMs/1000);

        o.connect(g); g.connect(master);
        o.start(t0);
        o.stop(t0 + durMs/1000 + 0.02);
      }catch(e){}
    }

    function beepOk(){ tone(1460,95,0.75); setTimeout(()=>tone(1020,130,0.75),110); }
    function beepWarn(){ tone(740,170,0.65); setTimeout(()=>tone(620,170,0.65),190); }
    function beepBad(){ tone(280,180,0.85); setTimeout(()=>tone(220,180,0.85),210); }

    function vibOk(){ try{ navigator.vibrate?.([55]); }catch(e){} }
    function vibWarn(){ try{ navigator.vibrate?.([55,30,55]); }catch(e){} }
    function vibBad(){ try{ navigator.vibrate?.([90,40,90]); }catch(e){} }

    // ===========================
    // UI helpers
    // ===========================
    function setChip(kind, text){
      chipEl.className = "chip " + (kind ? ("chip-" + kind) : "");
      chipEl.innerHTML = '<span class="dot"></span> ' + text;
      stateText.textContent = text.replace("‚Ä¶","").trim();
    }

    function setMsg(t){
      msgEl.textContent = t;
    }

    function setDetectedFlash(){
      overlayGrid.classList.add("detected");
      clearTimeout(detectedFlashTimer);
      detectedFlashTimer = setTimeout(() => overlayGrid.classList.remove("detected"), 320);
    }

    function updateScansTodayUI(){
      countTodayEl.textContent = String(scansToday);
      kpiTodayEl.textContent = String(scansToday);
    }

    function tickInfoPanel(){
      const now = new Date();
      clockText.textContent = now.toLocaleTimeString();

      const sec = Math.max(0, Math.floor((Date.now() - sessionStartedAt) / 1000));
      const mm = String(Math.floor(sec / 60)).padStart(2, "0");
      const ss = String(sec % 60).padStart(2, "0");
      sessionText.textContent = `${mm}:${ss}`;

      kpiNetEl.textContent = navigator.onLine ? "Online" : "Offline";
    }
    setInterval(tickInfoPanel, 1000);
    tickInfoPanel();

    window.addEventListener("online",  () => { kpiNetEl.textContent = "Online"; });
    window.addEventListener("offline", () => { kpiNetEl.textContent = "Offline"; });

    const recent = [];

    function maskDni(dni){
      if (!dni) return "‚Äî";
      const s = String(dni);
      if (s.length < 4) return "‚Äî";
      return "****" + s.slice(-4);
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function showToast(kind, data){
      toastTag.className = "toastTag " + (kind === "ok" ? "tag-ok" : kind === "warn" ? "tag-warn" : "tag-bad");
      toastTag.textContent = kind === "ok" ? "‚úÖ OK" : kind === "warn" ? "‚ö†Ô∏è DUPLICADO" : "‚ùå ERROR";

      toastTime.textContent = new Date().toLocaleTimeString();

      toastName.textContent = data.name || "‚Äî";
      toastCod.textContent = data.codigo || "‚Äî";
      toastCond.textContent = data.condicion || "‚Äî";
      toastDni.textContent = maskDni(data.dni);
      toastState.textContent = data.estado || "‚Äî";

      toastCard.classList.remove("hidden");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toastCard.classList.add("hidden"), 3600);
    }

    function renderRecent(){
      lastList.innerHTML = "";
      if (!recent.length){
        lastList.innerHTML = `
          <div class="miniItem">
            <div class="miniLeft">
              <div class="miniName">‚Äî</div>
              <div class="miniSub">A√∫n no hay escaneos</div>
            </div>
            <div class="miniRight">‚Äî</div>
          </div>
        `;
        return;
      }

      for (const it of recent){
        const el = document.createElement("div");
        el.className = "miniItem";
        el.innerHTML = `
          <div class="miniLeft">
            <div class="miniName">${escapeHtml(it.name)}</div>
            <div class="miniSub">${escapeHtml(it.cod)} ‚Ä¢ ${escapeHtml(it.cond)} ‚Ä¢ ${escapeHtml(maskDni(it.dni))} ‚Ä¢ ${escapeHtml(it.status)}</div>
          </div>
          <div class="miniRight">${escapeHtml(it.time)}</div>
        `;
        lastList.appendChild(el);
      }
    }
    renderRecent();

    function pushRecent(item){
      recent.unshift(item);
      if (recent.length > 5) recent.pop();
      renderRecent();
    }

    function extractDni(text){
      const s = (text || "").toString();
      const m = s.match(/(\d{8})/);
      if (m) return m[1];

      const digits = s.replace(/\D/g,"");
      if (digits.length === 7) return digits.padStart(8,"0");
      if (digits.length === 8) return digits;
      if (digits.length > 8) return digits.slice(-8);
      return "";
    }

    // ===========================
    // C√°mara
    // ===========================
    async function ensureCameraPermissionOnce(){
      try{
        const tmp = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
        tmp.getTracks().forEach(t => t.stop());
      }catch(e){}
    }

    async function loadCameras(){
      await ensureCameraPermissionOnce();
      const devices = await navigator.mediaDevices.enumerateDevices();
      cameras = devices.filter(d => d.kind === "videoinput");
      if (!cameras.length) throw new Error("No hay c√°maras disponibles");

      const backIdx = cameras.findIndex(c => /back|rear|environment|trasera/i.test(c.label || ""));
      camIndex = backIdx >= 0 ? backIdx : 0;
    }

    function currentCameraLabel(){
      const d = cameras[camIndex];
      if (!d) return "‚Äî";
      return (d.label && d.label.trim()) ? d.label : `C√°mara ${camIndex+1}/${cameras.length}`;
    }

    function setupDetector(){
      if ("BarcodeDetector" in window){
        try{
          detector = new BarcodeDetector({
            formats: ["qr_code","code_128","code_39","ean_13","ean_8","itf","upc_a","upc_e"]
          });
        }catch(e){
          detector = null;
        }
      } else detector = null;

      if (!zxingReader && typeof ZXingBrowser !== "undefined"){
        zxingReader = new ZXingBrowser.BrowserMultiFormatReader();
      }
    }

    async function setupZoom(track){
      try{
        const caps = track.getCapabilities ? track.getCapabilities() : null;
        if (!caps || !caps.zoom){
          zoomBox.classList.add("hidden");
          return;
        }

        const min = caps.zoom.min ?? 1;
        const max = caps.zoom.max ?? 3;
        const step = caps.zoom.step ?? 0.1;

        zoomRange.min = min;
        zoomRange.max = max;
        zoomRange.step = step;

        const start = Math.min(Math.max(1, min), max);
        zoomRange.value = start;
        zoomVal.textContent = parseFloat(start).toFixed(1) + "x";
        zoomBox.classList.remove("hidden");

        zoomRange.oninput = async () => {
          const z = parseFloat(zoomRange.value);
          zoomVal.textContent = z.toFixed(1) + "x";
          try{ await track.applyConstraints({ advanced:[{ zoom:z }] }); }catch(e){}
        };
      }catch(e){
        zoomBox.classList.add("hidden");
      }
    }

    async function setupTorch(track){
      try{
        const caps = track.getCapabilities ? track.getCapabilities() : null;
        if (!caps || !caps.torch){
          btnTorch.classList.add("hidden");
          return;
        }
        btnTorch.classList.remove("hidden");
      }catch(e){
        btnTorch.classList.add("hidden");
      }
    }

    async function toggleTorch(){
      if (!track) return;
      try{
        torchOn = !torchOn;
        await track.applyConstraints({ advanced:[{ torch: torchOn }] });
        btnTorch.textContent = torchOn ? "üî¶ Linterna ON" : "üî¶ Linterna";
      }catch(e){
        btnTorch.classList.add("hidden");
      }
    }

    // ROI adaptado a video real
    function roiQR(){
      const vw = videoEl.videoWidth || 1280;
      const vh = videoEl.videoHeight || 720;
      const size = Math.floor(Math.min(vw, vh) * 0.52);
      return {
        sx: Math.floor((vw - size)/2),
        sy: Math.floor((vh - size)/2),
        sw: size,
        sh: size
      };
    }

    function roiBAR(){
      const vw = videoEl.videoWidth || 1280;
      const vh = videoEl.videoHeight || 720;
      const sw = Math.floor(vw * 0.84);
      const sh = Math.floor(vh * 0.22);
      return {
        sx: Math.floor((vw - sw)/2),
        sy: Math.floor((vh - sh)/2),
        sw, sh
      };
    }

    // ===========================
    // API registrar DNI
    // ===========================
    async function registrarDni(dni){
      if (busy) return;
      busy = true;

      setDetectedFlash();
      setChip("run","Registrando‚Ä¶");
      setMsg("Enviando‚Ä¶");

      const now = new Date();
      const timeStr = now.toLocaleTimeString();

      try{
        const res = await fetch("{% url 'api_scan_asistencia' %}", {
          method: "POST",
          credentials: "same-origin",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken,
            "X-Requested-With": "XMLHttpRequest"
          },
          body: JSON.stringify({ code: dni })
        });

        if (res.status === 401 || res.status === 403){
          setChip("bad","Sesi√≥n");
          setMsg("Sesi√≥n vencida. Inicia sesi√≥n otra vez.");
          beepBad(); vibBad();
          stopCamera(true);
          showToast("bad", { name:"Sesi√≥n vencida", codigo:"‚Äî", condicion:"‚Äî", dni:dni, estado:"LOGIN" });
          return;
        }

        const ct = res.headers.get("content-type") || "";
        if (!ct.includes("application/json")){
          const text = await res.text();
          console.log("RESPUESTA NO JSON:", text);

          setChip("bad","Error");
          setMsg("Servidor no devolvi√≥ JSON (CSRF/login/500).");
          beepBad(); vibBad();

          showToast("bad", { name:"Error servidor", codigo:"‚Äî", condicion:"‚Äî", dni:dni, estado:"NO JSON" });
          pushRecent({ name:"Error servidor", cod:"‚Äî", cond:"‚Äî", dni:dni, status:"ERROR", time: timeStr });
          return;
        }

        const data = await res.json();
        lastText.textContent = `${dni} ‚Ä¢ ${timeStr}`;
        kpiBackendEl.textContent = (location.hostname.includes("127.0.0.1") || location.hostname.includes("localhost")) ? "Local" : "Remoto";

        const prof = data.profesor || {};
        const fullName = ((prof.apellidos || "") + " " + (prof.nombres || "")).trim();

        const item = {
          name: fullName || "‚Äî",
          cod: prof.codigo || "‚Äî",
          cond: prof.condicion || "‚Äî",
          dni: prof.dni || dni,
          time: timeStr,
          status: "‚Äî"
        };

        if (res.ok && data.ok){
          if (data.duplicado){
            setChip("warn","Duplicado");
            setMsg(data.msg || "Ya registr√≥ hoy.");
            beepWarn(); vibWarn();

            item.status = "DUPLICADO";
            showToast("warn", { ...item, codigo:item.cod, condicion:item.cond, estado:"DUPLICADO", dni:item.dni });
          } else {
            setChip("ok","OK");
            setMsg(data.msg || "‚úÖ ENTRADA registrada.");
            beepOk(); vibOk();

            item.status = "ENTRADA";
            scansToday += 1;
            updateScansTodayUI();

            showToast("ok", { ...item, codigo:item.cod, condicion:item.cond, estado:"ENTRADA", dni:item.dni });
          }
          pushRecent(item);
        } else {
          setChip("bad","Fall√≥");
          setMsg(data.msg || "No se pudo registrar.");
          beepBad(); vibBad();

          item.status = "ERROR";
          showToast("bad", { ...item, codigo:item.cod, condicion:item.cond, estado:"ERROR", dni:item.dni });
          pushRecent(item);
        }

      }catch(e){
        console.error(e);
        setChip("bad","Sin red");
        setMsg("Error de red.");
        beepBad(); vibBad();

        showToast("bad", { name:"Sin red", codigo:"‚Äî", condicion:"‚Äî", dni:dni, estado:"RED" });
        pushRecent({ name:"Sin red", cod:"‚Äî", cond:"‚Äî", dni:dni, status:"ERROR", time: timeStr });
      }finally{
        cooldownUntil = Date.now() + COOLDOWN_MS;

        setTimeout(() => {
          busy = false;
          if (running){
            setChip("run","Escaneando‚Ä¶");
            setMsg("Listo. Escanea el siguiente‚Ä¶");
          }
        }, MESSAGE_MS);
      }
    }

    // ===========================
    // Detecci√≥n
    // ===========================
    async function detectInROI(roi){
      canvas.width = roi.sw;
      canvas.height = roi.sh;

      try{
        ctx.drawImage(videoEl, roi.sx, roi.sy, roi.sw, roi.sh, 0, 0, roi.sw, roi.sh);
      }catch(e){
        return null;
      }

      if (detector){
        try{
          const bitmap = await createImageBitmap(canvas);
          const codes = await detector.detect(bitmap);
          bitmap.close?.();
          if (codes && codes.length) return codes[0].rawValue || "";
        }catch(e){}
      }

      if (!detector && zxingReader && zxingReader.decodeOnceFromVideoElement){
        try{
          const result = await zxingReader.decodeOnceFromVideoElement(videoEl);
          return result?.getText ? result.getText() : null;
        }catch(e){}
      }

      return null;
    }

    async function scanLoop(){
      if (!running) return;

      const now = Date.now();
      if (now < cooldownUntil){
        loopTimer = setTimeout(scanLoop, LOOP_MS);
        return;
      }

      if (!busy){
        let raw = await detectInROI(roiQR());
        if (!raw) raw = await detectInROI(roiBAR());

        if (raw){
          const dni = extractDni(raw);
          const t = Date.now();
          const key = (dni || raw).slice(0, 40);

          if (dni && dni.length === 8 && (key !== lastKey || (t - lastTs) > 1400)){
            lastKey = key;
            lastTs = t;
            registrarDni(dni);
          }
        }
      }

      loopTimer = setTimeout(scanLoop, LOOP_MS);
    }

    // ===========================
    // Start / Stop camera
    // ===========================
    async function startCamera(){
      stopCamera(true);

      ensureAudioCtx();
      try{ if (audioCtx.state === "suspended") await audioCtx.resume(); }catch(e){}

      if (!window.isSecureContext && !/^(localhost|127\.0\.0\.1)$/.test(location.hostname)){
        setChip("bad","HTTPS");
        setMsg("La c√°mara requiere HTTPS (o localhost).");
        return;
      }

      try{
        setChip("run","Iniciando‚Ä¶");
        setMsg("Abriendo c√°mara‚Ä¶");

        if (!cameras.length) await loadCameras();
        const chosenId = cameras[camIndex]?.deviceId;

        const constraints = {
          video: {
            deviceId: chosenId ? { ideal: chosenId } : undefined,
            width:  { ideal: 1920 },
            height: { ideal: 1080 },
            facingMode: { ideal: "environment" }
          },
          audio: false
        };

        try{
          stream = await navigator.mediaDevices.getUserMedia(constraints);
        }catch(e){
          try{
            stream = await navigator.mediaDevices.getUserMedia({
              video: {
                facingMode: { ideal: "environment" },
                width: { ideal:1920 },
                height:{ ideal:1080 }
              },
              audio: false
            });
          }catch(e2){
            stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
          }
        }

        videoEl.srcObject = stream;
        await new Promise((r) => {
          videoEl.onloadedmetadata = () => r();
        });

        try { await videoEl.play(); } catch(e){}

        overlayEl.style.display = "flex";

        track = stream.getVideoTracks()[0];
        camText.textContent = currentCameraLabel();

        setupDetector();
        await setupZoom(track);
        await setupTorch(track);

        running = true;
        btnStop.disabled = false;

        setChip("run","Escaneando‚Ä¶");
        setMsg("QR o Barras: coloca el c√≥digo en el recuadro.");
        cooldownUntil = 0;
        busy = false;

        scanLoop();

      }catch(e){
        console.error(e);
        const name = e?.name || "Error";
        running = false;
        btnStop.disabled = true;

        if (name === "NotAllowedError"){
          setChip("bad","Permiso");
          setMsg("Permiso denegado. Habilita la c√°mara.");
        } else if (name === "NotFoundError"){
          setChip("bad","Sin c√°mara");
          setMsg("No se encontr√≥ c√°mara.");
        } else if (name === "NotReadableError"){
          setChip("bad","Ocupada");
          setMsg("C√°mara ocupada por otra app.");
        } else {
          setChip("bad","Error");
          setMsg(`No se pudo abrir: ${name}`);
        }

        beepBad(); vibBad();
      }
    }

    function stopCamera(silent=false){
      running = false;
      busy = false;
      cooldownUntil = 0;

      if (loopTimer) clearTimeout(loopTimer);
      loopTimer = null;

      try{ zxingReader?.reset?.(); }catch(e){}
      zxingReader = null;
      detector = null;

      clearTimeout(detectedFlashTimer);
      overlayGrid?.classList.remove("detected");

      torchOn = false;
      btnTorch.textContent = "üî¶ Linterna";
      btnTorch.classList.add("hidden");

      zoomBox.classList.add("hidden");
      zoomRange.oninput = null;

      if (stream){
        stream.getTracks().forEach(t => t.stop());
      }
      stream = null;
      track = null;

      videoEl.srcObject = null;
      overlayEl.style.display = "none";

      btnStop.disabled = true;

      if (!silent){
        setChip("", "Detenido");
        setMsg("C√°mara detenida.");
      }
    }

    // ===========================
    // Eventos
    // ===========================
    btnStop.addEventListener("click", () => stopCamera(false));

    btnFlip.addEventListener("click", async () => {
      try{
        setChip("run","Cambiando‚Ä¶");
        setMsg("Cambiando c√°mara‚Ä¶");

        if (!cameras.length) await loadCameras();
        camIndex = (camIndex + 1) % cameras.length;
        await startCamera();
      }catch(e){
        console.error(e);
        setChip("bad","Error");
        setMsg("No se pudo cambiar c√°mara. Revisa permisos/HTTPS.");
        beepBad(); vibBad();
      }
    });

    btnTorch.addEventListener("click", toggleTorch);

    document.addEventListener("visibilitychange", () => {
      if (document.hidden){
        if (loopTimer) clearTimeout(loopTimer);
        loopTimer = null;
      } else {
        if (running && !loopTimer) scanLoop();
      }
    });

    window.addEventListener("load", () => {
      ensureAudioCtx();
      updateScansTodayUI();
      sessionStartedAt = Date.now();
      startCamera();
    });
  </script>
</body>
</html>