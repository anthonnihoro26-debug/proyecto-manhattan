{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Acceso Institucional - Proyecto Manhattan</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <style>
    :root{
      color-scheme: dark light;

      --bg1:#06101f;
      --bg2:#0a1730;
      --bg3:#0a1222;
      --grid: rgba(255,255,255,.07);
      --orb1: rgba(59,130,246,.18);
      --orb2: rgba(99,102,241,.16);
      --orb3: rgba(37,99,235,.12);

      --hero-border: rgba(255,255,255,.12);
      --hero-bg: rgba(255,255,255,.03);
      --hero-panel: rgba(255,255,255,.04);
      --hero-text: rgba(255,255,255,.80);
      --hero-muted: rgba(255,255,255,.72);
      --hero-badge-border: rgba(255,255,255,.14);
      --hero-badge-bg: rgba(255,255,255,.05);

      --panel:#ffffff;
      --panel-soft:#f8fafc;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;

      --primary:#1d4ed8;
      --primary2:#4338ca;

      --shadow-xl: 0 30px 75px rgba(2,6,23,.34);
      --overlay-bg: rgba(2,6,23,.55);
      --overlay-box: rgba(255,255,255,.98);

      --noise-opacity:.03;
    }

    @media (prefers-color-scheme: light){
      :root{
        --bg1:#eef4ff;
        --bg2:#e8f0ff;
        --bg3:#edf3ff;
        --grid: rgba(15,23,42,.06);
        --orb1: rgba(59,130,246,.14);
        --orb2: rgba(99,102,241,.12);
        --orb3: rgba(37,99,235,.10);

        --hero-border: rgba(148,163,184,.20);
        --hero-bg: rgba(255,255,255,.65);
        --hero-panel: rgba(255,255,255,.55);
        --hero-text: rgba(15,23,42,.82);
        --hero-muted: rgba(51,65,85,.72);
        --hero-badge-border: rgba(148,163,184,.26);
        --hero-badge-bg: rgba(255,255,255,.70);

        --panel:#ffffff;
        --panel-soft:#f8fafc;
        --ink:#0f172a;
        --muted:#64748b;
        --line:#dbe3ee;

        --shadow-xl: 0 28px 65px rgba(37,99,235,.14);

        --overlay-bg: rgba(15,23,42,.25);
        --overlay-box: rgba(255,255,255,.98);

        --noise-opacity:.02;
      }
    }

    *{ box-sizing:border-box; }
    html, body{ margin:0; min-height:100%; }

    body{
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      color: #fff;
      background:
        radial-gradient(1000px 620px at 10% 10%, var(--orb1), transparent 60%),
        radial-gradient(900px 560px at 92% 10%, var(--orb2), transparent 60%),
        radial-gradient(780px 480px at 50% 100%, var(--orb3), transparent 62%),
        linear-gradient(180deg, var(--bg1), var(--bg2) 56%, var(--bg3));
      overflow-x:hidden;
      position:relative;
    }

    .grid-bg{
      position:fixed;
      inset:0;
      pointer-events:none;
      opacity:.06; /* antes .10 */
      background-image:
        linear-gradient(var(--grid) 1px, transparent 1px),
        linear-gradient(90deg, var(--grid) 1px, transparent 1px);
      background-size: 28px 28px;
      mask-image: radial-gradient(circle at center, black 42%, transparent 100%);
      -webkit-mask-image: radial-gradient(circle at center, black 42%, transparent 100%);
      z-index:0;
    }

    .noise{
      position:fixed; inset:0; pointer-events:none;
      opacity: calc(var(--noise-opacity) * 0.6); /* más suave */
      background-image: radial-gradient(#fff .7px, transparent .7px);
      background-size: 8px 8px;
      z-index:0;
    }

    .orb{
      position:fixed;
      border-radius:50%;
      filter: blur(28px);
      pointer-events:none;
      z-index:0;
      animation: floatOrb 11s ease-in-out infinite;
    }
    .orb-1{ width:230px;height:230px; left:-60px; top:110px; background:#3b82f6; opacity:.15; }
    .orb-2{ width:260px;height:260px; right:-80px; top:70px; background:#6366f1; opacity:.14; animation-delay:-2.6s; }
    .orb-3{ width:180px;height:180px; right:18%; bottom:10%; background:#2563eb; opacity:.12; animation-delay:-4.4s; }

    @keyframes floatOrb{
      0%,100%{ transform: translateY(0) translateX(0) scale(1); }
      50%{ transform: translateY(-12px) translateX(9px) scale(1.04); }
    }

    /* ✅ CANVAS ARRIBA DE ADORNOS, DEBAJO DEL LOGIN */
 #particles{
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 999;   /* temporal alto para comprobar */
  opacity: 1;
}

    .wrap{
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 18px;
      position: relative;
      z-index: 6; /* contenido por encima */
    }

    .layout{
      width:min(1120px, 97vw);
      display:grid;
      grid-template-columns: 1.06fr .94fr;
      gap:14px;
      align-items:stretch;
    }

    /* HERO */
    .hero{
      border-radius: 22px;
      border:1px solid var(--hero-border);
      background:
        linear-gradient(180deg, var(--hero-bg), rgba(255,255,255,.01)),
        radial-gradient(720px 420px at 18% 10%, rgba(59,130,246,.14), transparent 65%);
      box-shadow: var(--shadow-xl);
      padding: 20px;
      position:relative;
      overflow:hidden;
      opacity:0;
      transform: translateY(12px);
      animation: fadeUp .58s ease .04s forwards;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }

    .hero::before{
      content:"";
      position:absolute;
      width:260px; height:260px; border-radius:50%;
      right:-70px; bottom:-70px;
      background: radial-gradient(circle, rgba(99,102,241,.16), transparent 70%);
      filter: blur(6px);
      pointer-events:none;
    }

    .badge-uni{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 12px;
      border-radius:999px;
      border:1px solid var(--hero-badge-border);
      background: var(--hero-badge-bg);
      color: var(--hero-text);
      font-weight:900;
      font-size:12px;
      letter-spacing:.15px;
    }

    .badge-uni i{ color:#93c5fd; }

    .hero h1{
      margin:12px 0 0;
      font-size:28px;
      line-height:1.05;
      letter-spacing:-.8px;
      font-weight:950;
      color: #fff;
    }

    @media (prefers-color-scheme: light){
      .hero h1{ color:#0f172a; }
    }

    .hero .accent{
      background: linear-gradient(90deg, #bfdbfe, #c7d2fe, #93c5fd);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }

    .hero p{
      margin:10px 0 0;
      max-width: 56ch;
      color: var(--hero-text);
      font-weight:700;
      line-height:1.44;
      font-size:13px;
    }

    .feature-list{
      margin-top:14px;
      display:grid;
      gap:8px;
    }

    .feature{
      display:flex;
      gap:9px;
      align-items:flex-start;
      padding:8px 9px;
      border-radius:13px;
      border:1px solid var(--hero-border);
      background: var(--hero-panel);
      transition: transform .15s ease, border-color .15s ease, background .15s ease;
      animation: itemFade .35s ease both;
    }
    .feature:nth-child(1){ animation-delay:.12s; }
    .feature:nth-child(2){ animation-delay:.17s; }
    .feature:nth-child(3){ animation-delay:.22s; }

    .feature:hover{
      transform: translateY(-1px);
      border-color: rgba(191,219,254,.25);
      background: rgba(255,255,255,.05);
    }

    .feature i{
      width:26px;height:26px;border-radius:8px;
      display:grid;place-items:center;
      background: rgba(59,130,246,.15);
      color:#bfdbfe;
      border:1px solid rgba(191,219,254,.16);
      flex:0 0 auto;
      font-size:12px;
      margin-top:1px;
    }

    .feature b{
      display:block;
      font-size:12px;
      line-height:1.15;
      color: #fff;
      font-weight:900;
    }

    @media (prefers-color-scheme: light){
      .feature b{ color:#0f172a; }
      .feature i{ color:#2563eb; background:rgba(37,99,235,.08); border-color:rgba(37,99,235,.10); }
      .feature:hover{ background: rgba(255,255,255,.75); }
    }

    .feature span{
      display:block;
      margin-top:2px;
      font-size:11px;
      color: var(--hero-muted);
      font-weight:700;
      line-height:1.2;
    }

    .stats{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:7px;
    }

    .stat{
      border-radius:13px;
      border:1px solid var(--hero-border);
      background: var(--hero-panel);
      padding:8px 9px;
      transition: transform .14s ease, border-color .14s ease;
      animation: itemFade .35s ease both;
    }
    .stat:nth-child(1){ animation-delay:.26s; }
    .stat:nth-child(2){ animation-delay:.30s; }
    .stat:nth-child(3){ animation-delay:.34s; }

    .stat:hover{
      transform: translateY(-1px);
      border-color: rgba(191,219,254,.22);
    }

    .stat .n{
      font-size:15px;
      line-height:1;
      font-weight:950;
      color:#fff;
      letter-spacing:-.3px;
    }
    .stat .t{
      margin-top:3px;
      font-size:10.5px;
      line-height:1.12;
      color: var(--hero-muted);
      font-weight:800;
    }

    @media (prefers-color-scheme: light){
      .stat .n{ color:#0f172a; }
    }

    /* LOGIN CARD */
    .login-card{
      background: var(--panel);
      color: var(--ink);
      border-radius: 22px;
      box-shadow: var(--shadow-xl);
      border:1px solid rgba(255,255,255,.22);
      overflow:hidden;
      min-width:0;
      position:relative;
      opacity:0;
      transform: translateY(15px) scale(.99);
      animation: popCard .62s cubic-bezier(.2,.8,.2,1) .08s forwards;
    }

    .login-card::before{
      content:"";
      position:absolute;
      inset:0 0 auto 0;
      height:3px;
      background: linear-gradient(90deg, var(--primary), var(--primary2), var(--primary));
      opacity:.95;
      z-index:2;
    }

    .login-head{
      padding: 15px 16px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, #ffffff, #f8fafc);
      display:flex;
      align-items:center;
      gap:12px;
      position:relative;
      z-index:1;
    }

    .seal{
      width:62px;
      height:62px;
      border-radius:16px;
      display:grid;
      place-items:center;
      background:#fff;
      border:1px solid #e5e7eb;
      box-shadow: 0 10px 22px rgba(15,23,42,.08);
      flex:0 0 auto;
      padding:6px;
      overflow:hidden;
      position:relative;
    }

    .seal::after{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(135deg, rgba(59,130,246,.03), rgba(99,102,241,.03));
      pointer-events:none;
    }

    .seal img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      position:relative;
      z-index:1;
    }

    .head-text h2{
      margin:0;
      font-size:15px;
      line-height:1.15;
      font-weight:950;
      letter-spacing:-.2px;
      color:#0f172a;
    }

    .head-text p{
      margin:4px 0 0;
      color:#64748b;
      font-size:12px;
      line-height:1.2;
      font-weight:700;
    }

    .login-body{
      padding: 16px;
      position:relative;
      z-index:1;
    }

    .title{
      margin:1px 0 2px;
      font-size:19px;
      line-height:1.12;
      letter-spacing:-.4px;
      color:#0f172a;
      font-weight:950;
    }

    .subtitle{
      margin:0 0 12px;
      color:#64748b;
      font-size:12px;
      line-height:1.35;
      font-weight:700;
    }

    .welcome-chip{
      display:none;
      margin: 2px 0 10px;
      padding: 8px 10px;
      border-radius: 12px;
      border:1px solid #dbeafe;
      background: linear-gradient(180deg, #eff6ff, #f8fbff);
      color:#1e3a8a;
      font-size:12px;
      font-weight:800;
      align-items:center;
      gap:8px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.7);
    }
    .welcome-chip.show{ display:flex; }

    .welcome-chip i{
      width:22px; height:22px; border-radius:8px;
      display:grid; place-items:center;
      background:#dbeafe;
      color:#1d4ed8;
      flex:0 0 auto;
      font-size:12px;
    }
    .welcome-chip .line1{ display:block; line-height:1.15; font-weight:900; }
    .welcome-chip .line2{ display:block; margin-top:2px; line-height:1.2; font-weight:700; color:#475569; font-size:11px; }

    .label{
      font-size:13px;
      font-weight:900;
      color:#334155;
      margin-bottom:6px;
    }

    .field-wrap{ border-radius:14px; transition: box-shadow .15s ease; }
    .field-wrap:focus-within{ box-shadow: 0 0 0 .25rem rgba(59,130,246,.10); }

    .field-wrap:focus-within .input-group-text,
    .field-wrap:focus-within .form-control,
    .field-wrap:focus-within .toggle-pass{
      border-color:#93c5fd !important;
    }

    .input-group{ border-radius:14px; overflow:hidden; }

    .input-group-text{
      border-radius:0 !important;
      background:#f8fafc;
      border:1px solid #dbe3ee;
      border-right:0;
      color:#475569;
      min-width:46px;
      display:flex;
      justify-content:center;
      font-size:14px;
    }

    .form-control{
      border-radius:0 !important;
      border:1px solid #dbe3ee;
      background:#fff;
      color:#0f172a;
      font-weight:800;
      padding:12px 12px;
      font-size:14px;
      min-width:0;
      box-shadow:none;
    }

    .form-control::placeholder{ color:#94a3b8; font-weight:700; }
    .form-control:focus{ border-color:#93c5fd; box-shadow:none; background:#fff; }

    .toggle-pass{
      border-radius:0 !important;
      border:1px solid #dbe3ee;
      border-left:0;
      background:#f8fafc;
      color:#475569;
      font-weight:900;
      padding:0 12px;
      min-width:50px;
      transition: background .12s ease, color .12s ease;
    }
    .toggle-pass:hover{ background:#eff6ff; color:#1d4ed8; }

    .alert{
      border-radius:14px;
      font-weight:800;
      font-size:13px;
      margin-bottom:10px;
      border-width:1px;
    }
    .alert-warning{ background:#fffbeb; border-color:#fde68a; color:#92400e; }
    .alert-danger{ background:#fef2f2; border-color:#fecaca; color:#991b1b; }

    .btnx{
      width:100%;
      border:0;
      border-radius:14px;
      padding:12px 14px;
      font-weight:900;
      font-size:15px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      position:relative;
      overflow:hidden;
      isolation:isolate;
      transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
      user-select:none;
    }

    .btnx-primary{
      color:#fff;
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      box-shadow: 0 14px 28px rgba(37,99,235,.24), inset 0 1px 0 rgba(255,255,255,.12);
    }

    .btnx-primary::before{
      content:"";
      position:absolute;
      inset:-25% -70%;
      background: linear-gradient(110deg,
        transparent 35%,
        rgba(255,255,255,.10) 43%,
        rgba(255,255,255,.34) 50%,
        rgba(255,255,255,.10) 57%,
        transparent 65%);
      transform: translateX(-120%) skewX(-14deg);
      animation: shimmer 2.8s ease-in-out infinite;
      z-index:0;
      pointer-events:none;
    }

    .btnx::after{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(120px 40px at 20% 0%, rgba(255,255,255,.12), transparent 65%);
      z-index:0;
      pointer-events:none;
    }

    .btnx > *{ position:relative; z-index:1; }

    .btnx-primary:hover{
      transform: translateY(-1px);
      box-shadow: 0 18px 34px rgba(37,99,235,.28), inset 0 1px 0 rgba(255,255,255,.14);
    }
    .btnx-primary:active{ transform: translateY(1px); }

    .btnx[disabled]{
      opacity:.7;
      cursor:not-allowed;
      transform:none !important;
      box-shadow:none !important;
    }
    .btnx[disabled]::before{ animation-play-state: paused; opacity:.15; }

    .btn-spinner{
      width:17px;height:17px;border-radius:50%;
      border:2px solid rgba(255,255,255,.35);
      border-top-color:#fff;
      display:none;
      animation: spin .75s linear infinite;
    }
    .btnx.loading .btn-spinner{ display:inline-block; }
    .btnx.loading .btn-icon{ display:none; }

    .helper{
      margin-top:10px;
      text-align:center;
      font-size:12px;
      color:#64748b;
      font-weight:700;
      line-height:1.35;
    }
    .helper b{ color:#334155; }

    /* Overlay loader */
    .login-overlay{
      position:fixed;
      inset:0;
      z-index:9999;
      background: var(--overlay-bg);
      backdrop-filter: blur(8px) saturate(1.05);
      -webkit-backdrop-filter: blur(8px) saturate(1.05);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .login-overlay.show{ display:flex; animation: fadeIn .16s ease; }

    .overlay-box{
      width:min(440px, 95vw);
      border-radius:18px;
      background: var(--overlay-box);
      color:#0f172a;
      border:1px solid #e5e7eb;
      box-shadow: 0 28px 80px rgba(2,6,23,.36);
      padding:15px;
      position:relative;
      overflow:hidden;
      animation: overlayPop .22s ease;
    }

    .overlay-box::before{
      content:"";
      position:absolute;
      inset:0 0 auto 0;
      height:3px;
      background: linear-gradient(90deg, #2563eb, #4f46e5, #2563eb);
    }

    .overlay-top{ display:flex; align-items:center; gap:12px; margin-bottom:10px; }

    .ov-logo-wrap{
      width:52px; height:52px; flex:0 0 auto; position:relative; display:grid; place-items:center;
    }
    .ov-ring{
      position:absolute; inset:0; border-radius:50%;
      border:3px solid rgba(59,130,246,.12);
      border-top-color:#2563eb;
      border-right-color:#4f46e5;
      animation: spin .95s linear infinite;
    }
    .ov-ring2{
      position:absolute; inset:6px; border-radius:50%;
      border:2px dashed rgba(79,70,229,.22);
      animation: spinReverse 4.2s linear infinite;
    }
    .ov-logo-core{
      width:34px; height:34px; border-radius:12px; background:#fff; border:1px solid #dbe3ee;
      box-shadow: 0 8px 16px rgba(15,23,42,.08);
      display:grid; place-items:center; padding:4px; position:relative; z-index:2;
      animation: logoPulse 1.8s ease-in-out infinite;
    }
    .ov-logo-core img{
      width:100%; height:100%; object-fit:contain; display:block;
      animation: logoFloat 1.9s ease-in-out infinite;
    }
    .ov-pulse{
      position:absolute; inset:-4px; border-radius:50%;
      border:2px solid rgba(59,130,246,.14);
      animation: pulse 1.5s ease-out infinite;
    }

    .ov-title{ margin:0; font-size:14px; font-weight:950; line-height:1.15; }
    .ov-sub{ margin:3px 0 0; font-size:12px; color:#64748b; font-weight:700; }
    .ov-meta{ display:flex; align-items:center; justify-content:space-between; gap:12px; font-size:12px; font-weight:800; color:#475569; margin-bottom:7px; }

    .ov-track{
      width:100%; height:9px; border-radius:999px; background:#eef2f7; border:1px solid #e2e8f0; overflow:hidden; position:relative;
    }
    .ov-bar{
      width:0%; height:100%; border-radius:999px;
      background: linear-gradient(90deg, #2563eb, #4f46e5);
      transition: width .16s ease;
      box-shadow: 0 4px 14px rgba(37,99,235,.25);
      position:relative;
    }
    .ov-bar::after{
      content:""; position:absolute; top:0; right:-18px; width:18px; height:100%;
      background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.55), rgba(255,255,255,0));
    }

    .ov-status-row{
      margin-top:10px; display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;
    }
    .ov-pill{
      display:inline-flex; align-items:center; gap:6px; padding:5px 9px; border-radius:999px;
      font-size:11px; font-weight:800; border:1px solid #dbe3ee; background:#f8fafc; color:#334155;
    }
    .ov-pill i{ color:#2563eb; }
    .ov-time{ font-size:11px; font-weight:800; color:#64748b; }
    .ov-foot{ margin-top:8px; font-size:11px; color:#64748b; font-weight:700; text-align:center; }

    /* Adornos universitarios */
   .uni-fx{
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 2;
  overflow: hidden;
}

    .uni-ring{
      position:absolute;
      border-radius:50%;
      border:1px dashed rgba(191,219,254,.22);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
      opacity:.85;
      animation: ringDrift 18s linear infinite;
      filter: blur(.1px);
    }
    .uni-ring::before{
      content:"";
      position:absolute;
      inset:10%;
      border-radius:50%;
      border:1px solid rgba(191,219,254,.14);
    }
    .uni-ring::after{
      content:"";
      position:absolute;
      inset:22%;
      border-radius:50%;
      border:1px dashed rgba(99,102,241,.16);
    }

    .ring-a{ width: 260px; height: 260px; left: 3.5%; top: 16%; animation-duration: 22s; }
    .ring-b{ width: 210px; height: 210px; right: 4%; top: 58%; animation-duration: 18s; animation-direction: reverse; }
    .ring-c{ width: 170px; height: 170px; right: 18%; top: 12%; animation-duration: 15s; }

    .uni-track{
      position:absolute;
      height:2px;
      width: 36vw;
      max-width: 460px;
      background: linear-gradient(90deg,
        rgba(191,219,254,0),
        rgba(191,219,254,.22),
        rgba(99,102,241,.35),
        rgba(191,219,254,.18),
        rgba(191,219,254,0));
      opacity:.9;
      filter: blur(.15px);
    }
    .uni-track::before{
      content:"";
      position:absolute;
      top:-2px;
      right:18%;
      width:12px; height:6px;
      border-radius:999px;
      background: rgba(191,219,254,.55);
      box-shadow: 0 0 16px rgba(147,197,253,.35);
    }

    .track-1{ top: 10%; left: -18%; transform: rotate(8deg); animation: slideTrackA 14s linear infinite; }
    .track-2{ top: 82%; right: -20%; transform: rotate(-10deg); animation: slideTrackB 16s linear infinite; }
    .track-3{
      top: 36%;
      left: -22%;
      transform: rotate(3deg);
      width: 28vw;
      animation: slideTrackA 19s linear infinite reverse;
      opacity:.72;
    }

    .uni-icon{
      position:absolute;
      width:34px;
      height:34px;
      border-radius:12px;
      display:grid;
      place-items:center;
      border:1px solid rgba(191,219,254,.20);
      background: rgba(255,255,255,.04);
      color: rgba(191,219,254,.70);
      backdrop-filter: blur(3px);
      -webkit-backdrop-filter: blur(3px);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
      animation: iconFloat 10s ease-in-out infinite;
      font-size:14px;
      opacity:.9;
    }

    .i-1{ left: 4%; top: 22%; animation-delay: -1s; }
    .i-2{ right: 6%; top: 16%; animation-delay: -2.8s; }
    .i-3{ right: 7%; top: 84%; animation-delay: -4.2s; }
    .i-4{ left: 10%; top: 82%; animation-delay: -5.5s; }

    @media (prefers-color-scheme: light){
      .uni-ring{
        border-color: rgba(37,99,235,.18);
        box-shadow: inset 0 0 0 1px rgba(255,255,255,.35);
        opacity:.68;
      }
      .uni-ring::before{ border-color: rgba(37,99,235,.12); }
      .uni-ring::after{ border-color: rgba(79,70,229,.12); }

      .uni-track{
        background: linear-gradient(90deg,
          rgba(37,99,235,0),
          rgba(37,99,235,.16),
          rgba(79,70,229,.24),
          rgba(37,99,235,.14),
          rgba(37,99,235,0));
        opacity:.72;
      }
      .uni-track::before{
        background: rgba(37,99,235,.34);
        box-shadow: 0 0 14px rgba(37,99,235,.24);
      }

      .uni-icon{
        color: rgba(37,99,235,.60);
        border-color: rgba(37,99,235,.16);
        background: rgba(255,255,255,.40);
        opacity:.82;
      }
    }

    /* Animaciones */
    @keyframes fadeUp{ to{ opacity:1; transform: translateY(0); } }

    @keyframes popCard{
      0%{ opacity:0; transform: translateY(15px) scale(.99); }
      68%{ opacity:1; transform: translateY(-2px) scale(1.002); }
      100%{ opacity:1; transform: translateY(0) scale(1); }
    }

    @keyframes overlayPop{
      from{ opacity:0; transform: translateY(6px) scale(.99); }
      to{ opacity:1; transform:none; }
    }

    @keyframes fadeIn{ from{ opacity:0; } to{ opacity:1; } }
    @keyframes pulse{ 0%{ transform:scale(.85); opacity:.55; } 70%,100%{ transform:scale(1.14); opacity:0; } }
    @keyframes shimmer{
      0%,18%{ transform: translateX(-120%) skewX(-14deg); opacity:.45; }
      36%{ transform: translateX(130%) skewX(-14deg); opacity:.95; }
      100%{ transform: translateX(130%) skewX(-14deg); opacity:0; }
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }
    @keyframes spinReverse{ to{ transform: rotate(-360deg); } }

    @keyframes logoPulse{
      0%,100%{ transform: scale(1); box-shadow: 0 8px 16px rgba(15,23,42,.08), 0 0 0 0 rgba(37,99,235,.10); }
      50%{ transform: scale(1.02); box-shadow: 0 10px 20px rgba(15,23,42,.10), 0 0 0 6px rgba(37,99,235,.05); }
    }
    @keyframes logoFloat{
      0%,100%{ transform: translateY(0) scale(1); }
      50%{ transform: translateY(-1px) scale(1.02); }
    }

    @keyframes itemFade{
      from{ opacity:0; transform: translateY(6px); }
      to{ opacity:1; transform:none; }
    }

    @keyframes ringDrift{
      0%   { transform: rotate(0deg) translateY(0px) scale(1); }
      25%  { transform: rotate(90deg) translateY(-4px) scale(1.01); }
      50%  { transform: rotate(180deg) translateY(0px) scale(1); }
      75%  { transform: rotate(270deg) translateY(4px) scale(.995); }
      100% { transform: rotate(360deg) translateY(0px) scale(1); }
    }

    @keyframes slideTrackA{
      0%   { transform: translateX(0) rotate(8deg); opacity:.18; }
      12%  { opacity:.80; }
      50%  { opacity:.72; }
      88%  { opacity:.80; }
      100% { transform: translateX(135vw) rotate(8deg); opacity:.08; }
    }

    @keyframes slideTrackB{
      0%   { transform: translateX(0) rotate(-10deg); opacity:.16; }
      15%  { opacity:.74; }
      65%  { opacity:.66; }
      100% { transform: translateX(-135vw) rotate(-10deg); opacity:.08; }
    }

    @keyframes iconFloat{
      0%,100%{ transform: translateY(0px) rotate(0deg); opacity:.80; }
      50%{ transform: translateY(-6px) rotate(2deg); opacity:.95; }
    }

    /* Responsive */
    @media (max-width: 1200px){
      .layout{
        width:min(1020px, 97vw);
        grid-template-columns: 1fr 1fr;
      }
      .hero h1{ font-size:26px; }
      .ring-a{ width:220px;height:220px; }
      .ring-b{ width:190px;height:190px; }
    }

    @media (max-width: 991.98px){
      .layout{
        grid-template-columns: 1fr;
        gap:12px;
        width:min(620px, 97vw);
      }

      .hero{ order:2; padding:18px; }
      .login-card{ order:1; }

      .hero h1{ font-size:23px; }
      .hero p{ font-size:13px; }
      .stats{ grid-template-columns: repeat(3, 1fr); }

      .login-head{ padding:13px 14px; }
      .seal{ width:54px; height:54px; border-radius:13px; padding:5px; }
      .head-text h2{ font-size:14px; }
      .head-text p{ font-size:11px; }
      .login-body{ padding:14px; }
      .title{ font-size:18px; }

      .uni-ring, .uni-track{ opacity:.55; }
      .uni-icon{ opacity:.75; }
      .ring-c{ display:none; }
    }

    @media (max-width: 575.98px){
      .wrap{ padding:10px; }
      .layout{ width:100%; gap:10px; }

      .hero{ padding:14px; border-radius:17px; }
      .badge-uni{ font-size:11px; padding:6px 10px; }

      .hero h1{ font-size:20px; line-height:1.08; letter-spacing:-.5px; }
      .hero p{ font-size:12px; line-height:1.42; }

      .feature{ padding:8px 9px; gap:8px; border-radius:12px; }
      .feature i{ width:24px; height:24px; border-radius:8px; font-size:12px; }
      .feature b{ font-size:12px; }
      .feature span{ font-size:11px; }

      .stats{ grid-template-columns:1fr; gap:7px; }
      .stat{ border-radius:12px; padding:9px; }

      .login-card{ border-radius:17px; }
      .login-head{ padding:12px; gap:10px; }
      .seal{ width:48px; height:48px; border-radius:11px; padding:4px; }
      .head-text h2{ font-size:13px; line-height:1.1; }
      .head-text p{ font-size:11px; }

      .login-body{ padding:12px; }
      .title{ font-size:16px; }
      .subtitle{ font-size:11px; }
      .label{ font-size:12px; }

      .welcome-chip{ padding:7px 9px; border-radius:11px; font-size:11px; }
      .welcome-chip i{ width:20px;height:20px;border-radius:7px;font-size:11px; }
      .welcome-chip .line2{ font-size:10px; }

      .input-group-text{ min-width:42px; }
      .form-control{ padding:11px 10px; font-size:14px; }
      .toggle-pass{ min-width:46px; padding:0 10px; }

      .btnx{ font-size:14px; padding:11px 12px; border-radius:12px; }
      .helper{ font-size:11px; }

      .overlay-box{ width:95vw; padding:12px; border-radius:15px; }
      .ov-title{ font-size:13px; }
      .ov-sub{ font-size:11px; }
      .ov-meta{ font-size:11px; }
      .ov-foot{ font-size:10px; }
      .ov-logo-wrap{ width:46px; height:46px; }
      .ov-logo-core{ width:30px; height:30px; border-radius:10px; }

      .uni-ring{ display:none; }
      .uni-track{ width:55vw; opacity:.35; }
      .uni-icon{
        width:28px;height:28px;font-size:12px;border-radius:10px;
        opacity:.45;
      }
      .i-4{ display:none; }
    }

    @media (prefers-reduced-motion: reduce){
      *, *::before, *::after{
        animation-duration:.001ms !important;
        animation-iteration-count:1 !important;
        transition-duration:.001ms !important;
        scroll-behavior:auto !important;
      }
      #particles, .uni-fx{ display:none; }
    }
  </style>
</head>
<body>
  <canvas id="particles" aria-hidden="true"></canvas>
  <div class="grid-bg"></div>
  <div class="noise"></div>
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="orb orb-3"></div>

  <div class="uni-fx" aria-hidden="true">
    <div class="uni-ring ring-a"></div>
    <div class="uni-ring ring-b"></div>
    <div class="uni-ring ring-c"></div>

    <div class="uni-track track-1"></div>
    <div class="uni-track track-2"></div>
    <div class="uni-track track-3"></div>

    <div class="uni-icon i-1"><i class="bi bi-mortarboard-fill"></i></div>
    <div class="uni-icon i-2"><i class="bi bi-building"></i></div>
    <div class="uni-icon i-3"><i class="bi bi-journal-code"></i></div>
    <div class="uni-icon i-4"><i class="bi bi-diagram-3-fill"></i></div>
  </div>

  <!-- Overlay Loader -->
  <div id="loginOverlay" class="login-overlay" aria-hidden="true">
    <div class="overlay-box" role="status" aria-live="polite">
      <div class="overlay-top">
        <div class="ov-logo-wrap">
          <div class="ov-pulse"></div>
          <div class="ov-ring"></div>
          <div class="ov-ring2"></div>
          <div class="ov-logo-core">
            <img src="{% static 'asistencias/img/uni_logo.png' %}" alt="Logo UNI">
          </div>
        </div>
        <div>
          <p id="overlayTitle" class="ov-title">Iniciando sesión...</p>
          <p id="overlaySub" class="ov-sub">Verificando usuario...</p>
        </div>
      </div>

      <div>
        <div class="ov-meta">
          <span id="overlayStepText">Procesando acceso</span>
          <span><span id="overlayPercent">0</span>%</span>
        </div>
        <div class="ov-track">
          <div id="overlayProgressBar" class="ov-bar"></div>
        </div>
      </div>

      <div class="ov-status-row">
        <span class="ov-pill"><i class="bi bi-shield-lock"></i> Conexión segura</span>
        <span id="overlayTime" class="ov-time">Preparando sesión...</span>
      </div>

      <div id="overlayFoot" class="ov-foot">Por favor espera un momento...</div>
    </div>
  </div>

  <div class="wrap">
    <div class="layout">
      <!-- PANEL HERO -->
      <section class="hero">
        <span class="badge-uni">
          <i class="bi bi-building"></i> Acceso Institucional UNI
        </span>

        <h1>
          Control de Asistencia<br>
          <span class="accent">Proyecto Manhattan</span>
        </h1>

        <p>
          Plataforma institucional para el registro, validación y consulta de asistencias docentes.
          Accede con tus credenciales para continuar de forma segura y rápida.
        </p>

        <div class="feature-list">
          <div class="feature">
            <i class="bi bi-shield-check"></i>
            <div>
              <b>Autenticación segura</b>
              <span>Control de acceso con validación de credenciales institucionales</span>
            </div>
          </div>

          <div class="feature">
            <i class="bi bi-qr-code-scan"></i>
            <div>
              <b>Escaneo QR</b>
              <span>Registro de asistencia ágil desde el módulo de escaneo</span>
            </div>
          </div>

          <div class="feature">
            <i class="bi bi-file-earmark-spreadsheet"></i>
            <div>
              <b>Reportes y exportación</b>
              <span>Historial, filtros y exportación de reportes en Excel</span>
            </div>
          </div>
        </div>

        <div class="stats">
          <div class="stat">
            <div class="n">24/7</div>
            <div class="t">Disponibilidad del sistema</div>
          </div>
          <div class="stat">
            <div class="n">QR</div>
            <div class="t">Registro rápido de asistencia</div>
          </div>
          <div class="stat">
            <div class="n">Excel</div>
            <div class="t">Exportación de reportes</div>
          </div>
        </div>
      </section>

      <!-- LOGIN CARD -->
      <section class="login-card">
        <div class="login-head">
          <div class="seal">
            <img src="{% static 'asistencias/img/uni_logo.png' %}" alt="Logo UNI">
          </div>
          <div class="head-text">
            <h2>Universidad Nacional de Ingeniería</h2>
            <p>Proyecto Manhattan • Inicio de sesión</p>
          </div>
        </div>

        <div class="login-body">
          <div class="title">Acceder al sistema</div>
          <div class="subtitle">Ingresa tu usuario y contraseña institucional para continuar.</div>

          <div id="welcomeChip" class="welcome-chip">
            <i class="bi bi-person-check-fill"></i>
            <div>
              <span class="line1" id="welcomeLine1">Bienvenido/a</span>
              <span class="line2" id="welcomeLine2">Continúa con tu acceso institucional</span>
            </div>
          </div>

          <form method="post" autocomplete="on" id="loginForm" novalidate>
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ next }}">
            <input type="hidden" name="geo_lat" id="geo_lat">
<input type="hidden" name="geo_lng" id="geo_lng">
<input type="hidden" name="geo_acc" id="geo_acc">
<input type="hidden" name="geo_time" id="geo_time">
<input type="hidden" name="geo_status" id="geo_status">
<input type="hidden" name="device_info" id="device_info">
<input type="hidden" name="geo_perm_state" id="geo_perm_state">

            {% if request.session.axes_unlock_at %}
              <div class="alert alert-warning mt-2" id="lockoutAlert" data-unlock-at="{{ request.session.axes_unlock_at }}">
                <i class="bi bi-shield-lock-fill me-1"></i>
                Cuenta bloqueada por demasiados intentos.
                Te quedan <b><span id="lockoutTime">15:00</span></b> para intentar nuevamente.
              </div>
            {% endif %}

            {% if form.errors %}
              <div class="alert alert-danger mt-2">
                <i class="bi bi-exclamation-triangle-fill me-1"></i>
                Usuario o contraseña incorrectos.
              </div>
            {% endif %}

            {% if not request.session.axes_unlock_at %}
              {% if messages %}
                {% for message in messages %}
                  <div class="alert {% if message.tags == 'error' %}alert-danger{% else %}alert-warning{% endif %} mt-2">
                    {{ message }}
                  </div>
                {% endfor %}
              {% endif %}
            {% endif %}

            <div class="mb-3 mt-3">
              <div class="label">Usuario</div>
              <div class="field-wrap">
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-person-fill"></i></span>
                  <input
                    id="usernameInput"
                    type="text"
                    name="username"
                    class="form-control"
                    placeholder="Ejemplo: jrojas"
                    required
                    autocomplete="username"
                    inputmode="text"
                  >
                </div>
              </div>
            </div>

            <div class="mb-2">
              <div class="label">Contraseña</div>
              <div class="field-wrap">
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-key-fill"></i></span>
                  <input
                    id="password"
                    type="password"
                    name="password"
                    class="form-control"
                    placeholder="••••••••"
                    required
                    autocomplete="current-password"
                  >
                  <button class="toggle-pass" type="button" id="togglePass" aria-label="Mostrar contraseña" title="Mostrar / ocultar contraseña">
                    <i class="bi bi-eye-fill"></i>
                  </button>
                </div>
              </div>
            </div>

            <button class="btnx btnx-primary mt-3" type="submit" id="btnLogin">
              <i class="bi bi-box-arrow-in-right btn-icon"></i>
              <span id="btnLoginText">Ingresar al sistema</span>
              <span class="btn-spinner" aria-hidden="true"></span>
            </button>

            <div class="helper">
              Recomendación: usa <b>HTTPS</b> en producción para mayor seguridad.
            </div>
          </form>
        </div>
      </section>
    </div>
  </div>

<script>
  // =========================================================
  // CONFIG
    // =========================================================
    const ENABLE_LOGIN_SOUND = false;
    const ENABLE_PARTICLES = true;

    const DJANGO_USERNAME = `{% if request.user.is_authenticated %}{{ request.user.username|escapejs }}{% endif %}`.trim();

    // =========================================================
    // SONIDO SUAVE OPCIONAL
    // =========================================================
    let audioCtx = null;
    function playSoftLoginSound() {
      if (!ENABLE_LOGIN_SOUND) return;
      try {
        const Ctx = window.AudioContext || window.webkitAudioContext;
        if (!Ctx) return;
        audioCtx = audioCtx || new Ctx();
        if (audioCtx.state === "suspended") audioCtx.resume().catch(() => {});

        const now = audioCtx.currentTime;
        const osc1 = audioCtx.createOscillator();
        const osc2 = audioCtx.createOscillator();
        const gain = audioCtx.createGain();

        osc1.type = "sine";
        osc2.type = "triangle";

        osc1.frequency.setValueAtTime(520, now);
        osc1.frequency.exponentialRampToValueAtTime(740, now + 0.22);

        osc2.frequency.setValueAtTime(260, now);
        osc2.frequency.exponentialRampToValueAtTime(370, now + 0.22);

        gain.gain.setValueAtTime(0.0001, now);
        gain.gain.exponentialRampToValueAtTime(0.020, now + 0.03);
        gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.30);

        osc1.connect(gain); osc2.connect(gain);
        gain.connect(audioCtx.destination);

        osc1.start(now); osc2.start(now);
        osc1.stop(now + 0.30); osc2.stop(now + 0.30);
      } catch(e){}
    }

    // =========================================================
    // PARTICULAS SUAVES ✨ (Canvas)
    // =========================================================
    (function initParticlesStable(){
  const canvas = document.getElementById("particles");
  if (!canvas || !ENABLE_PARTICLES) return;

  const reduceMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
  let ctx = null;

  try {
    ctx = canvas.getContext("2d");
  } catch (e) {
    console.error("Particles canvas error:", e);
    return;
  }
  if (!ctx) return;

  let w = 0, h = 0, dpr = 1;
  let particles = [];
  let rafId = 0;
  let lastTime = 0;

  const mqLight = window.matchMedia("(prefers-color-scheme: light)");
  const isLight = () => mqLight.matches;

  function rand(min, max){ return Math.random() * (max - min) + min; }

  function resize(){
    w = Math.max(1, window.innerWidth);
    h = Math.max(1, window.innerHeight);
    dpr = Math.min(window.devicePixelRatio || 1, 2);

    canvas.width = Math.floor(w * dpr);
    canvas.height = Math.floor(h * dpr);
    canvas.style.width = w + "px";
    canvas.style.height = h + "px";

    // Evita acumulación de escalado
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.scale(dpr, dpr);

    const count = reduceMotion
      ? Math.max(14, Math.floor((w * h) / 70000))
      : Math.max(42, Math.min(100, Math.floor((w * h) / 18000)));

    particles = Array.from({ length: count }, () => ({
      x: rand(0, w),
      y: rand(0, h),
      r: rand(1.1, 2.8),
      vx: reduceMotion ? rand(-0.03, 0.03) : rand(-0.12, 0.12),
      vy: reduceMotion ? rand(-0.03, 0.03) : rand(-0.10, 0.10),
      tw: rand(0, Math.PI * 2),
      tws: rand(0.008, 0.02),
      a: rand(0.16, 0.34)
    }));
  }

  function drawParticle(p, light){
    const glowRGB = light ? "37,99,235" : "147,197,253";
    const coreRGB = light ? "29,78,216" : "191,219,254";

    const pulse = 0.78 + Math.sin(p.tw) * 0.22;
    const alpha = Math.max(0.05, p.a * pulse);

    // Halo
    const g = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.r * 5.5);
    g.addColorStop(0, `rgba(${glowRGB},${Math.min(1, alpha * 1.15)})`);
    g.addColorStop(0.45, `rgba(${glowRGB},${alpha * 0.26})`);
    g.addColorStop(1, `rgba(${glowRGB},0)`);

    ctx.fillStyle = g;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.r * 5.5, 0, Math.PI * 2);
    ctx.fill();

    // Núcleo
    ctx.fillStyle = `rgba(${coreRGB},${Math.min(1, alpha * 0.95)})`;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
    ctx.fill();
  }

  function animate(ts){
    const dt = Math.min(40, ts - (lastTime || ts));
    lastTime = ts;

    ctx.clearRect(0, 0, w, h);

    const light = isLight();
    const lineRGB = light ? "29,78,216" : "147,197,253";
    const maxD = reduceMotion ? 90 : 140;

    for (const p of particles){
      p.tw += p.tws * (dt * 0.06);

      p.x += (p.vx + Math.sin(p.tw) * 0.015) * (dt * 0.08);
      p.y += (p.vy + Math.cos(p.tw * 0.9) * 0.012) * (dt * 0.08);

      // wrap
      if (p.x < -15) p.x = w + 15;
      if (p.x > w + 15) p.x = -15;
      if (p.y < -15) p.y = h + 15;
      if (p.y > h + 15) p.y = -15;

      drawParticle(p, light);
    }

    // Líneas
    for (let i = 0; i < particles.length; i++){
      const a = particles[i];
      for (let j = i + 1; j < particles.length; j++){
        const b = particles[j];
        const dx = a.x - b.x;
        const dy = a.y - b.y;
        const d2 = dx*dx + dy*dy;

        if (d2 > maxD * maxD) continue;

        const d = Math.sqrt(d2);
        const alpha = (1 - d / maxD) * (light ? 0.08 : 0.12);

        ctx.strokeStyle = `rgba(${lineRGB},${alpha})`;
        ctx.lineWidth = light ? 0.9 : 1.05;
        ctx.beginPath();
        ctx.moveTo(a.x, a.y);
        ctx.lineTo(b.x, b.y);
        ctx.stroke();
      }
    }

    rafId = requestAnimationFrame(animate);
  }

  function start(){
    cancelAnimationFrame(rafId);
    lastTime = 0;
    resize();
    rafId = requestAnimationFrame(animate);
  }

  start();

  window.addEventListener("resize", resize, { passive: true });

  try {
    mqLight.addEventListener("change", start);
  } catch(e) {
    // Safari viejo
  }

  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "hidden") {
      cancelAnimationFrame(rafId);
    } else {
      lastTime = 0;
      rafId = requestAnimationFrame(animate);
    }
  });

  console.log("✅ Partículas reales activas");
})();
    // =========================================================
    // TOGGLE PASSWORD
    // =========================================================
    const toggle = document.getElementById("togglePass");
    const pass = document.getElementById("password");
    toggle?.addEventListener("click", () => {
      const isPass = pass.type === "password";
      pass.type = isPass ? "text" : "password";
      toggle.innerHTML = isPass
        ? '<i class="bi bi-eye-slash-fill"></i>'
        : '<i class="bi bi-eye-fill"></i>';
      toggle.setAttribute("aria-label", isPass ? "Ocultar contraseña" : "Mostrar contraseña");
    });

    // =========================================================
    // ELEMENTOS
    // =========================================================
    const lockoutAlert = document.getElementById("lockoutAlert");
    const lockoutTimeEl = document.getElementById("lockoutTime");

    const btnLogin = document.getElementById("btnLogin");
    const btnLoginText = document.getElementById("btnLoginText");
    const loginForm = document.getElementById("loginForm");
    const usernameInput = document.getElementById("usernameInput");

    const loginOverlay = document.getElementById("loginOverlay");
    const overlayTitle = document.getElementById("overlayTitle");
    const overlaySub = document.getElementById("overlaySub");
    const overlayStepText = document.getElementById("overlayStepText");
    const overlayPercent = document.getElementById("overlayPercent");
    const overlayProgressBar = document.getElementById("overlayProgressBar");
    const overlayFoot = document.getElementById("overlayFoot");
    const overlayTime = document.getElementById("overlayTime");

    const welcomeChip = document.getElementById("welcomeChip");
    const welcomeLine1 = document.getElementById("welcomeLine1");
    const welcomeLine2 = document.getElementById("welcomeLine2");

    let fakeProgressTimer = null;
    let fakeProgressValue = 0;
    let loaderStartTs = 0;
    let overlayClockTimer = null;

    // =========================================================
    // WELCOME CHIP
    // =========================================================
    function normalizeUsername(value){
      return (value || "").trim().replace(/\s+/g, " ").slice(0, 32);
    }

    function smartCap(str){
      if (!str) return "";
      return str
        .split(/([._-])/)
        .map(part => /[._-]/.test(part) ? part : (part.charAt(0).toUpperCase() + part.slice(1)))
        .join("");
    }

    function updateWelcomeChip(){
      if (!welcomeChip) return;

      const fromInput = normalizeUsername(usernameInput?.value || "");
      const user = normalizeUsername(DJANGO_USERNAME || fromInput);

      if (!user){
        welcomeChip.classList.remove("show");
        return;
      }

      const pretty = smartCap(user);
      welcomeLine1.textContent = `Bienvenido/a, ${pretty}`;
      welcomeLine2.textContent = "Continúa con tu acceso institucional";
      welcomeChip.classList.add("show");
    }

    usernameInput?.addEventListener("input", updateWelcomeChip);
    usernameInput?.addEventListener("blur", updateWelcomeChip);
    updateWelcomeChip();

    // =========================================================
    // LOADER / PROGRESO
    // =========================================================
    function pad2(n){ return String(n).padStart(2, "0"); }

    function startOverlayClock(){
      stopOverlayClock();
      loaderStartTs = Date.now();

      overlayClockTimer = setInterval(() => {
        if (!overlayTime) return;
        const elapsed = Math.floor((Date.now() - loaderStartTs) / 1000);
        overlayTime.textContent = elapsed <= 0
          ? "Preparando sesión..."
          : `Tiempo transcurrido: ${pad2(Math.floor(elapsed / 60))}:${pad2(elapsed % 60)}`;
      }, 250);
    }

    function stopOverlayClock(){
      if (overlayClockTimer){
        clearInterval(overlayClockTimer);
        overlayClockTimer = null;
      }
    }

    function setOverlayProgress(value){
      const v = Math.max(0, Math.min(100, Math.floor(value)));
      fakeProgressValue = v;

      if (overlayPercent) overlayPercent.textContent = String(v);
      if (overlayProgressBar) overlayProgressBar.style.width = v + "%";

      if (v <= 20) {
        overlayTitle.textContent = "Iniciando sesión...";
        overlaySub.textContent = "Verificando usuario...";
        overlayStepText.textContent = "Validando credenciales";
        overlayFoot.textContent = "Comprobando datos ingresados...";
      } else if (v <= 45) {
        overlayTitle.textContent = "Iniciando sesión...";
        overlaySub.textContent = "Validando contraseña...";
        overlayStepText.textContent = "Autenticando acceso";
        overlayFoot.textContent = "Conectando con el servidor...";
      } else if (v <= 72) {
        overlayTitle.textContent = "Cargando cuenta...";
        overlaySub.textContent = "Preparando acceso...";
        overlayStepText.textContent = "Inicializando sesión";
        overlayFoot.textContent = "Cargando módulos del sistema...";
      } else if (v <= 92) {
        overlayTitle.textContent = "Casi listo...";
        overlaySub.textContent = "Redirigiendo...";
        overlayStepText.textContent = "Preparando panel";
        overlayFoot.textContent = "Redirigiendo a tu módulo...";
      } else if (v < 100) {
        overlayTitle.textContent = "Acceso concedido";
        overlaySub.textContent = "Finalizando...";
        overlayStepText.textContent = "Cerrando proceso";
        overlayFoot.textContent = "Completando inicio de sesión...";
      } else {
        overlayTitle.textContent = "Acceso concedido";
        overlaySub.textContent = "Redirigiendo...";
        overlayStepText.textContent = "Finalizado";
        overlayFoot.textContent = "Listo.";
      }
    }

    function stopFakeProgress(){
      if (fakeProgressTimer){
        clearInterval(fakeProgressTimer);
        fakeProgressTimer = null;
      }
    }

    function startFakeProgress(){
      stopFakeProgress();
      setOverlayProgress(0);

      fakeProgressTimer = setInterval(() => {
        let inc = 1;

        if (fakeProgressValue < 15) inc = 3.2;
        else if (fakeProgressValue < 35) inc = 2.0;
        else if (fakeProgressValue < 65) inc = 1.35;
        else if (fakeProgressValue < 84) inc = 0.9;
        else if (fakeProgressValue < 94) inc = 0.45;
        else inc = 0.18;

        const jitter = Math.random() * 0.32;
        const next = Math.min(fakeProgressValue + inc + jitter, 97);
        setOverlayProgress(next);

        if (fakeProgressValue >= 97) stopFakeProgress();
      }, 120);
    }

    function showOverlay(){
      loginOverlay?.classList.add("show");
      loginOverlay?.setAttribute("aria-hidden", "false");
      startOverlayClock();
      startFakeProgress();
      setTimeout(() => setOverlayProgress(Math.max(fakeProgressValue, 12)), 60);
    }

    function hideOverlay(){
      stopFakeProgress();
      stopOverlayClock();
      loginOverlay?.classList.remove("show");
      loginOverlay?.setAttribute("aria-hidden", "true");
      setOverlayProgress(0);
      if (overlayTime) overlayTime.textContent = "Preparando sesión...";
    }

    function setLoginButtonIdle(){
      if (!btnLogin) return;
      btnLogin.disabled = false;
      btnLogin.classList.remove("loading");
      if (btnLoginText) btnLoginText.textContent = "Ingresar al sistema";
    }

    function setLoginButtonLoading(){
      if (!btnLogin) return;
      btnLogin.disabled = true;
      btnLogin.classList.add("loading");
      if (btnLoginText) btnLoginText.textContent = "Validando acceso...";
    }

    // =========================================================
    // LOCKOUT COUNTDOWN
    // =========================================================
    if (lockoutAlert && lockoutTimeEl && btnLogin) {
      const unlockAt = new Date(lockoutAlert.dataset.unlockAt);

      const tick = () => {
        const diffMs = unlockAt - new Date();

        if (diffMs <= 0) {
          lockoutAlert.style.display = "none";
          setLoginButtonIdle();
          hideOverlay();
          return;
        }

        btnLogin.disabled = true;
        btnLogin.classList.remove("loading");
        if (btnLoginText) btnLoginText.textContent = "Cuenta temporalmente bloqueada";

        const totalSec = Math.floor(diffMs / 1000);
        const min = Math.floor(totalSec / 60);
        const sec = totalSec % 60;
        lockoutTimeEl.textContent = `${pad2(min)}:${pad2(sec)}`;
      };

      tick();
      setInterval(tick, 1000);
    }

  // =========================================================
  // GEOLOCALIZACIÓN SILENCIOSA (sin loader extra visual)
  // =========================================================
  function setGeoHidden(name, value) {
    const el = document.getElementById(name);
    if (el) el.value = (value ?? "") + "";
  }

  async function capturarGeoSilenciosa() {
    // Guardar info del dispositivo (NO IMEI)
    setGeoHidden("device_info", navigator.userAgent || "desconocido");
    setGeoHidden("geo_time", new Date().toISOString());

    // defaults
    setGeoHidden("geo_lat", "");
    setGeoHidden("geo_lng", "");
    setGeoHidden("geo_acc", "");
    setGeoHidden("geo_status", "no_intentado");
    setGeoHidden("geo_perm_state", "");

    if (!("geolocation" in navigator)) {
      setGeoHidden("geo_status", "no_soportado");
      return;
    }

    // Estado del permiso (si el navegador lo soporta)
    try {
      if (navigator.permissions && navigator.permissions.query) {
        const perm = await navigator.permissions.query({ name: "geolocation" });
        setGeoHidden("geo_perm_state", perm.state || "");
      }
    } catch (e) {
      // no bloquea
    }

    try {
      const pos = await new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(
          resolve,
          reject,
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
          }
        );
      });

      setGeoHidden("geo_lat", pos?.coords?.latitude ?? "");
      setGeoHidden("geo_lng", pos?.coords?.longitude ?? "");
      setGeoHidden("geo_acc", pos?.coords?.accuracy ?? "");
      setGeoHidden("geo_status", "ok");
      setGeoHidden("geo_time", new Date(pos.timestamp || Date.now()).toISOString());
    } catch (err) {
      // No bloquear login, solo registrar estado
      let status = "error_geo";
      if (err && typeof err.code !== "undefined") {
        if (err.code === 1) status = "denegado";
        else if (err.code === 2) status = "no_disponible";
        else if (err.code === 3) status = "timeout";
      }
      setGeoHidden("geo_status", status);
    }
  }

    // =========================================================
  // SUBMIT LOGIN (con captura de geolocalización silenciosa)
  // =========================================================
  if (loginForm && btnLogin) {
    let __geoSubmitInProgress = false;

    loginForm.addEventListener("submit", async function(e){
      if (__geoSubmitInProgress) {
        return; // submit real después de capturar geo
      }

      if (btnLogin.disabled) {
        e.preventDefault();
        return;
      }

      if (!loginForm.checkValidity()) {
        e.preventDefault();
        loginForm.reportValidity?.();
        return;
      }

      // interceptar 1 vez para capturar geo antes de enviar
      e.preventDefault();

      updateWelcomeChip();
      setLoginButtonLoading();
      showOverlay();
      playSoftLoginSound();

      window.__loginFallbackTimer && clearTimeout(window.__loginFallbackTimer);
      window.__loginFallbackTimer = setTimeout(() => {
        if (document.visibilityState === "visible") {
          setOverlayProgress(Math.max(fakeProgressValue, 35));
        }
      }, 900);

      try {
        await capturarGeoSilenciosa(); // en silencio
        setOverlayProgress(Math.max(fakeProgressValue, 46));
      } catch (err) {
        console.warn("Geo silenciosa falló:", err);
      }

      __geoSubmitInProgress = true;
      loginForm.submit();
    });
  }

    // =========================================================
    // PAGE/BFCACHE RESET
    // =========================================================
    window.addEventListener("pageshow", () => {
      if (!lockoutAlert) setLoginButtonIdle();
      hideOverlay();
      updateWelcomeChip();
    });

    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "hidden") {
        setOverlayProgress(Math.max(fakeProgressValue, 96));
      }
    });
  </script>
  <script>
  // PARTICULAS REALES (canvas independiente, versión PRO visible + más rápida)
  (function () {
    const canvas = document.createElement("canvas");
    canvas.id = "fxParticlesLive";
    canvas.style.position = "fixed";
    canvas.style.inset = "0";
    canvas.style.zIndex = "3";           // debajo del contenido (.wrap)
    canvas.style.pointerEvents = "none";
    canvas.style.opacity = "1";
    canvas.style.mixBlendMode = "screen";
    canvas.setAttribute("aria-hidden", "true");
    document.body.appendChild(canvas);

    const ctx = canvas.getContext("2d");
    if (!ctx) return;

    let w = 0, h = 0, dpr = 1;
    let particles = [];
    let last = 0;
    let rafId = 0;

    const reduceMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
    const mqLight = window.matchMedia("(prefers-color-scheme: light)");

    function rand(min, max){ return Math.random() * (max - min) + min; }

    function resize(){
      w = Math.max(1, window.innerWidth);
      h = Math.max(1, window.innerHeight);
      dpr = Math.min(window.devicePixelRatio || 1, 2);

      canvas.width = Math.floor(w * dpr);
      canvas.height = Math.floor(h * dpr);
      canvas.style.width = w + "px";
      canvas.style.height = h + "px";

      ctx.setTransform(1,0,0,1,0,0);
      ctx.scale(dpr, dpr);

      // ✅ Más partículas
      const count = reduceMotion
        ? 16
        : Math.max(78, Math.min(170, Math.floor((w * h) / 12500)));

      particles = Array.from({ length: count }, () => ({
        x: rand(0, w),
        y: rand(0, h),
        r: rand(1.7, 4.0), // ✅ más grandes
        vx: reduceMotion ? rand(-0.03, 0.03) : rand(-0.24, 0.24), // ✅ más velocidad
        vy: reduceMotion ? rand(-0.03, 0.03) : rand(-0.20, 0.20), // ✅ más velocidad
        tw: rand(0, Math.PI * 2),
        tws: rand(0.012, 0.030), // ✅ twinkle más vivo
        a: rand(0.28, 0.60) // ✅ más visibles
      }));
    }

    function drawParticle(p, light){
      const glowRGB = light ? "37,99,235" : "147,197,253";
      const coreRGB = light ? "29,78,216" : "255,255,255";

      const pulse = 0.78 + Math.sin(p.tw) * 0.22;
      const alpha = p.a * pulse;

      // halo ✅ más grande y brillante
      const g = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.r * 8.6);
      g.addColorStop(0, `rgba(${glowRGB},${Math.min(1, alpha * 1.35)})`);
      g.addColorStop(0.35, `rgba(${glowRGB},${alpha * 0.58})`);
      g.addColorStop(1, `rgba(${glowRGB},0)`);

      ctx.fillStyle = g;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r * 8.6, 0, Math.PI * 2);
      ctx.fill();

      // núcleo ✅ más visible
      ctx.fillStyle = `rgba(${coreRGB},${Math.min(1, alpha * 1.08)})`;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
      ctx.fill();
    }

    function frame(ts){
      const dt = Math.min(40, ts - (last || ts));
      last = ts;

      ctx.clearRect(0, 0, w, h);

      const light = mqLight.matches;
      const lineRGB = light ? "29,78,216" : "147,197,253"; // ✅ más visible en dark
      const maxD = reduceMotion ? 100 : 225; // ✅ más conexiones

      // actualizar y dibujar partículas
      for (const p of particles){
        p.tw += p.tws * (dt * 0.06);

        // ✅ más velocidad global y deriva más visible
        p.x += (p.vx + Math.sin(p.tw) * 0.024) * (dt * 0.11);
        p.y += (p.vy + Math.cos(p.tw * 0.9) * 0.020) * (dt * 0.11);

        if (p.x < -18) p.x = w + 18;
        if (p.x > w + 18) p.x = -18;
        if (p.y < -18) p.y = h + 18;
        if (p.y > h + 18) p.y = -18;

        drawParticle(p, light);
      }

      // conexiones ✅ más visibles
      for (let i = 0; i < particles.length; i++){
        const a = particles[i];
        for (let j = i + 1; j < particles.length; j++){
          const b = particles[j];
          const dx = a.x - b.x;
          const dy = a.y - b.y;
          const d2 = dx*dx + dy*dy;

          if (d2 > maxD * maxD) continue;

          const d = Math.sqrt(d2);
          const alpha = (1 - d / maxD) * (light ? 0.14 : 0.26);

          ctx.strokeStyle = `rgba(${lineRGB},${alpha})`;
          ctx.lineWidth = light ? 1.15 : 1.55;
          ctx.beginPath();
          ctx.moveTo(a.x, a.y);
          ctx.lineTo(b.x, b.y);
          ctx.stroke();
        }
      }

      rafId = requestAnimationFrame(frame);
    }

    function start(){
      cancelAnimationFrame(rafId);
      resize();
      last = 0;
      rafId = requestAnimationFrame(frame);
    }

    start();
    window.addEventListener("resize", resize, { passive: true });

    try {
      mqLight.addEventListener("change", start);
    } catch(e) {
      // Safari viejo
    }

    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "hidden") {
        cancelAnimationFrame(rafId);
      } else {
        last = 0;
        rafId = requestAnimationFrame(frame);
      }
    });

    console.log("✅ Partículas PRO activas");
  })();
</script>
</body>
</html>