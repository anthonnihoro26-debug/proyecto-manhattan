{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Acceso Institucional - Proyecto Manhattan</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <style>
    /* =========================================================
       THEME TOKENS (AUTO DARK/LIGHT)
       ========================================================= */
    :root{
      color-scheme: dark light;

      /* base (dark default) */
      --bg1:#06101f;
      --bg2:#0a1730;
      --bg3:#0a1222;
      --grid: rgba(255,255,255,.07);
      --orb1: rgba(59,130,246,.18);
      --orb2: rgba(99,102,241,.16);
      --orb3: rgba(37,99,235,.12);

      --hero-border: rgba(255,255,255,.12);
      --hero-bg: rgba(255,255,255,.03);
      --hero-panel: rgba(255,255,255,.04);
      --hero-text: rgba(255,255,255,.80);
      --hero-muted: rgba(255,255,255,.72);
      --hero-badge-border: rgba(255,255,255,.14);
      --hero-badge-bg: rgba(255,255,255,.05);

      --panel:#ffffff;
      --panel-soft:#f8fafc;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;

      --primary:#1d4ed8;
      --primary2:#4338ca;
      --primary-soft:#dbeafe;

      --shadow-xl: 0 30px 75px rgba(2,6,23,.34);
      --shadow-lg: 0 18px 44px rgba(2,6,23,.18);
      --shadow-md: 0 10px 28px rgba(15,23,42,.10);

      --radius-xl: 22px;
      --radius-lg: 18px;
      --radius-md: 14px;

      --overlay-bg: rgba(2,6,23,.55);
      --overlay-box: rgba(255,255,255,.98);

      --particle-opacity:.16;
      --noise-opacity:.03;
    }

    /* Modo claro automático */
    @media (prefers-color-scheme: light){
      :root{
        --bg1:#eef4ff;
        --bg2:#e8f0ff;
        --bg3:#edf3ff;
        --grid: rgba(15,23,42,.06);
        --orb1: rgba(59,130,246,.14);
        --orb2: rgba(99,102,241,.12);
        --orb3: rgba(37,99,235,.10);

        --hero-border: rgba(148,163,184,.20);
        --hero-bg: rgba(255,255,255,.65);
        --hero-panel: rgba(255,255,255,.55);
        --hero-text: rgba(15,23,42,.82);
        --hero-muted: rgba(51,65,85,.72);
        --hero-badge-border: rgba(148,163,184,.26);
        --hero-badge-bg: rgba(255,255,255,.70);

        --panel:#ffffff;
        --panel-soft:#f8fafc;
        --ink:#0f172a;
        --muted:#64748b;
        --line:#dbe3ee;

        --shadow-xl: 0 28px 65px rgba(37,99,235,.14);
        --shadow-lg: 0 16px 38px rgba(15,23,42,.10);
        --shadow-md: 0 8px 22px rgba(15,23,42,.08);

        --overlay-bg: rgba(15,23,42,.25);
        --overlay-box: rgba(255,255,255,.98);

        --particle-opacity:.22;
        --noise-opacity:.02;
      }
    }

    *{ box-sizing:border-box; }

    html, body{
      margin:0;
      min-height:100%;
    }

    body{
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      color: #fff;
      background:
        radial-gradient(1000px 620px at 10% 10%, var(--orb1), transparent 60%),
        radial-gradient(900px 560px at 92% 10%, var(--orb2), transparent 60%),
        radial-gradient(780px 480px at 50% 100%, var(--orb3), transparent 62%),
        linear-gradient(180deg, var(--bg1), var(--bg2) 56%, var(--bg3));
      overflow-x:hidden;
      position:relative;
    }

    /* Grid decorativo */
    .grid-bg{
      position:fixed;
      inset:0;
      pointer-events:none;
      opacity:.10;
      background-image:
        linear-gradient(var(--grid) 1px, transparent 1px),
        linear-gradient(90deg, var(--grid) 1px, transparent 1px);
      background-size: 28px 28px;
      mask-image: radial-gradient(circle at center, black 42%, transparent 100%);
      -webkit-mask-image: radial-gradient(circle at center, black 42%, transparent 100%);
      z-index:0;
    }

    /* Noise leve */
    .noise{
      position:fixed; inset:0; pointer-events:none;
      opacity:var(--noise-opacity);
      background-image: radial-gradient(#fff .7px, transparent .7px);
      background-size: 8px 8px;
      z-index:0;
    }

    /* Orbes */
    .orb{
      position:fixed;
      border-radius:50%;
      filter: blur(28px);
      pointer-events:none;
      z-index:0;
      animation: floatOrb 11s ease-in-out infinite;
    }
    .orb-1{ width:230px;height:230px; left:-60px; top:110px; background:#3b82f6; opacity:.15; }
    .orb-2{ width:260px;height:260px; right:-80px; top:70px; background:#6366f1; opacity:.14; animation-delay:-2.6s; }
    .orb-3{ width:180px;height:180px; right:18%; bottom:10%; background:#2563eb; opacity:.12; animation-delay:-4.4s; }

    @keyframes floatOrb{
      0%,100%{ transform: translateY(0) translateX(0) scale(1); }
      50%{ transform: translateY(-12px) translateX(9px) scale(1.04); }
    }

    /* =========================================================
       PARTICULAS SUAVES ✨
       ========================================================= */
    #particles{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:0;
      opacity:1;
    }

    .wrap{
      min-height:100vh;
      display:grid;
      place-items:center;
      padding:18px;
      position:relative;
      z-index:1;
    }

    .layout{
      width:min(1120px, 97vw);
      display:grid;
      grid-template-columns: 1.08fr .92fr;
      gap:16px;
      align-items:stretch;
    }

    /* =========================================================
       HERO
       ========================================================= */
    .hero{
      border-radius: var(--radius-xl);
      border:1px solid var(--hero-border);
      background:
        linear-gradient(180deg, var(--hero-bg), rgba(255,255,255,.01)),
        radial-gradient(720px 420px at 18% 10%, rgba(59,130,246,.14), transparent 65%);
      box-shadow: var(--shadow-xl);
      padding: 24px;
      position:relative;
      overflow:hidden;

      opacity:0;
      transform: translateY(12px);
      animation: fadeUp .58s ease .04s forwards;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }

    .hero::before{
      content:"";
      position:absolute;
      width:260px; height:260px; border-radius:50%;
      right:-70px; bottom:-70px;
      background: radial-gradient(circle, rgba(99,102,241,.16), transparent 70%);
      filter: blur(6px);
      pointer-events:none;
    }

    .badge-uni{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 12px;
      border-radius:999px;
      border:1px solid var(--hero-badge-border);
      background: var(--hero-badge-bg);
      color: var(--hero-text);
      font-weight:900;
      font-size:12px;
      letter-spacing:.15px;
    }

    .badge-uni i{
      color:#93c5fd;
    }

    .hero h1{
      margin:13px 0 0;
      font-size:30px;
      line-height:1.05;
      letter-spacing:-.8px;
      font-weight:950;
      color: #fff;
    }

    @media (prefers-color-scheme: light){
      .hero h1{ color:#0f172a; }
    }

    .hero .accent{
      background: linear-gradient(90deg, #bfdbfe, #c7d2fe, #93c5fd);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }

    .hero p{
      margin:12px 0 0;
      max-width: 56ch;
      color: var(--hero-text);
      font-weight:700;
      line-height:1.48;
      font-size:14px;
    }

    .feature-list{
      margin-top:16px;
      display:grid;
      gap:9px;
    }

    .feature{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:10px;
      border-radius:14px;
      border:1px solid var(--hero-border);
      background: var(--hero-panel);
      transition: transform .15s ease, border-color .15s ease, background .15s ease;
      animation: itemFade .35s ease both;
    }
    .feature:nth-child(1){ animation-delay:.12s; }
    .feature:nth-child(2){ animation-delay:.17s; }
    .feature:nth-child(3){ animation-delay:.22s; }

    .feature:hover{
      transform: translateY(-1px);
      border-color: rgba(191,219,254,.25);
      background: rgba(255,255,255,.05);
    }

    .feature i{
      width:28px;height:28px;border-radius:9px;
      display:grid;place-items:center;
      background: rgba(59,130,246,.15);
      color:#bfdbfe;
      border:1px solid rgba(191,219,254,.16);
      flex:0 0 auto;
      font-size:13px;
    }

    .feature b{
      display:block;
      font-size:13px;
      line-height:1.2;
      color: #fff;
      font-weight:900;
    }

    @media (prefers-color-scheme: light){
      .feature b{ color:#0f172a; }
      .feature i{ color:#2563eb; background:rgba(37,99,235,.08); border-color:rgba(37,99,235,.10); }
      .feature:hover{ background: rgba(255,255,255,.75); }
    }

    .feature span{
      display:block;
      margin-top:2px;
      font-size:12px;
      color: var(--hero-muted);
      font-weight:700;
      line-height:1.25;
    }

    .stats{
      margin-top:15px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:8px;
    }

    .stat{
      border-radius:14px;
      border:1px solid var(--hero-border);
      background: var(--hero-panel);
      padding:10px;
      transition: transform .14s ease, border-color .14s ease;
      animation: itemFade .35s ease both;
    }
    .stat:nth-child(1){ animation-delay:.26s; }
    .stat:nth-child(2){ animation-delay:.30s; }
    .stat:nth-child(3){ animation-delay:.34s; }

    .stat:hover{
      transform: translateY(-1px);
      border-color: rgba(191,219,254,.22);
    }

    .stat .n{
      font-size:17px;
      line-height:1;
      font-weight:950;
      color:#fff;
      letter-spacing:-.3px;
    }
    .stat .t{
      margin-top:4px;
      font-size:11px;
      line-height:1.15;
      color: var(--hero-muted);
      font-weight:800;
    }

    @media (prefers-color-scheme: light){
      .stat .n{ color:#0f172a; }
    }

    /* =========================================================
       LOGIN CARD
       ========================================================= */
    .login-card{
      background: var(--panel);
      color: var(--ink);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      border:1px solid rgba(255,255,255,.22);
      overflow:hidden;
      min-width:0;
      position:relative;

      opacity:0;
      transform: translateY(15px) scale(.99);
      animation: popCard .62s cubic-bezier(.2,.8,.2,1) .08s forwards;
    }

    .login-card::before{
      content:"";
      position:absolute;
      inset:0 0 auto 0;
      height:3px;
      background: linear-gradient(90deg, var(--primary), var(--primary2), var(--primary));
      opacity:.95;
      z-index:2;
    }

    .login-head{
      padding: 15px 16px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, #ffffff, var(--panel-soft));
      display:flex;
      align-items:center;
      gap:12px;
      position:relative;
      z-index:1;
    }

    .seal{
      width:62px;
      height:62px;
      border-radius:16px;
      display:grid;
      place-items:center;
      background:#fff;
      border:1px solid #e5e7eb;
      box-shadow: 0 10px 22px rgba(15,23,42,.08);
      flex:0 0 auto;
      padding:6px;
      overflow:hidden;
      position:relative;
    }

    .seal::after{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(135deg, rgba(59,130,246,.03), rgba(99,102,241,.03));
      pointer-events:none;
    }

    .seal img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      position:relative;
      z-index:1;
    }

    .head-text{ min-width:0; }

    .head-text h2{
      margin:0;
      font-size:15px;
      line-height:1.15;
      font-weight:950;
      letter-spacing:-.2px;
      color:#0f172a;
    }

    .head-text p{
      margin:4px 0 0;
      color:var(--muted);
      font-size:12px;
      line-height:1.2;
      font-weight:700;
    }

    .login-body{
      padding: 16px;
      position:relative;
      z-index:1;
    }

    .title{
      margin:1px 0 2px;
      font-size:19px;
      line-height:1.12;
      letter-spacing:-.4px;
      color:#0f172a;
      font-weight:950;
    }

    .subtitle{
      margin:0 0 12px;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
      font-weight:700;
    }

    /* Mensaje bienvenida */
    .welcome-chip{
      display:none;
      margin: 2px 0 10px;
      padding: 8px 10px;
      border-radius: 12px;
      border:1px solid #dbeafe;
      background: linear-gradient(180deg, #eff6ff, #f8fbff);
      color:#1e3a8a;
      font-size:12px;
      font-weight:800;
      align-items:center;
      gap:8px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.7);
    }
    .welcome-chip.show{ display:flex; }

    .welcome-chip i{
      width:22px; height:22px; border-radius:8px;
      display:grid; place-items:center;
      background:#dbeafe;
      color:#1d4ed8;
      flex:0 0 auto;
      font-size:12px;
    }

    .welcome-chip .line1{
      display:block;
      line-height:1.15;
      font-weight:900;
    }

    .welcome-chip .line2{
      display:block;
      margin-top:2px;
      line-height:1.2;
      font-weight:700;
      color:#475569;
      font-size:11px;
    }

    .label{
      font-size:13px;
      font-weight:900;
      color:#334155;
      margin-bottom:6px;
    }

    .field-wrap{
      border-radius:14px;
      transition: box-shadow .15s ease;
    }

    .field-wrap:focus-within{
      box-shadow: 0 0 0 .25rem rgba(59,130,246,.10);
    }

    .field-wrap:focus-within .input-group-text,
    .field-wrap:focus-within .form-control,
    .field-wrap:focus-within .toggle-pass{
      border-color:#93c5fd !important;
    }

    .input-group{
      border-radius:14px;
      overflow:hidden;
    }

    .input-group-text{
      border-radius:0 !important;
      background:#f8fafc;
      border:1px solid #dbe3ee;
      border-right:0;
      color:#475569;
      min-width:46px;
      display:flex;
      justify-content:center;
      font-size:14px;
    }

    .form-control{
      border-radius:0 !important;
      border:1px solid #dbe3ee;
      background:#fff;
      color:#0f172a;
      font-weight:800;
      padding:12px 12px;
      font-size:14px;
      min-width:0;
      box-shadow:none;
    }

    .form-control::placeholder{
      color:#94a3b8;
      font-weight:700;
    }

    .form-control:focus{
      border-color:#93c5fd;
      box-shadow:none;
      background:#fff;
    }

    .toggle-pass{
      border-radius:0 !important;
      border:1px solid #dbe3ee;
      border-left:0;
      background:#f8fafc;
      color:#475569;
      font-weight:900;
      padding:0 12px;
      min-width:50px;
      transition: background .12s ease, color .12s ease;
    }

    .toggle-pass:hover{
      background:#eff6ff;
      color:#1d4ed8;
    }

    .alert{
      border-radius:14px;
      font-weight:800;
      font-size:13px;
      margin-bottom:10px;
      border-width:1px;
    }
    .alert-warning{
      background:#fffbeb;
      border-color:#fde68a;
      color:#92400e;
    }
    .alert-danger{
      background:#fef2f2;
      border-color:#fecaca;
      color:#991b1b;
    }

    .btnx{
      width:100%;
      border:0;
      border-radius:14px;
      padding:12px 14px;
      font-weight:900;
      font-size:15px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      position:relative;
      overflow:hidden;
      isolation:isolate;
      transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
      user-select:none;
    }

    .btnx-primary{
      color:#fff;
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      box-shadow: 0 14px 28px rgba(37,99,235,.24), inset 0 1px 0 rgba(255,255,255,.12);
    }

    .btnx-primary::before{
      content:"";
      position:absolute;
      inset:-25% -70%;
      background: linear-gradient(110deg,
        transparent 35%,
        rgba(255,255,255,.10) 43%,
        rgba(255,255,255,.34) 50%,
        rgba(255,255,255,.10) 57%,
        transparent 65%);
      transform: translateX(-120%) skewX(-14deg);
      animation: shimmer 2.8s ease-in-out infinite;
      z-index:0;
      pointer-events:none;
    }

    .btnx::after{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(120px 40px at 20% 0%, rgba(255,255,255,.12), transparent 65%);
      z-index:0;
      pointer-events:none;
    }

    .btnx > *{ position:relative; z-index:1; }

    .btnx-primary:hover{
      transform: translateY(-1px);
      box-shadow: 0 18px 34px rgba(37,99,235,.28), inset 0 1px 0 rgba(255,255,255,.14);
    }

    .btnx-primary:active{
      transform: translateY(1px);
    }

    .btnx[disabled]{
      opacity:.7;
      cursor:not-allowed;
      transform:none !important;
      box-shadow:none !important;
    }
    .btnx[disabled]::before{
      animation-play-state: paused;
      opacity:.15;
    }

    .btn-spinner{
      width:17px;height:17px;border-radius:50%;
      border:2px solid rgba(255,255,255,.35);
      border-top-color:#fff;
      display:none;
      animation: spin .75s linear infinite;
    }
    .btnx.loading .btn-spinner{ display:inline-block; }
    .btnx.loading .btn-icon{ display:none; }

    .helper{
      margin-top:10px;
      text-align:center;
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      line-height:1.35;
    }
    .helper b{ color:#334155; }

    /* =========================================================
       OVERLAY LOADER PRO + LOGO UNI ANIMADO
       ========================================================= */
    .login-overlay{
      position:fixed;
      inset:0;
      z-index:9999;
      background: var(--overlay-bg);
      backdrop-filter: blur(8px) saturate(1.05);
      -webkit-backdrop-filter: blur(8px) saturate(1.05);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
    }

    .login-overlay.show{
      display:flex;
      animation: fadeIn .16s ease;
    }

    .overlay-box{
      width:min(440px, 95vw);
      border-radius:18px;
      background: var(--overlay-box);
      color:#0f172a;
      border:1px solid #e5e7eb;
      box-shadow: 0 28px 80px rgba(2,6,23,.36);
      padding:15px;
      position:relative;
      overflow:hidden;
      animation: overlayPop .22s ease;
    }

    .overlay-box::before{
      content:"";
      position:absolute;
      inset:0 0 auto 0;
      height:3px;
      background: linear-gradient(90deg, #2563eb, #4f46e5, #2563eb);
    }

    .overlay-box::after{
      content:"";
      position:absolute;
      top:-40px; right:-35px;
      width:130px; height:130px;
      border-radius:50%;
      background: radial-gradient(circle, rgba(59,130,246,.10), transparent 70%);
      pointer-events:none;
    }

    .overlay-top{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:10px;
    }

    .ov-logo-wrap{
      width:52px; height:52px;
      flex:0 0 auto;
      position:relative;
      display:grid;
      place-items:center;
    }

    /* anillo externo */
    .ov-ring{
      position:absolute;
      inset:0;
      border-radius:50%;
      border:3px solid rgba(59,130,246,.12);
      border-top-color:#2563eb;
      border-right-color:#4f46e5;
      animation: spin .95s linear infinite;
    }

    /* anillo interno */
    .ov-ring2{
      position:absolute;
      inset:6px;
      border-radius:50%;
      border:2px dashed rgba(79,70,229,.22);
      animation: spinReverse 4.2s linear infinite;
    }

    @keyframes spinReverse{
      to{ transform: rotate(-360deg); }
    }

    .ov-logo-core{
      width:34px; height:34px;
      border-radius:12px;
      background: #fff;
      border:1px solid #dbe3ee;
      box-shadow: 0 8px 16px rgba(15,23,42,.08);
      display:grid;
      place-items:center;
      padding:4px;
      position:relative;
      z-index:2;
      animation: logoPulse 1.8s ease-in-out infinite;
    }

    .ov-logo-core img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      animation: logoFloat 1.9s ease-in-out infinite;
      transform-origin:center;
    }

    @keyframes logoPulse{
      0%,100%{ transform: scale(1); box-shadow: 0 8px 16px rgba(15,23,42,.08), 0 0 0 0 rgba(37,99,235,.10); }
      50%{ transform: scale(1.02); box-shadow: 0 10px 20px rgba(15,23,42,.10), 0 0 0 6px rgba(37,99,235,.05); }
    }

    @keyframes logoFloat{
      0%,100%{ transform: translateY(0) scale(1); }
      50%{ transform: translateY(-1px) scale(1.02); }
    }

    .ov-pulse{
      position:absolute;
      inset:-4px;
      border-radius:50%;
      border:2px solid rgba(59,130,246,.14);
      animation: pulse 1.5s ease-out infinite;
    }

    .ov-title{
      margin:0;
      font-size:14px;
      font-weight:950;
      line-height:1.15;
      letter-spacing:-.2px;
    }

    .ov-sub{
      margin:3px 0 0;
      font-size:12px;
      color:#64748b;
      font-weight:700;
      line-height:1.2;
    }

    .ov-meta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      font-size:12px;
      font-weight:800;
      color:#475569;
      margin-bottom:7px;
    }

    .ov-track{
      width:100%;
      height:9px;
      border-radius:999px;
      background:#eef2f7;
      border:1px solid #e2e8f0;
      overflow:hidden;
      position:relative;
    }

    .ov-bar{
      width:0%;
      height:100%;
      border-radius:999px;
      background: linear-gradient(90deg, #2563eb, #4f46e5);
      transition: width .16s ease;
      box-shadow: 0 4px 14px rgba(37,99,235,.25);
      position:relative;
    }

    .ov-bar::after{
      content:"";
      position:absolute;
      top:0; right:-18px;
      width:18px; height:100%;
      background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.55), rgba(255,255,255,0));
    }

    .ov-status-row{
      margin-top:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
    }

    .ov-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:5px 9px;
      border-radius:999px;
      font-size:11px;
      font-weight:800;
      border:1px solid #dbe3ee;
      background:#f8fafc;
      color:#334155;
    }

    .ov-pill i{ color:#2563eb; }

    .ov-time{
      font-size:11px;
      font-weight:800;
      color:#64748b;
    }

    .ov-foot{
      margin-top:8px;
      font-size:11px;
      color:#64748b;
      font-weight:700;
      text-align:center;
    }

    /* =========================================================
       ANIMATIONS
       ========================================================= */
    @keyframes fadeUp{
      to{ opacity:1; transform: translateY(0); }
    }

    @keyframes popCard{
      0%{ opacity:0; transform: translateY(15px) scale(.99); }
      68%{ opacity:1; transform: translateY(-2px) scale(1.002); }
      100%{ opacity:1; transform: translateY(0) scale(1); }
    }

    @keyframes overlayPop{
      from{ opacity:0; transform: translateY(6px) scale(.99); }
      to{ opacity:1; transform:none; }
    }

    @keyframes fadeIn{
      from{ opacity:0; }
      to{ opacity:1; }
    }

    @keyframes pulse{
      0%{ transform:scale(.85); opacity:.55; }
      70%,100%{ transform:scale(1.14); opacity:0; }
    }

    @keyframes shimmer{
      0%,18%{ transform: translateX(-120%) skewX(-14deg); opacity:.45; }
      36%{ transform: translateX(130%) skewX(-14deg); opacity:.95; }
      100%{ transform: translateX(130%) skewX(-14deg); opacity:0; }
    }

    @keyframes spin{
      to{ transform: rotate(360deg); }
    }

    @keyframes itemFade{
      from{ opacity:0; transform: translateY(6px); }
      to{ opacity:1; transform:none; }
    }

    /* =========================================================
       RESPONSIVE
       ========================================================= */
    @media (max-width: 1200px){
      .layout{
        width:min(1020px, 97vw);
        grid-template-columns: 1fr 1fr;
      }
      .hero h1{ font-size:27px; }
    }

    @media (max-width: 991.98px){
      .layout{
        grid-template-columns: 1fr;
        gap:12px;
        width:min(600px, 97vw);
      }

      .hero{ padding:18px; }
      .hero h1{ font-size:23px; }
      .hero p{ font-size:13px; }
      .stats{ grid-template-columns: repeat(3, 1fr); }

      .login-head{ padding:13px 14px; }
      .seal{
        width:54px; height:54px;
        border-radius:13px;
        padding:5px;
      }
      .head-text h2{ font-size:14px; }
      .head-text p{ font-size:11px; }
      .login-body{ padding:14px; }
      .title{ font-size:18px; }
    }

    @media (max-width: 575.98px){
      .wrap{ padding:10px; }
      .layout{ width:100%; gap:10px; }

      .hero{
        padding:14px;
        border-radius:17px;
      }

      .badge-uni{
        font-size:11px;
        padding:6px 10px;
      }

      .hero h1{
        font-size:20px;
        line-height:1.08;
        letter-spacing:-.5px;
      }

      .hero p{
        font-size:12px;
        line-height:1.42;
      }

      .feature{
        padding:8px 9px;
        gap:8px;
        border-radius:12px;
      }

      .feature i{
        width:24px;
        height:24px;
        border-radius:8px;
        font-size:12px;
      }

      .feature b{ font-size:12px; }
      .feature span{ font-size:11px; }

      .stats{
        grid-template-columns:1fr;
        gap:7px;
      }

      .stat{
        border-radius:12px;
        padding:9px;
      }

      .login-card{
        border-radius:17px;
      }

      .login-head{
        padding:12px;
        gap:10px;
      }

      .seal{
        width:48px;
        height:48px;
        border-radius:11px;
        padding:4px;
      }

      .head-text h2{
        font-size:13px;
        line-height:1.1;
      }

      .head-text p{ font-size:11px; }

      .login-body{ padding:12px; }

      .title{ font-size:16px; }
      .subtitle{ font-size:11px; }
      .label{ font-size:12px; }

      .welcome-chip{
        padding:7px 9px;
        border-radius:11px;
        font-size:11px;
      }
      .welcome-chip i{
        width:20px;height:20px;border-radius:7px;font-size:11px;
      }
      .welcome-chip .line2{
        font-size:10px;
      }

      .input-group-text{ min-width:42px; }
      .form-control{
        padding:11px 10px;
        font-size:14px;
      }
      .toggle-pass{
        min-width:46px;
        padding:0 10px;
      }

      .btnx{
        font-size:14px;
        padding:11px 12px;
        border-radius:12px;
      }

      .helper{ font-size:11px; }

      .overlay-box{
        width:95vw;
        padding:12px;
        border-radius:15px;
      }

      .ov-title{ font-size:13px; }
      .ov-sub{ font-size:11px; }
      .ov-meta{ font-size:11px; }
      .ov-foot{ font-size:10px; }

      .ov-logo-wrap{
        width:46px; height:46px;
      }
      .ov-logo-core{
        width:30px; height:30px;
        border-radius:10px;
      }
    }

    /* Accesibilidad: reducir movimiento */
    @media (prefers-reduced-motion: reduce){
      *, *::before, *::after{
        animation-duration:.001ms !important;
        animation-iteration-count:1 !important;
        transition-duration:.001ms !important;
        scroll-behavior:auto !important;
      }
      #particles{ display:none; }
    }
  </style>
</head>
<body>
  <canvas id="particles" aria-hidden="true"></canvas>
  <div class="grid-bg"></div>
  <div class="noise"></div>
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="orb orb-3"></div>

  <!-- Overlay Loader -->
  <div id="loginOverlay" class="login-overlay" aria-hidden="true">
    <div class="overlay-box" role="status" aria-live="polite">
      <div class="overlay-top">
        <div class="ov-logo-wrap">
          <div class="ov-pulse"></div>
          <div class="ov-ring"></div>
          <div class="ov-ring2"></div>
          <div class="ov-logo-core">
            <!-- ✅ logo UNI animado en loader -->
            <img src="{% static 'asistencias/img/uni_logo.png' %}" alt="Logo UNI">
          </div>
        </div>
        <div>
          <p id="overlayTitle" class="ov-title">Iniciando sesión...</p>
          <p id="overlaySub" class="ov-sub">Verificando usuario...</p>
        </div>
      </div>

      <div>
        <div class="ov-meta">
          <span id="overlayStepText">Procesando acceso</span>
          <span><span id="overlayPercent">0</span>%</span>
        </div>
        <div class="ov-track">
          <div id="overlayProgressBar" class="ov-bar"></div>
        </div>
      </div>

      <div class="ov-status-row">
        <span class="ov-pill"><i class="bi bi-shield-lock"></i> Conexión segura</span>
        <span id="overlayTime" class="ov-time">Preparando sesión...</span>
      </div>

      <div id="overlayFoot" class="ov-foot">Por favor espera un momento...</div>
    </div>
  </div>

  <div class="wrap">
    <div class="layout">
      <!-- PANEL HERO -->
      <section class="hero">
        <span class="badge-uni">
          <i class="bi bi-building"></i> Acceso Institucional UNI
        </span>

        <h1>
          Control de Asistencia<br>
          <span class="accent">Proyecto Manhattan</span>
        </h1>

        <p>
          Plataforma institucional para el registro, validación y consulta de asistencias docentes.
          Accede con tus credenciales para continuar de forma segura y rápida.
        </p>

        <div class="feature-list">
          <div class="feature">
            <i class="bi bi-shield-check"></i>
            <div>
              <b>Autenticación segura</b>
              <span>Control de acceso con validación de credenciales institucionales</span>
            </div>
          </div>

          <div class="feature">
            <i class="bi bi-qr-code-scan"></i>
            <div>
              <b>Escaneo QR</b>
              <span>Registro de asistencia ágil desde el módulo de escaneo</span>
            </div>
          </div>

          <div class="feature">
            <i class="bi bi-file-earmark-spreadsheet"></i>
            <div>
              <b>Reportes y exportación</b>
              <span>Historial, filtros y exportación de reportes en Excel</span>
            </div>
          </div>
        </div>

        <div class="stats">
          <div class="stat">
            <div class="n">24/7</div>
            <div class="t">Disponibilidad del sistema</div>
          </div>
          <div class="stat">
            <div class="n">QR</div>
            <div class="t">Registro rápido de asistencia</div>
          </div>
          <div class="stat">
            <div class="n">Excel</div>
            <div class="t">Exportación de reportes</div>
          </div>
        </div>
      </section>

      <!-- LOGIN CARD -->
      <section class="login-card">
        <div class="login-head">
          <div class="seal">
            <img src="{% static 'asistencias/img/uni_logo.png' %}" alt="Logo UNI">
          </div>
          <div class="head-text">
            <h2>Universidad Nacional de Ingeniería</h2>
            <p>Proyecto Manhattan • Inicio de sesión</p>
          </div>
        </div>

        <div class="login-body">
          <div class="title">Acceder al sistema</div>
          <div class="subtitle">Ingresa tu usuario y contraseña institucional para continuar.</div>

          <!-- ✅ Bienvenida dinámica con username cuando exista -->
          <div id="welcomeChip" class="welcome-chip">
            <i class="bi bi-person-check-fill"></i>
            <div>
              <span class="line1" id="welcomeLine1">Bienvenido/a</span>
              <span class="line2" id="welcomeLine2">Continúa con tu acceso institucional</span>
            </div>
          </div>

          <form method="post" autocomplete="on" id="loginForm" novalidate>
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ next }}">

            {% if request.session.axes_unlock_at %}
              <div class="alert alert-warning mt-2" id="lockoutAlert" data-unlock-at="{{ request.session.axes_unlock_at }}">
                <i class="bi bi-shield-lock-fill me-1"></i>
                Cuenta bloqueada por demasiados intentos.
                Te quedan <b><span id="lockoutTime">15:00</span></b> para intentar nuevamente.
              </div>
            {% endif %}

            {% if form.errors %}
              <div class="alert alert-danger mt-2">
                <i class="bi bi-exclamation-triangle-fill me-1"></i>
                Usuario o contraseña incorrectos.
              </div>
            {% endif %}

            {% if not request.session.axes_unlock_at %}
              {% if messages %}
                {% for message in messages %}
                  <div class="alert {% if message.tags == 'error' %}alert-danger{% else %}alert-warning{% endif %} mt-2">
                    {{ message }}
                  </div>
                {% endfor %}
              {% endif %}
            {% endif %}

            <div class="mb-3 mt-3">
              <div class="label">Usuario</div>
              <div class="field-wrap">
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-person-fill"></i></span>
                  <input
                    id="usernameInput"
                    type="text"
                    name="username"
                    class="form-control"
                    placeholder="Ejemplo: jrojas"
                    required
                    autocomplete="username"
                    inputmode="text"
                  >
                </div>
              </div>
            </div>

            <div class="mb-2">
              <div class="label">Contraseña</div>
              <div class="field-wrap">
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-key-fill"></i></span>
                  <input
                    id="password"
                    type="password"
                    name="password"
                    class="form-control"
                    placeholder="••••••••"
                    required
                    autocomplete="current-password"
                  >
                  <button class="toggle-pass" type="button" id="togglePass" aria-label="Mostrar contraseña" title="Mostrar / ocultar contraseña">
                    <i class="bi bi-eye-fill"></i>
                  </button>
                </div>
              </div>
            </div>

            <button class="btnx btnx-primary mt-3" type="submit" id="btnLogin">
              <i class="bi bi-box-arrow-in-right btn-icon"></i>
              <span id="btnLoginText">Ingresar al sistema</span>
              <span class="btn-spinner" aria-hidden="true"></span>
            </button>

            <div class="helper">
              Recomendación: usa <b>HTTPS</b> en producción para mayor seguridad.
            </div>
          </form>
        </div>
      </section>
    </div>
  </div>

  <script>
    // =========================================================
    // CONFIG
    // =========================================================
    const ENABLE_LOGIN_SOUND = false; // true para activar sonido suave
    const ENABLE_PARTICLES = true;    // partículas suaves de fondo

    // Si ya hay username del servidor (cuando aplique), úsalo.
    // Si no existe request.user.username (anon), queda vacío.
    const DJANGO_USERNAME = `{% if request.user.is_authenticated %}{{ request.user.username|escapejs }}{% endif %}`.trim();

    // =========================================================
    // SONIDO SUAVE OPCIONAL
    // =========================================================
    let audioCtx = null;
    function playSoftLoginSound() {
      if (!ENABLE_LOGIN_SOUND) return;
      try {
        const Ctx = window.AudioContext || window.webkitAudioContext;
        if (!Ctx) return;
        audioCtx = audioCtx || new Ctx();
        if (audioCtx.state === "suspended") audioCtx.resume().catch(() => {});

        const now = audioCtx.currentTime;

        const osc1 = audioCtx.createOscillator();
        const osc2 = audioCtx.createOscillator();
        const gain = audioCtx.createGain();

        osc1.type = "sine";
        osc2.type = "triangle";

        osc1.frequency.setValueAtTime(520, now);
        osc1.frequency.exponentialRampToValueAtTime(740, now + 0.22);

        osc2.frequency.setValueAtTime(260, now);
        osc2.frequency.exponentialRampToValueAtTime(370, now + 0.22);

        gain.gain.setValueAtTime(0.0001, now);
        gain.gain.exponentialRampToValueAtTime(0.020, now + 0.03);
        gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.30);

        osc1.connect(gain); osc2.connect(gain);
        gain.connect(audioCtx.destination);

        osc1.start(now); osc2.start(now);
        osc1.stop(now + 0.30); osc2.stop(now + 0.30);
      } catch(e){}
    }

    // =========================================================
    // PARTICULAS SUAVES ✨ (Canvas)
    // =========================================================
    (function initParticles(){
      const canvas = document.getElementById("particles");
      if (!canvas || !ENABLE_PARTICLES || window.matchMedia("(prefers-reduced-motion: reduce)").matches) return;

      const ctx = canvas.getContext("2d", { alpha: true });
      if (!ctx) return;

      let w = 0, h = 0, dpr = Math.min(window.devicePixelRatio || 1, 2);
      let particles = [];
      let rafId = null;
      let lastTime = 0;

      const prefersLight = window.matchMedia("(prefers-color-scheme: light)");
      const isLight = () => prefersLight.matches;

      function resize(){
        w = window.innerWidth;
        h = window.innerHeight;
        dpr = Math.min(window.devicePixelRatio || 1, 2);

        canvas.width = Math.floor(w * dpr);
        canvas.height = Math.floor(h * dpr);
        canvas.style.width = w + "px";
        canvas.style.height = h + "px";
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

        const count = Math.max(18, Math.min(42, Math.floor((w * h) / 42000)));
        particles = Array.from({ length: count }, createParticle);
      }

      function rand(min, max){ return Math.random() * (max - min) + min; }

      function createParticle(){
        return {
          x: rand(0, w),
          y: rand(0, h),
          r: rand(0.8, 2.4),
          vx: rand(-0.12, 0.12),
          vy: rand(-0.18, -0.03),
          tw: rand(0, Math.PI * 2),
          tws: rand(0.008, 0.02),
          alpha: rand(0.06, 0.22),
        };
      }

      function step(ts){
        const dt = Math.min(32, ts - (lastTime || ts));
        lastTime = ts;

        ctx.clearRect(0, 0, w, h);

        // color base según tema
        const light = isLight();
        const base = light ? "37,99,235" : "191,219,254";

        for (let p of particles){
          p.x += p.vx * (dt * 0.06);
          p.y += p.vy * (dt * 0.06);
          p.tw += p.tws * (dt * 0.06);

          // flotación lateral suave
          p.x += Math.sin(p.tw) * 0.03;

          if (p.y < -10) {
            p.y = h + 10;
            p.x = rand(0, w);
          }
          if (p.x < -10) p.x = w + 10;
          if (p.x > w + 10) p.x = -10;

          const a = p.alpha * (0.75 + Math.sin(p.tw) * 0.25);

          // glow
          const grd = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.r * 5);
          grd.addColorStop(0, `rgba(${base},${a * 0.9})`);
          grd.addColorStop(1, `rgba(${base},0)`);

          ctx.fillStyle = grd;
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.r * 5, 0, Math.PI * 2);
          ctx.fill();

          // núcleo
          ctx.fillStyle = `rgba(${base},${a})`;
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
          ctx.fill();
        }

        // líneas suaves entre partículas cercanas (muy sutil)
        for (let i = 0; i < particles.length; i++){
          const a = particles[i];
          for (let j = i + 1; j < particles.length; j++){
            const b = particles[j];
            const dx = a.x - b.x;
            const dy = a.y - b.y;
            const dist2 = dx*dx + dy*dy;
            const maxD = 110;
            if (dist2 < maxD * maxD){
              const dist = Math.sqrt(dist2);
              const alpha = (1 - dist / maxD) * (light ? 0.04 : 0.06);
              ctx.strokeStyle = light
                ? `rgba(37,99,235,${alpha})`
                : `rgba(191,219,254,${alpha})`;
              ctx.lineWidth = 0.8;
              ctx.beginPath();
              ctx.moveTo(a.x, a.y);
              ctx.lineTo(b.x, b.y);
              ctx.stroke();
            }
          }
        }

        rafId = requestAnimationFrame(step);
      }

      resize();
      rafId = requestAnimationFrame(step);

      window.addEventListener("resize", resize, { passive: true });

      // si cambia tema, no hace falta recrear todo, pero re-renderiza bien
      try {
        prefersLight.addEventListener("change", () => {
          // solo dejar que se redibuje automáticamente
        });
      } catch(e){}
    })();

    // =========================================================
    // TOGGLE PASSWORD
    // =========================================================
    const toggle = document.getElementById("togglePass");
    const pass = document.getElementById("password");
    toggle?.addEventListener("click", () => {
      const isPass = pass.type === "password";
      pass.type = isPass ? "text" : "password";
      toggle.innerHTML = isPass
        ? '<i class="bi bi-eye-slash-fill"></i>'
        : '<i class="bi bi-eye-fill"></i>';
      toggle.setAttribute("aria-label", isPass ? "Ocultar contraseña" : "Mostrar contraseña");
    });

    // =========================================================
    // ELEMENTOS
    // =========================================================
    const lockoutAlert = document.getElementById("lockoutAlert");
    const lockoutTimeEl = document.getElementById("lockoutTime");

    const btnLogin = document.getElementById("btnLogin");
    const btnLoginText = document.getElementById("btnLoginText");
    const loginForm = document.getElementById("loginForm");
    const usernameInput = document.getElementById("usernameInput");

    const loginOverlay = document.getElementById("loginOverlay");
    const overlayTitle = document.getElementById("overlayTitle");
    const overlaySub = document.getElementById("overlaySub");
    const overlayStepText = document.getElementById("overlayStepText");
    const overlayPercent = document.getElementById("overlayPercent");
    const overlayProgressBar = document.getElementById("overlayProgressBar");
    const overlayFoot = document.getElementById("overlayFoot");
    const overlayTime = document.getElementById("overlayTime");

    const welcomeChip = document.getElementById("welcomeChip");
    const welcomeLine1 = document.getElementById("welcomeLine1");
    const welcomeLine2 = document.getElementById("welcomeLine2");

    let fakeProgressTimer = null;
    let fakeProgressValue = 0;
    let loaderStartTs = 0;
    let overlayClockTimer = null;

    // =========================================================
    // WELCOME CHIP (USERNAME DJANGO O INPUT)
    // =========================================================
    function normalizeUsername(value){
      return (value || "")
        .trim()
        .replace(/\s+/g, " ")
        .slice(0, 32);
    }

    function smartCap(str){
      if (!str) return "";
      return str
        .split(/([._-])/)
        .map(part => /[._-]/.test(part) ? part : (part.charAt(0).toUpperCase() + part.slice(1)))
        .join("");
    }

    function updateWelcomeChip(){
      if (!welcomeChip) return;

      const fromInput = normalizeUsername(usernameInput?.value || "");
      const user = normalizeUsername(DJANGO_USERNAME || fromInput);

      if (!user){
        welcomeChip.classList.remove("show");
        return;
      }

      const pretty = smartCap(user);
      welcomeLine1.textContent = `Bienvenido/a, ${pretty}`;
      welcomeLine2.textContent = "Continúa con tu acceso institucional";
      welcomeChip.classList.add("show");
    }

    usernameInput?.addEventListener("input", updateWelcomeChip);
    usernameInput?.addEventListener("blur", updateWelcomeChip);

    // Inicial
    updateWelcomeChip();

    // =========================================================
    // LOADER / PROGRESO
    // =========================================================
    function pad2(n){ return String(n).padStart(2, "0"); }

    function startOverlayClock(){
      stopOverlayClock();
      loaderStartTs = Date.now();

      overlayClockTimer = setInterval(() => {
        if (!overlayTime) return;
        const elapsed = Math.floor((Date.now() - loaderStartTs) / 1000);
        overlayTime.textContent = elapsed <= 0
          ? "Preparando sesión..."
          : `Tiempo transcurrido: ${pad2(Math.floor(elapsed / 60))}:${pad2(elapsed % 60)}`;
      }, 250);
    }

    function stopOverlayClock(){
      if (overlayClockTimer){
        clearInterval(overlayClockTimer);
        overlayClockTimer = null;
      }
    }

    function setOverlayProgress(value){
      const v = Math.max(0, Math.min(100, Math.floor(value)));
      fakeProgressValue = v;

      if (overlayPercent) overlayPercent.textContent = String(v);
      if (overlayProgressBar) overlayProgressBar.style.width = v + "%";

      if (v <= 20) {
        overlayTitle.textContent = "Iniciando sesión...";
        overlaySub.textContent = "Verificando usuario...";
        overlayStepText.textContent = "Validando credenciales";
        overlayFoot.textContent = "Comprobando datos ingresados...";
      } else if (v <= 45) {
        overlayTitle.textContent = "Iniciando sesión...";
        overlaySub.textContent = "Validando contraseña...";
        overlayStepText.textContent = "Autenticando acceso";
        overlayFoot.textContent = "Conectando con el servidor...";
      } else if (v <= 72) {
        overlayTitle.textContent = "Cargando cuenta...";
        overlaySub.textContent = "Preparando acceso...";
        overlayStepText.textContent = "Inicializando sesión";
        overlayFoot.textContent = "Cargando módulos del sistema...";
      } else if (v <= 92) {
        overlayTitle.textContent = "Casi listo...";
        overlaySub.textContent = "Redirigiendo...";
        overlayStepText.textContent = "Preparando panel";
        overlayFoot.textContent = "Redirigiendo a tu módulo...";
      } else if (v < 100) {
        overlayTitle.textContent = "Acceso concedido";
        overlaySub.textContent = "Finalizando...";
        overlayStepText.textContent = "Cerrando proceso";
        overlayFoot.textContent = "Completando inicio de sesión...";
      } else {
        overlayTitle.textContent = "Acceso concedido";
        overlaySub.textContent = "Redirigiendo...";
        overlayStepText.textContent = "Finalizado";
        overlayFoot.textContent = "Listo.";
      }
    }

    function stopFakeProgress(){
      if (fakeProgressTimer){
        clearInterval(fakeProgressTimer);
        fakeProgressTimer = null;
      }
    }

    function startFakeProgress(){
      stopFakeProgress();
      setOverlayProgress(0);

      fakeProgressTimer = setInterval(() => {
        let inc = 1;

        if (fakeProgressValue < 15) inc = 3.2;
        else if (fakeProgressValue < 35) inc = 2.0;
        else if (fakeProgressValue < 65) inc = 1.35;
        else if (fakeProgressValue < 84) inc = 0.9;
        else if (fakeProgressValue < 94) inc = 0.45;
        else inc = 0.18;

        const jitter = Math.random() * 0.32;
        const next = Math.min(fakeProgressValue + inc + jitter, 97);
        setOverlayProgress(next);

        if (fakeProgressValue >= 97) stopFakeProgress();
      }, 120);
    }

    function showOverlay(){
      loginOverlay?.classList.add("show");
      loginOverlay?.setAttribute("aria-hidden", "false");
      startOverlayClock();
      startFakeProgress();
      setTimeout(() => setOverlayProgress(Math.max(fakeProgressValue, 12)), 60);
    }

    function hideOverlay(){
      stopFakeProgress();
      stopOverlayClock();
      loginOverlay?.classList.remove("show");
      loginOverlay?.setAttribute("aria-hidden", "true");
      setOverlayProgress(0);
      if (overlayTime) overlayTime.textContent = "Preparando sesión...";
    }

    function setLoginButtonIdle(){
      if (!btnLogin) return;
      btnLogin.disabled = false;
      btnLogin.classList.remove("loading");
      if (btnLoginText) btnLoginText.textContent = "Ingresar al sistema";
    }

    function setLoginButtonLoading(){
      if (!btnLogin) return;
      btnLogin.disabled = true;
      btnLogin.classList.add("loading");
      if (btnLoginText) btnLoginText.textContent = "Validando acceso...";
    }

    // =========================================================
    // LOCKOUT COUNTDOWN
    // =========================================================
    if (lockoutAlert && lockoutTimeEl && btnLogin) {
      const unlockAt = new Date(lockoutAlert.dataset.unlockAt);

      const tick = () => {
        const diffMs = unlockAt - new Date();

        if (diffMs <= 0) {
          lockoutAlert.style.display = "none";
          setLoginButtonIdle();
          hideOverlay();
          return;
        }

        btnLogin.disabled = true;
        btnLogin.classList.remove("loading");
        if (btnLoginText) btnLoginText.textContent = "Cuenta temporalmente bloqueada";

        const totalSec = Math.floor(diffMs / 1000);
        const min = Math.floor(totalSec / 60);
        const sec = totalSec % 60;
        lockoutTimeEl.textContent = `${pad2(min)}:${pad2(sec)}`;
      };

      tick();
      setInterval(tick, 1000);
    }

    // =========================================================
    // SUBMIT LOGIN
    // =========================================================
    if (loginForm && btnLogin) {
      loginForm.addEventListener("submit", function(e){
        if (btnLogin.disabled) {
          e.preventDefault();
          return;
        }

        if (!loginForm.checkValidity()) {
          loginForm.reportValidity?.();
          return;
        }

        updateWelcomeChip();
        setLoginButtonLoading();
        showOverlay();
        playSoftLoginSound();

        window.__loginFallbackTimer && clearTimeout(window.__loginFallbackTimer);
        window.__loginFallbackTimer = setTimeout(() => {
          if (document.visibilityState === "visible") {
            setOverlayProgress(Math.max(fakeProgressValue, 35));
          }
        }, 900);
      });
    }

    // =========================================================
    // PAGE/BFCACHE RESET
    // =========================================================
    window.addEventListener("pageshow", () => {
      if (!lockoutAlert) setLoginButtonIdle();
      hideOverlay();
      updateWelcomeChip();
    });

    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "hidden") {
        setOverlayProgress(Math.max(fakeProgressValue, 96));
      }
    });
  </script>
</body>
</html>